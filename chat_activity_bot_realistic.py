"""
–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –±–æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å –∂–∏–≤—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏ –º–µ–∂–¥—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
- –°–ø–æ—Ä—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- –†–µ–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã: –ø–æ–≥–æ–¥–∞, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –ø–µ—Ä–µ–µ–∑–¥—ã, –∞–Ω–µ–∫–¥–æ—Ç—ã
- –û—Ç–≤–µ—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
"""

import os
import logging
import aiohttp
import asyncio
import random
from datetime import datetime
from collections import defaultdict
from dotenv import load_dotenv

load_dotenv()

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

API_BASE_URL = os.getenv('VERCEL_API_URL', 'https://anonimka.kz')

# –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞–º–∏
PERSONAS = {
    "bot_alex": {
        "name": "–ê–ª–µ–∫—Å",
        "character": "—Å–ø–æ—Ä—â–∏–∫",
        "style": "–ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π",
        "city": "–ê–ª–º–∞—Ç—ã"
    },
    "bot_maria": {
        "name": "–ú–∞—Ä–∏—è", 
        "character": "–º–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü",
        "style": "–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π",
        "city": "–ê—Å—Ç–∞–Ω–∞"
    },
    "bot_dima": {
        "name": "–î–∏–º–∞",
        "character": "—à—É—Ç–Ω–∏–∫",
        "style": "—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π",
        "city": "–®—ã–º–∫–µ–Ω—Ç"
    },
    "bot_kate": {
        "name": "–ö–∞—Ç—è",
        "character": "–ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π",
        "style": "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π",
        "city": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞"
    },
    "bot_artem": {
        "name": "–ê—Ä—Ç—ë–º",
        "character": "—Ñ–∏–ª–æ—Å–æ—Ñ",
        "style": "—Ä–∞–∑–º—ã—à–ª—è—é—â–∏–π",
        "city": "–ê–∫—Ç–æ–±–µ"
    },
    "bot_timur": {
        "name": "–¢–∏–º—É—Ä",
        "character": "–∫—Ä–∏–Ω–∂",
        "style": "–º–æ–ª–æ–¥–µ–∂–Ω—ã–π",
        "city": "–ê–ª–º–∞—Ç—ã"
    },
    "bot_nika": {
        "name": "Nika",
        "character": "–∫—Ä–∏–Ω–∂",
        "style": "—Ç–∏–∫—Ç–æ–∫–µ—Ä—à–∞",
        "city": "–ê—Å—Ç–∞–Ω–∞"
    }
}

# –¢–µ–º—ã –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏
CONVERSATION_TOPICS = {
    "weather": {
        "starters": [
            "–ü–æ–≥–æ–¥–∞ –∂–µ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è ü•µ",
            "–•–æ–ª–æ–¥–Ω–æ —Å—Ç–∞–ª–æ, –∑–∏–º–∞ –∏–¥–µ—Ç",
            "–î–æ–∂–¥—å –≤–µ—Å—å –¥–µ–Ω—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∞ –Ω—É–ª–µ",
            "–°–æ–ª–Ω—Ü–µ –Ω–∞–∫–æ–Ω–µ—Ü –≤—ã—à–ª–æ! ‚òÄÔ∏è",
            "–°–Ω–µ–≥ –ø–æ—à—ë–ª, –∫—Ä–∞—Å–æ—Ç–∞!",
        ],
        "responses_positive": [
            "–î–∞, –∫–ª–∞—Å—Å–Ω–∞—è –ø–æ–≥–æ–¥–∫–∞! –ì—É–ª—è—Ç—å —Ö–æ—á–µ—Ç—Å—è",
            "–û–±–æ–∂–∞—é —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É! üòç",
            "–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ! –ê —Ç–æ –Ω–∞–¥–æ–µ–ª–æ —É–∂–µ",
            "–°–∞–º–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫",
            "–ö—Ä–∞—Å–æ—Ç–∞! –ù–∞–¥–æ –≤—ã–π—Ç–∏ –ø—Ä–æ–≥—É–ª—è—Ç—å—Å—è",
        ],
        "responses_negative": [
            "–ê–≥–∞, —É–∂–∞—Å –ø—Ä–æ—Å—Ç–æ",
            "–•–æ—á—É –ª–µ—Ç–æ –æ–±—Ä–∞—Ç–Ω–æ üò≠",
            "–¢–µ—Ä–ø–µ—Ç—å –Ω–µ –º–æ–≥—É —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É",
            "–°–∏–¥–∏ –¥–æ–º–∞ –ª—É—á—à–µ –≤ —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É",
            "–î–µ–ø—Ä–µ—Å—Å–Ω—è–∫ –æ—Ç —ç—Ç–æ–π –ø–æ–≥–æ–¥—ã",
        ],
        "responses_neutral": [
            "–ù—É –ø–æ–≥–æ–¥–∞ –∫–∞–∫ –ø–æ–≥–æ–¥–∞",
            "–ù–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–∏–≤—ã–∫–ª–∏ —É–∂–µ",
            "–ê –º–Ω–µ –±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã —á–µ—Å—Ç–Ω–æ",
            "–ë—ã–≤–∞–µ—Ç –∏ —Ö—É–∂–µ",
            "–ü–µ—Ä–µ–∂–∏–≤—ë–º –∫–∞–∫-–Ω–∏–±—É–¥—å",
        ]
    },
    
    "travel": {
        "starters": [
            "–ö—Ç–æ –∫—É–¥–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞–ª –Ω–µ–¥–∞–≤–Ω–æ?",
            "–•–æ—á—É –∫—É–¥–∞-–Ω–∏–±—É–¥—å —Å–≤–∞–ª–∏—Ç—å –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ",
            "–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –º–µ—Å—Ç–∞ –¥–ª—è –ø–æ–µ–∑–¥–∫–∏",
            "–ö—Ç–æ –±—ã–ª –≤ –≥–æ—Ä–∞—Ö? –°—Ç–æ–∏—Ç –µ—Ö–∞—Ç—å?",
            "–ü–ª–∞–Ω–∏—Ä—É—é –≤ –¢—É—Ä—Ü–∏—é, –∫—Ç–æ –±—ã–ª?",
            "–®—ã–º–±—É–ª–∞–∫ –∫—Ç–æ-–Ω–∏–±—É–¥—å –∫–∞—Ç–∞–ª—Å—è?",
        ],
        "responses": [
            "–ë—ã–ª –≤ –ò—Å—Å—ã–∫-–ö—É–ª–µ –ª–µ—Ç–æ–º, –æ–≥–æ–Ω—å! üèñÔ∏è",
            "–ë–æ—Ä–æ–≤–æ–µ –∫–ª–∞—Å—Å–Ω–æ–µ –º–µ—Å—Ç–æ, —Å–æ–≤–µ—Ç—É—é",
            "–í –≥–æ—Ä—ã –µ–∑–∂—É —á–∞—Å—Ç–æ, —Ç–∞–º –∫—Ä–∞—Å–æ—Ç–∞",
            "–ß–∞—Ä—ã–Ω—Å–∫–∏–π –∫–∞–Ω—å–æ–Ω –≤–∏–¥–µ–ª? –í–æ—Ç —ç—Ç–æ –∑—Ä–µ–ª–∏—â–µ!",
            "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≥–æ—Ä–æ–¥",
            "–ë—É—Ä–∞–±–∞–π –∑–∏–º–æ–π –≤–æ–æ–±—â–µ —Å–∫–∞–∑–∫–∞",
            "–í –°—Ç–∞–º–±—É–ª–µ –±—ã–ª, –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å",
            "–ö–æ–ª—å—Å–∞–π –æ–∑–µ—Ä–∞ - must see!",
        ]
    },
    
    "relocation": {
        "starters": [
            "–î—É–º–∞—é –ø–µ—Ä–µ–µ—Ö–∞—Ç—å –≤ –ê–ª–º–∞—Ç—ã, –∫–∞–∫ —Ç–∞–º?",
            "–ö—Ç–æ –∂–∏–≤—ë—Ç –≤ –ê—Å—Ç–∞–Ω–µ? –î–æ—Ä–æ–≥–æ —Ç–∞–º?",
            "–•–æ—á—É –ø–µ—Ä–µ–µ—Ö–∞—Ç—å, –ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ –≥–æ—Ä–æ–¥",
            "–ö—Ç–æ –ø–µ—Ä–µ–µ–∑–∂–∞–ª –Ω–µ–¥–∞–≤–Ω–æ? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º",
            "–°—Ç–æ–∏—Ç –ª–∏ –≤ –ê–ª–º–∞—Ç—ã –ø–µ—Ä–µ–µ–∑–∂–∞—Ç—å –∏–∑ —Ä–µ–≥–∏–æ–Ω–æ–≤?",
        ],
        "responses_positive": [
            "–ê–ª–º–∞—Ç—ã –æ–≥–æ–Ω—å! –ú–Ω–æ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π",
            "–ê—Å—Ç–∞–Ω–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ, —Å—Ç–æ–∏—Ç –ø—Ä–∏–µ—Ö–∞—Ç—å",
            "–ü–µ—Ä–µ–µ—Ö–∞–ª –≥–æ–¥ –Ω–∞–∑–∞–¥, –Ω–µ –∂–∞–ª–µ—é",
            "–õ—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ –∂–∏–∑–Ω–∏ –±—ã–ª–æ",
            "–ì–æ—Ä–æ–¥ –∫–ª–∞—Å—Å–Ω—ã–π, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –±—ã—Å—Ç—Ä–∞—è",
        ],
        "responses_negative": [
            "–î–æ—Ä–æ–≥–æ –æ—á–µ–Ω—å, –ø–æ–¥—É–º–∞–π —Ö–æ—Ä–æ—à–æ",
            "–ü—Ä–æ–±–∫–∏ —É–∂–∞—Å–Ω—ã–µ, –∏–º–µ–π –≤ –≤–∏–¥—É",
            "–ñ–∏–ª—å—ë –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–æ –¥–æ—Ä–æ–≥–æ–µ",
            "–†–∞–±–æ—Ç—É –Ω–∞–π—Ç–∏ –Ω–µ —Ç–∞–∫ –ø—Ä–æ—Å—Ç–æ",
            "–û—Å—Ç–∞–ª—Å—è –±—ã –ª—É—á—à–µ –≥–¥–µ –±—ã–ª",
        ],
        "responses_neutral": [
            "–°–º–æ—Ç—Ä—è —Å –∫–∞–∫–∏–º–∏ —Ü–µ–ª—è–º–∏ –ø–µ—Ä–µ–µ–∑–∂–∞—Ç—å",
            "–í–µ–∑–¥–µ —Å–≤–æ–∏ –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã",
            "–ù–∞–¥–æ –ø—Ä–æ–±–æ–≤–∞—Ç—å, –≤—Å—ë –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ",
            "–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ñ–µ—Ä—ã —Ä–∞–±–æ—Ç—ã",
        ]
    },
    
    "jokes": {
        "starters": [
            "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∞–Ω–µ–∫–¥–æ—Ç, —Å–∫—É—á–Ω–æ üòÑ",
            "–ö—Ç–æ –∑–Ω–∞–µ—Ç —Å–º–µ—à–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏?",
            "–ü–æ–¥–Ω–∏–º–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
            "–î–∞–≤–∞–π—Ç–µ —à—É—Ç–∫–∏ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å",
        ],
        "responses": [
            "–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø—É—Ç–∞—é—Ç –•—ç–ª–ª–æ—É–∏–Ω –∏ –†–æ–∂–¥–µ—Å—Ç–≤–æ? –ü–æ—Ç–æ–º—É —á—Ç–æ Oct 31 == Dec 25 üòÑ",
            "–í—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–≤–∞ –∞–π—Ç–∏—à–Ω–∏–∫–∞. –û–¥–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç: '–£ –º–µ–Ω—è 8 –ø—Ä–æ–±–ª–µ–º'. –î—Ä—É–≥–æ–π: '–ü–æ–Ω—è–ª, 256'",
            "–ñ–∏–∑–Ω—å –∫–∞–∫ –∫–æ—Ä–æ–±–∫–∞ –∫–æ–Ω—Ñ–µ—Ç - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–Ω–∞–µ—à—å —á—Ç–æ –≤–Ω—É—Ç—Ä–∏... –ø–æ–∫–∞ –Ω–µ —Ä–∞–∑–¥–∞–≤–∏—à—å üç´",
            "–ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –¥–æ–≤–µ—Ä—è—Ç—å –ª–µ—Å—Ç–Ω–∏—Ü–∞–º? –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ —á—Ç–æ-—Ç–æ –∑–∞–º—ã—à–ª—è—é—Ç üòè",
            "–î—Ä—É–∑—å—è –∫–∞–∫ —Å–Ω–µ–∂–∏–Ω–∫–∏ - –µ—Å–ª–∏ –ø–æ–ø–∏—Å–∞—Ç—å –Ω–∞ –Ω–∏—Ö, –æ–Ω–∏ –∏—Å—á–µ–∑–∞—é—Ç üòÇ",
            "–ù–∞—á–∞–ª—å–Ω–∏–∫: '–ü–æ—á–µ–º—É –æ–ø–æ–∑–¥–∞–ª?' –Ø: '–†–∞–∑–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã'. –ù–∞—á–∞–ª—å–Ω–∏–∫: '–ö–∞–∫–∏–µ?' –Ø: '–ü–µ—Ä–≤–∞—è - –º–Ω–µ –ø–æ—Ñ–∏–≥'",
        ]
    },
    
    "where_live": {
        "starters": [
            "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç? üåç",
            "–ì–¥–µ –∂–∏–≤—ë—Ç–µ, –Ω–∞—Ä–æ–¥?",
            "–ï—Å—Ç—å –∫—Ç–æ –∏–∑ –ê–ª–º–∞—Ç—ã?",
            "–ê—Å—Ç–∞–Ω–∏–Ω—Ü—ã, –æ—Ç–∑–æ–≤–∏—Ç–µ—Å—å!",
            "–ö—Ç–æ –∏–∑ —Ä–µ–≥–∏–æ–Ω–æ–≤?",
        ],
        "responses": [
            "–ê–ª–º–∞—Ç—ã üèîÔ∏è",
            "–ê—Å—Ç–∞–Ω–∞, —Å—Ç–æ–ª–∏—á–Ω—ã–µ –¥–µ–ª–∞—Ö ‚ú®",
            "–®—ã–º–∫–µ–Ω—Ç üå¥",
            "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Ä–µ–≥–∏–æ–Ω",
            "–ê–∫—Ç–æ–±–µ üåæ",
            "–ü–∞–≤–ª–æ–¥–∞—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç",
            "–ö–æ—Å—Ç–∞–Ω–∞–π —Ç—É—Ç üëã",
            "–¢–∞—Ä–∞–∑ –≤ –∑–¥–∞–Ω–∏–∏",
        ]
    },
    
    "plans": {
        "starters": [
            "–ö–∞–∫–∏–µ –ø–ª–∞–Ω—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ?",
            "–ö—É–¥–∞ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–µ–≥–æ–¥–Ω—è?",
            "–ö—Ç–æ —á–µ–º –∑–∞–Ω—è—Ç –±—É–¥–µ—Ç?",
            "–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –¥–µ–ª–∞—Ç—å?",
        ],
        "responses": [
            "–î—É–º–∞—é –≤ –∫–∏–Ω–æ —Å—Ö–æ–¥–∏—Ç—å",
            "–ù–∞ —à–∞—à–ª—ã–∫–∏ —Å–æ–±–∏—Ä–∞–µ–º—Å—è",
            "–î–æ–º–∞ –ø–æ—Å–∏–∂—É, —É—Å—Ç–∞–ª",
            "–í —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –ø–æ–π–¥—É",
            "–ü–æ–≥—É–ª—è—é –≤ –ø–∞—Ä–∫–µ",
            "–î—Ä—É–∑–µ–π –Ω–∞–≤–µ—â—É",
            "–†–∞–±–æ—Ç–∞—Ç—å –±—É–¥—É üò≠",
            "–û—Ç—Å—ã–ø–∞—Ç—å—Å—è –ø–ª–∞–Ω–∏—Ä—É—é",
            "–í —Å–ø–æ—Ä—Ç–∑–∞–ª —Å—Ö–æ–∂—É",
        ]
    },
    
    "conflict": {
        "starters": [
            "–î–∞ –ª–∞–¥–Ω–æ, –Ω–µ –≤–µ—Ä—é",
            "–ë—Ä–µ–¥ –∫–∞–∫–æ–π-—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å",
            "–ù–µ —Å–æ–≥–ª–∞—à—É—Å—å —Å —Ç–æ–±–æ–π",
            "–§–∏–≥–Ω—é –Ω–∞–ø–∏—Å–∞–ª",
            "–¢—ã –≤–æ–æ–±—â–µ –æ —á—ë–º?",
        ],
        "responses_defend": [
            "–ü–æ—á–µ–º—É –±—Ä–µ–¥? –ù–æ—Ä–º–∞–ª—å–Ω–æ —Å–∫–∞–∑–∞–ª",
            "–ê —á—Ç–æ –Ω–µ —Ç–∞–∫?",
            "–¢–≤–æ—ë –º–Ω–µ–Ω–∏–µ, —è —Å–≤–æ—ë –≤—ã—Å–∫–∞–∑–∞–ª",
            "–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è - –Ω–µ —á–∏—Ç–∞–π",
            "–ö–∞–∂–¥—ã–π –¥—É–º–∞–µ—Ç –ø–æ-—Å–≤–æ–µ–º—É",
        ],
        "responses_support": [
            "–°–æ–≥–ª–∞—Å–µ–Ω, —Å—Ç—Ä–∞–Ω–Ω–æ –∑–≤—É—á–∏—Ç",
            "–î–∞, —Ç–æ–∂–µ –Ω–µ –ø–æ–Ω—è–ª",
            "–ê–≥–∞, —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ",
        ],
        "responses_peace": [
            "–≠–π, —á–µ–≥–æ —Å–ø–æ—Ä–∏—Ç—å —Ç–æ",
            "–£—Å–ø–æ–∫–æ–π—Ç–µ—Å—å –≤—Å–µ",
            "–î–∞–≤–∞–π—Ç–µ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤",
            "–ù—É –∑–∞—á–µ–º —Å—Å–æ—Ä–∏—Ç—å—Å—è",
            "–ú–∏—Ä –¥—Ä—É–∂–±–∞ –∂–≤–∞—á–∫–∞ üòä",
        ]
    }
}

# –ö—Ä—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
USER_RESPONSES = {
    "greeting": {
        "triggers": ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "hi", "hello", "–π–æ—É", "—Ö–∞–π", "–∑–¥–æ—Ä–æ–≤–∞", "—Å–∞–ª–∞–º"],
        "responses": [
            "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞? üëã",
            "–ó–¥–∞—Ä–æ–≤–∞! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            "–ô–æ—É! –î–∞–≤–Ω–æ —Ç—É—Ç?",
            "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –†–∞–¥ –≤–∏–¥–µ—Ç—å üòä",
            "–°–∞–ª–∞–º! –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
            "–•–∞–π! –ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?",
        ]
    },
    "how_are_you": {
        "triggers": ["–∫–∞–∫ –¥–µ–ª–∞", "–∫–∞–∫ —Ç—ã", "–∫–∞–∫ —Å–∞–º", "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–∫–∞–∫ –∂–∏–∑–Ω—å"],
        "responses": [
            "–û—Ç–ª–∏—á–Ω–æ! –°–∞–º –∫–∞–∫?",
            "–ù–æ—Ä–º, –æ–±—â–∞–µ–º—Å—è —Ç—É—Ç. –ê —É —Ç–µ–±—è?",
            "–í—Å—ë —Ö–æ—Ä–æ—à–æ! –ö–∞–∫ —É —Ç–µ–±—è –¥–µ–ª–∞?",
            "–ü–æ–π–¥—ë—Ç! –¢—ã –∫–∞–∫?",
            "–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ê —Ç—ã –∫–∞–∫?",
            "–ù–µ–ø–ª–æ—Ö–æ! –°–∞–º —á—Ç–æ –¥–µ–ª–∞–µ—à—å?",
        ]
    },
    "who_here": {
        "triggers": ["–∫—Ç–æ —Ç—É—Ç", "–µ—Å—Ç—å –∫—Ç–æ", "–∫—Ç–æ –æ–Ω–ª–∞–π–Ω", "–∫—Ç–æ –∂–∏–≤–æ–π", "–Ω–∞—Ä–æ–¥ –≥–¥–µ"],
        "responses": [
            "–ú—ã —Ç—É—Ç! –î–∞–≤–∞–π –æ–±—â–∞—Ç—å—Å—è üëã",
            "–ù–∞—Ä–æ–¥ –µ—Å—Ç—å, –Ω–µ —Å–∫—É—á–∞–π",
            "–Ø –æ–Ω–ª–∞–π–Ω! –û —á—ë–º –ø–æ–±–æ–ª—Ç–∞–µ–º?",
            "–í—Å–µ —Ç—É—Ç, –ø–∏—à–∏ —Å–º–µ–ª–æ",
            "–ö—É—á–∞ –ª—é–¥–µ–π, –∑–∞—Ö–æ–¥–∏ –≤ –±–µ—Å–µ–¥—É",
        ]
    },
    "bored": {
        "triggers": ["—Å–∫—É—á–Ω–æ", "–Ω–µ—á–µ–º –∑–∞–Ω—è—Ç—å—Å—è", "–æ–¥–∏–Ω–æ–∫–æ", "–≥—Ä—É—Å—Ç–Ω–æ"],
        "responses": [
            "–î–∞–≤–∞–π –ø–æ–æ–±—â–∞–µ–º—Å—è! –û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º?",
            "–ù–µ –≥—Ä—É—Å—Ç–∏! –ú—ã —Ç—É—Ç —Ä—è–¥–æ–º ü§ó",
            "–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ!",
            "–î–µ—Ä–∂–∏—Å—å! –í—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ üí™",
            "–ß–µ–º –º–æ–≥—É —Ä–∞–∑–≤–ª–µ—á—å? –ê–Ω–µ–∫–¥–æ—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å? üòÑ",
        ]
    },
    "question": {
        "triggers": ["?"],  # –õ—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º
        "responses": [
            "–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! ü§î",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –¥–∞–π –ø–æ–¥—É–º–∞—é...",
            "–ê —Å–∞–º –∫–∞–∫ –¥—É–º–∞–µ—à—å?",
            "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ",
            "–•–º, –Ω–µ —É–≤–µ—Ä–µ–Ω... –ê —Ç—ã?",
        ]
    },
    "thanks": {
        "triggers": ["—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é", "thanks", "thx", "—Å–µ–Ω–∫—Å"],
        "responses": [
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üòä",
            "–ù–µ –∑–∞ —á—Ç–æ!",
            "–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å! üëç",
            "–û–±—Ä–∞—â–∞–π—Å—è –µ—â—ë!",
            "–†–∞–¥ –ø–æ–º–æ—á—å!",
        ]
    },
    "positive": {
        "triggers": ["–∫—Ä—É—Ç–æ", "–∫–ª–∞—Å—Å", "—Å—É–ø–µ—Ä", "–æ—Ç–ª–∏—á–Ω–æ", "—Ö–æ—Ä–æ—à–æ", "–æ–≥–æ–Ω—å", "–∫–∞–π—Ñ"],
        "responses": [
            "–î–∞, –ø—Ä–∞–≤–¥–∞ –∫—Ä—É—Ç–æ! üî•",
            "–†–∞–¥ –∑–∞ —Ç–µ–±—è!",
            "–°–æ–≥–ª–∞—Å–µ–Ω! üëç",
            "–ê–≥–∞, –∫–ª–∞—Å—Å–Ω–æ! üòä",
            "–¢–æ—á–Ω–æ! –û–≥–æ–Ω—å –ø—Ä–æ—Å—Ç–æ!",
        ]
    },
    "negative": {
        "triggers": ["–ø–ª–æ—Ö–æ", "—É–∂–∞—Å", "—Ñ–∏–≥–Ω—è", "–æ—Ç—Å—Ç–æ–π", "–¥–µ—Ä—å–º–æ", "–ø–µ—á–∞–ª—å"],
        "responses": [
            "–ü–æ–Ω–∏–º–∞—é —Ç–µ–±—è...",
            "–î–µ—Ä–∂–∏—Å—å! –í—Å—ë –Ω–∞–ª–∞–¥–∏—Ç—Å—è üí™",
            "–î–∞, –±—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–µ",
            "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π —Å–∏–ª—å–Ω–æ",
            "–í—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ! –ü–æ–≤–µ—Ä—å",
        ]
    }
}

class RealisticChatBot:
    def __init__(self):
        self.last_bot_message_time = {}
        self.last_checked_message_id = 0
        self.conversation_history = []  # –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        self.active_topic = None
        self.topic_participants = []
        self.last_activity_time = asyncio.get_event_loop().time()
        
    async def get_messages(self, limit=30):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{API_BASE_URL}/api/world-chat?type=world&limit={limit}"
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('messages', [])
                    return []
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
            return []
    
    async def send_message(self, persona_id, message_text):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        try:
            persona = PERSONAS[persona_id]
            # –û–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –æ–Ω –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            full_message = message_text
            if len(full_message) > 50:
                full_message = full_message[:47] + "..."
            
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{API_BASE_URL}/api/world-chat",
                    json={
                        "user_token": persona_id,
                        "nickname": persona['name'],
                        "message": full_message,
                        "type": "world",
                        "is_bot": True
                    }
                ) as response:
                    if response.status == 200:
                        logger.info(f"‚úÖ [{persona['name']}] {message_text}")
                        self.last_bot_message_time[persona_id] = asyncio.get_event_loop().time()
                        return True
                    else:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            return False
    
    def detect_user_message_type(self, message_text):
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        message_lower = message_text.lower()
        
        for msg_type, config in USER_RESPONSES.items():
            for trigger in config['triggers']:
                if trigger in message_lower:
                    return msg_type, config['responses']
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω, –Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–µ - –æ—Ç–≤–µ—á–∞–µ–º –∫–∞–∫ –Ω–∞ –≤–æ–ø—Ä–æ—Å
        if len(message_text) < 100:
            return "question", USER_RESPONSES["question"]["responses"]
        
        return None, None
    
    async def respond_to_user(self, message):
        """–û—Ç–≤–µ—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        message_text = message.get('message', '').replace('@', '').replace('&', '').replace('/', '').strip()
        nickname = message.get('nickname', '–ê–Ω–æ–Ω–∏–º')
        
        msg_type, responses = self.detect_user_message_type(message_text)
        
        if not responses:
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω - —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç
            logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞")
            return
        
        # –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        await asyncio.sleep(random.uniform(2, 5))
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        persona_id = random.choice(list(PERSONAS.keys()))
        response = random.choice(responses)
        
        await self.send_message(persona_id, response)
        logger.info(f"üì® –û—Ç–≤–µ—Ç–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {nickname}")
    
    async def start_conversation(self):
        """–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏"""
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–º—É
        topic_name = random.choice(list(CONVERSATION_TOPICS.keys()))
        topic = CONVERSATION_TOPICS[topic_name]
        
        logger.info(f"üó£Ô∏è –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–ª–æ–≥ –Ω–∞ —Ç–µ–º—É: {topic_name}")
        
        # –í—ã–±–∏—Ä–∞–µ–º 2-4 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
        num_participants = random.randint(2, 4)
        participants = random.sample(list(PERSONAS.keys()), num_participants)
        
        # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å—Ç–∞—Ä—Ç–µ—Ä —Ç–µ–º—ã
        starter_persona = participants[0]
        starter_message = random.choice(topic['starters'])
        await self.send_message(starter_persona, starter_message)
        await asyncio.sleep(random.uniform(3, 7))
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ç–≤–µ—á–∞—é—Ç
        for i in range(1, len(participants)):
            persona_id = participants[i]
            persona = PERSONAS[persona_id]
            
            # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
            if topic_name == "conflict":
                if persona['character'] == "–º–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü":
                    response = random.choice(topic['responses_peace'])
                elif persona['character'] == "—Å–ø–æ—Ä—â–∏–∫":
                    response = random.choice(topic['responses_defend'])
                else:
                    response = random.choice(topic['responses_support'])
            elif topic_name in ["weather", "relocation"]:
                response_type = random.choice(['positive', 'negative', 'neutral'])
                if response_type in topic:
                    response = random.choice(topic[f'responses_{response_type}'])
                else:
                    response = random.choice(topic.get('responses', topic['starters']))
            else:
                response = random.choice(topic.get('responses', topic['starters']))
            
            await self.send_message(persona_id, response)
            await asyncio.sleep(random.uniform(4, 10))
        
        # –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –µ—â—ë –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏
        if random.random() < 0.4 and len(participants) > 2:
            extra_persona = random.choice(participants[1:])
            
            if topic_name == "jokes":
                extra_response = "üòÇüòÇüòÇ"
            elif topic_name == "conflict":
                extra_response = "–õ–∞–¥–Ω–æ, —Å–æ–≥–ª–∞—Å–µ–Ω"
            else:
                extra_response = random.choice([
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!",
                    "–°–æ–≥–ª–∞—Å–µ–Ω",
                    "–•–æ—Ä–æ—à–∞—è –º—ã—Å–ª—å",
                    "–¢–æ—á–Ω–æ!",
                    "–ê —è –≤–æ—Ç –¥—É–º–∞—é..."
                ])
            
            await asyncio.sleep(random.uniform(3, 6))
            await self.send_message(extra_persona, extra_response)
        
        logger.info(f"‚úÖ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω")
    
    async def process_new_messages(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        messages = await self.get_messages(limit=30)
        
        if not messages:
            return
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        new_user_messages = []
        for msg in messages:
            msg_id = msg.get('id', 0)
            is_bot = msg.get('is_bot', False) or msg.get('isBot', False)
            
            if msg_id > self.last_checked_message_id and not is_bot:
                new_user_messages.append(msg)
        
        if messages:
            self.last_checked_message_id = max(msg.get('id', 0) for msg in messages)
        
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        for message in new_user_messages:
            logger.info(f"üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            await self.respond_to_user(message)
            await asyncio.sleep(random.uniform(2, 5))
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        logger.info("ü§ñ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –±–æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {len(PERSONAS)}")
        logger.info(f"üí¨ –¢–µ–º –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤: {len(CONVERSATION_TOPICS)}")
        logger.info("‚îÄ" * 60)
        
        while True:
            try:
                current_time = asyncio.get_event_loop().time()
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await self.process_new_messages()
                
                # –ö–∞–∂–¥—ã–µ 1-3 –º–∏–Ω—É—Ç—ã –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏
                time_since_activity = current_time - self.last_activity_time
                if time_since_activity > random.uniform(60, 180):  # 1-3 –º–∏–Ω—É—Ç—ã
                    await self.start_conversation()
                    self.last_activity_time = current_time
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
                await asyncio.sleep(15)
                
            except KeyboardInterrupt:
                logger.info("‚èπÔ∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                break
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                await asyncio.sleep(10)

async def main():
    bot = RealisticChatBot()
    await bot.run()

if __name__ == '__main__':
    asyncio.run(main())
