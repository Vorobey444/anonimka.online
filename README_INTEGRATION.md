# üéÅ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ + ‚≠ê Stars –ø–ª–∞—Ç–µ–∂–∏ - –ì–û–¢–û–í–û

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ 1. –ò–∑—É—á–∏–ª —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ**:
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `referrals` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π token –∏ numeric ID
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `premium_tokens` –¥–ª—è –≤–µ–±-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ API `/api/referrals`: POST (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è), PUT (–≤—ã–¥–∞—á–∞ –Ω–∞–≥—Ä–∞–¥—ã), GET (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- ‚úÖ Frontend: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, —Ñ—É–Ω–∫—Ü–∏–∏ handleReferralLink() –∏ finalizePendingReferral()
- ‚úÖ –ë–æ—Ç: –æ–±—Ä–∞–±–æ—Ç–∫–∞ ref_ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ /start –∫–æ–º–∞–Ω–¥–µ

**–£—Å–ª–æ–≤–∏–µ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥—ã**: –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—Å–æ–∑–¥–∞—ë—Ç –∞–Ω–∫–µ—Ç—É** (POST /api/ads)

**–ú–µ—Ö–∞–Ω–∏–∑–º –∞–∫—Ü–∏–∏**: 
- –ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞—ë—Ç—Å—è –û–î–ò–ù –†–ê–ó
- –ï—Å–ª–∏ `premium_until != NULL` ‚Üí —Ä–µ—Ñ–µ—Ä–µ—Ä –£–ñ–ï –ø–æ–ª—É—á–∞–ª PRO ‚Üí –Ω–æ–≤—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã –Ω–µ –¥–∞—é—Ç –Ω–∞–≥—Ä–∞–¥—É
- –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –∞–±—É–∑–∞

### ‚úÖ 2. –°–æ–∑–¥–∞–ª –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### API Endpoints (Next.js)

1. **`/api/premium/activate`** (–ù–û–í–´–ô)
   - –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç PRO –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã Stars
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–æ—Ç–æ–º –∏–∑ `successful_payment_callback()`
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–µ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤
   - –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏ –≤ `premium_transactions`

2. **`/api/premium/calculate`** (–ù–û–í–´–ô)
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—É –¥–ª—è slider UI
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 1-12 –º–µ—Å—è—Ü–µ–≤
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: stars, discount, rub/kzt —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç

#### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–ú–∏–≥—Ä–∞—Ü–∏—è 021**: `premium_transactions.sql`
- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫ —á–µ—Ä–µ–∑ Stars
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ü–æ–ª—è: telegram_id, months, amount_stars, transaction_id, status

#### –ë–æ—Ç (bot_neon.py)

**–ö–æ–º–∞–Ω–¥–∞ `/referral`** (–ù–û–í–ê–Ø):
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É `https://t.me/anonimka_kz_bot?startapp=ref_{user.id}`
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: total, rewarded, pending
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π" —Å –∞–≤—Ç–æ—Ç–µ–∫—Å—Ç–æ–º
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–∫—Ü–∏–∏ "–û–î–ò–ù –†–ê–ó"

**–£–∂–µ –±—ã–ª–æ**:
- ‚úÖ `/premium` –∫–æ–º–∞–Ω–¥–∞ —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏
- ‚úÖ `buy_premium_callback()` —Å–æ–∑–¥–∞–Ω–∏–µ Stars invoice
- ‚úÖ `successful_payment_callback()` –≤—ã–∑–æ–≤ API activate

#### Frontend (WebApp)

**–û–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—Å—Ç**:
- –ë—ã–ª–æ: "–∫–æ–≥–¥–∞ –æ–Ω –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è"
- –°—Ç–∞–ª–æ: "–∫–æ–≥–¥–∞ –æ–Ω **—Å–æ–∑–¥–∞—Å—Ç –∞–Ω–∫–µ—Ç—É**"
- –î–æ–±–∞–≤–ª–µ–Ω–æ: "‚ö†Ô∏è –ê–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑"

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Neon Console)

```sql
-- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 021
-- –§–∞–π–ª: migrations/021_premium_transactions.sql

CREATE TABLE IF NOT EXISTS premium_transactions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER,
  telegram_id BIGINT NOT NULL,
  months INTEGER NOT NULL,
  amount_stars INTEGER NOT NULL,
  transaction_id TEXT,
  payment_method TEXT DEFAULT 'stars',
  status TEXT DEFAULT 'completed',
  created_at TIMESTAMP DEFAULT NOW()
);

-- + –∏–Ω–¥–µ–∫—Å—ã (—Å–º. —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏)
```

### 2. Next.js (Vercel)

```bash
cd anonimka-nextjs

# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
git add src/app/api/premium/activate/route.ts
git add src/app/api/premium/calculate/route.ts
git add public/webapp/index.html
git add migrations/021_premium_transactions.sql

git commit -m "Add Stars integration + Referral updates"
git push origin main  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ Vercel
```

### 3. –ë–æ—Ç (VPS)

```bash
ssh root@46.17.40.243
cd /root/anonimka.online

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
git pull origin main

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
ps aux | grep bot_neon.py
kill <PID>
nohup python3 bot_neon.py > bot.log 2>&1 &

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f bot.log
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É `/referral` ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
2. –î—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí —Å–æ–∑–¥–∞—ë—Ç –∞–Ω–∫–µ—Ç—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `is_premium = true`, `premium_until = NOW() + 30 days`
4. –í—Ç–æ—Ä–æ–π –¥—Ä—É–≥ ‚Üí –Ω–∞–≥—Ä–∞–¥–∞ –ù–ï –≤—ã–¥–∞—ë—Ç—Å—è (–∞–∫—Ü–∏—è –æ–¥–∏–Ω —Ä–∞–∑)

### –¢–µ—Å—Ç 2: –ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Stars

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É `/premium`
2. –í—ã–±—Ä–∞—Ç—å "üî• 1 –º–µ—Å—è—Ü - 50 Stars"
3. –û–ø–ª–∞—Ç–∏—Ç—å ‚Üí –ø–æ–ª—É—á–∏—Ç—å "üéâ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ: `SELECT * FROM premium_transactions ORDER BY created_at DESC LIMIT 1;`

### –¢–µ—Å—Ç 3: API endpoints

```bash
# –¢–µ—Å—Ç activate
curl -X POST https://anonimka.kz/api/premium/activate \
  -H "Content-Type: application/json" \
  -d '{"telegram_id": 123, "months": 1, "transaction_id": "test", "amount": 50}'

# –¢–µ—Å—Ç calculate
curl https://anonimka.kz/api/premium/calculate?months=5
# –û–∂–∏–¥–∞–µ—Ç—Å—è: {"months":5,"stars":187,"discount":26}
```

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
1. `REFERRAL_STARS_INTEGRATION.md` - –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã
2. `DEPLOY_STARS_INTEGRATION.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
3. `README_INTEGRATION.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª (–∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ)

### –ö–æ–¥
1. `src/app/api/premium/activate/route.ts` - API –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ PRO
2. `src/app/api/premium/calculate/route.ts` - API —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã
3. `migrations/021_premium_transactions.sql` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
4. `bot_neon.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/referral`
5. `public/webapp/index.html` - –æ–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—Å—Ç

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∞–∫—Ü–∏—è
- ‚úÖ –í—ã–¥–∞—ë—Ç—Å—è –û–î–ò–ù –†–ê–ó (–µ—Å–ª–∏ `premium_until = NULL`)
- ‚úÖ –£—Å–ª–æ–≤–∏–µ: –¥—Ä—É–≥ –¥–æ–ª–∂–µ–Ω **—Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É**, –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
- ‚úÖ –ù–∞–≥—Ä–∞–¥–∞: 30 –¥–Ω–µ–π PRO —Ä–µ—Ñ–µ—Ä—É
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—É–∑–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ `premium_until`

### Stars –ø–ª–∞—Ç–µ–∂–∏
- ‚úÖ –¢–∞—Ä–∏—Ñ—ã: 50/130/215/360 Stars (1/3/6/12 –º–µ—Å)
- ‚úÖ –°–∫–∏–¥–∫–∏: 0%/17%/30%/41%
- ‚úÖ –°—Ç–µ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ: PRO –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫: —Ç–∞–±–ª–∏—Ü–∞ `premium_transactions`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `/api/premium/activate` –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ WebApp –≤—ã–∑—ã–≤–∞–µ—Ç `PUT /api/referrals` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
- ‚úÖ –û–±–∞ –∫–∞–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ (Stars + –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞)

---

## üöÄ –°—Ç–∞—Ç—É—Å

**–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ** ‚úÖ

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏, –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 021 –∫ Neon –±–∞–∑–µ
2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å Next.js (git push)
3. –û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –Ω–∞ VPS (git pull + restart)
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É

**–í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è**: ~15-20 –º–∏–Ω—É—Ç

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

Email: aleksey@vorobey444.ru  
VPS: root@46.17.40.243  
–î–æ–º–µ–Ω: anonimka.kz  

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- `REFERRAL_STARS_INTEGRATION.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- `DEPLOY_STARS_INTEGRATION.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é
- `AFFILIATE_PROGRAM_GUIDE.md` - –≥–∞–π–¥ –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
