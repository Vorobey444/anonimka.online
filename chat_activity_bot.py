"""
–ë–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –º–∏—Ä-—á–∞—Ç–µ
–ò–º–∏—Ç–∏—Ä—É–µ—Ç –æ–±—â–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –æ—Ç–≤–µ—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
"""

import os
import logging
import aiohttp
import asyncio
import random
from datetime import datetime
from dotenv import load_dotenv
from smart_responses import response_generator

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
API_BASE_URL = os.getenv('VERCEL_API_URL', 'https://anonimka.kz')
CHAT_CHECK_INTERVAL = 30  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
MESSAGE_INTERVAL_MIN = 120  # –ú–∏–Ω–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –±–æ—Ç–æ–≤
MESSAGE_INTERVAL_MAX = 600  # –ú–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –±–æ—Ç–æ–≤

# –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ –æ–±—â–µ–Ω–∏—è
VIRTUAL_PERSONAS = [
    {
        "id": "bot_alex",
        "name": "–ê–ª–µ–∫—Å",
        "style": "casual",  # –ù–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å
        "topics": ["–º—É–∑—ã–∫–∞", "—Ñ–∏–ª—å–º—ã", "–∏–≥—Ä—ã", "—Å–ø–æ—Ä—Ç"],
        "messages": [
            "–ö—Ç–æ-–Ω–∏–±—É–¥—å —Å–º–æ—Ç—Ä–µ–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–∑–æ–Ω? üçø",
            "–ï—Å—Ç—å –∫—Ç–æ –∏–∑ –ê–ª–º–∞—Ç—ã?",
            "–í–µ—á–µ—Ä–æ–º –∫—Ç–æ –Ω–∞ —Å–≤—è–∑–∏ –±—É–¥–µ—Ç?",
            "–ü–æ–≥–æ–¥–∞ –ø—Ä–æ—Å—Ç–æ –æ–≥–æ–Ω—å —Å–µ–≥–æ–¥–Ω—è ‚òÄÔ∏è",
            "–ö—Ç–æ —á—Ç–æ —Å–ª—É—à–∞–µ—Ç —Å–µ–π—á–∞—Å?",
            "–ú–æ–∂–µ—Ç –∫—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—Ç —á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?",
            "–°–∫—É—á–Ω–æ –∫–∞–∫-—Ç–æ... –ö—Ç–æ –∂–∏–≤–æ–π? üòÖ",
            "–í—ã—Ö–æ–¥–Ω—ã–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ! –ü–ª–∞–Ω—ã —É –∫–æ–≥–æ?",
        ]
    },
    {
        "id": "bot_maria",
        "name": "–ú–∞—Ä–∏—è",
        "style": "friendly",  # –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å—Ç–∏–ª—å
        "topics": ["–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–∫–∞—Ñ–µ", "–∫–Ω–∏–≥–∏", "—Ö–æ–±–±–∏"],
        "messages": [
            "–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! üëã –ö–∞–∫ –¥–µ–ª–∞?",
            "–ö—Ç–æ-–Ω–∏–±—É–¥—å –±—ã–ª –≤ –Ω–æ–≤–æ–º –∫–∞—Ñ–µ –Ω–∞ –î–æ—Å—Ç—ã–∫?",
            "–î–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ—Ç –≥–æ—Ä–æ–¥–∞!",
            "–ö—Ç–æ –ª—é–±–∏—Ç —á–∏—Ç–∞—Ç—å? –ß—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—Ç–µ?",
            "–ü–æ–≥–æ–¥–∞ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∫–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫ üå∏",
            "–í—Å–µ–º —Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è! ‚òï",
            "–ú–æ–∂–µ—Ç –∫—Ç–æ –∑–Ω–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –≥–æ—Ä–æ–¥–µ?",
            "–ö—Ç–æ –µ—â–µ –æ–Ω–ª–∞–π–Ω? –î–∞–≤–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è üòä",
        ]
    },
    {
        "id": "bot_dima",
        "name": "–î–∏–º–∞",
        "style": "brief",  # –ö—Ä–∞—Ç–∫–∏–π —Å—Ç–∏–ª—å
        "topics": ["—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "–Ω–æ–≤–æ—Å—Ç–∏", "—Ç—Ä–µ–Ω–¥—ã"],
        "messages": [
            "–ü—Ä–∏–≤–µ—Ç",
            "–ö—Ç–æ —Ç—É—Ç?",
            "–ö–∞–∫ –¥–µ–ª–∞?",
            "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            "–°–ª—ã—à–∞–ª –ø—Ä–æ –Ω–æ–≤—ã–π –∞–ø–¥–µ–π—Ç?",
            "–ö—Ç–æ –≤ —Ç–µ–º–µ?",
            "–ü–æ–≥–Ω–∞–ª–∏ –æ–±—â–∞—Ç—å—Å—è",
            "–í–µ—á–µ—Ä! –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
        ]
    },
    {
        "id": "bot_kate",
        "name": "–ö–∞—Ç—è",
        "style": "emoji",  # –ú–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏
        "topics": ["–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–∂–∏–∑–Ω—å", "–æ–±—â–µ–Ω–∏–µ"],
        "messages": [
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚òÄÔ∏èüåª",
            "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É –≤—Å–µ—Ö? üòä",
            "–•–æ—á–µ—Ç—Å—è —á–µ–≥–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ üé≠",
            "–ö—Ç–æ –∑–∞ –ø–æ–∑–∏—Ç–∏–≤? ‚ú®üí´",
            "–î–µ–ª–∏–º—Å—è –ø–ª–∞–Ω–∞–º–∏ –Ω–∞ –≤–µ—á–µ—Ä? üåô",
            "–ü–æ–≥–æ–¥–∞ —Å—É–ø–µ—Ä! üåà",
            "–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç! üëãüòÑ",
            "–ö—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–±–æ–ª—Ç–∞—Ç—å? üí¨",
        ]
    },
    {
        "id": "bot_artem",
        "name": "–ê—Ä—Ç—ë–º",
        "style": "questions",  # –ó–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã
        "topics": ["–º–Ω–µ–Ω–∏—è", "—Å–æ–≤–µ—Ç—ã", "–æ–±—Å—É–∂–¥–µ–Ω–∏—è"],
        "messages": [
            "–ê –≤—ã –∫–∞–∫ –¥—É–º–∞–µ—Ç–µ –ø—Ä–æ —ç—Ç–æ?",
            "–ö—Ç–æ-–Ω–∏–±—É–¥—å –º–æ–∂–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å?",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ ü§î",
            "–ö–∞–∫ –≤–∞–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?",
            "–ö—Ç–æ –¥–∞–≤–Ω–æ —Ç—É—Ç?",
            "–ú–æ–∂–µ—Ç –∫—Ç–æ –∑–Ω–∞–µ—Ç –≥–¥–µ...?",
            "–ê –ø—Ä–∞–≤–¥–∞ —á—Ç–æ...?",
            "–ö—Ç–æ —Å—Ç–∞–ª–∫–∏–≤–∞–ª—Å—è —Å —ç—Ç–∏–º?",
        ]
    }
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)
RESPONSE_TEMPLATES = {
    "–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|hi|hello|–π–æ—É": [
        "–ü—Ä–∏–≤–µ—Ç! üëã",
        "–ó–¥–∞—Ä–æ–≤–∞!",
        "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
        "–ô–æ—É! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
        "–ò —Ç–µ–±–µ –ø—Ä–∏–≤–µ—Ç! üòä",
    ],
    "–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ": [
        "–û—Ç–ª–∏—á–Ω–æ! –ê —É —Ç–µ–±—è?",
        "–ù–æ—Ä–º, –æ–±—â–∞–µ–º—Å—è —Ç—É—Ç üòä",
        "–•–æ—Ä–æ—à–æ! –¢—ã –∫–∞–∫?",
        "–î–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∞ —á—Ç–æ —É —Ç–µ–±—è?",
        "–ü–æ–π–¥—ë—Ç üëå –ö–∞–∫ —Å–∞–º?",
    ],
    "–∫—Ç–æ —Ç—É—Ç|–µ—Å—Ç—å –∫—Ç–æ|–∫—Ç–æ –æ–Ω–ª–∞–π–Ω": [
        "–Ø —Ç—É—Ç! üëã",
        "–ú—ã –≤—Å–µ —Ç—É—Ç üòÑ",
        "–ù–∞—Ä–æ–¥ –µ—Å—Ç—å!",
        "–û–Ω–ª–∞–π–Ω –º–Ω–æ–≥–æ –∫–æ–≥–æ",
        "–ö—É—á–∞ –Ω–∞—Ä–æ–¥—É, –∑–∞—Ö–æ–¥–∏ –æ–±—â–∞—Ç—å—Å—è",
    ],
    "—Å–∫—É—á–Ω–æ|–æ–¥–∏–Ω–æ–∫–æ": [
        "–î–∞–≤–∞–π –æ–±—â–∞—Ç—å—Å—è! –û —á–µ–º –ø–æ–±–æ–ª—Ç–∞–µ–º?",
        "–ú—ã —Ç—É—Ç –≤—Å–µ, –Ω–µ —Å–∫—É—á–∞–π üòä",
        "–î–∞–≤–∞–π —Ç–µ–º—É –∫–∞–∫—É—é-–Ω–∏–±—É–¥—å",
        "–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ!",
        "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –º—ã —Ç—É—Ç —Ä—è–¥–æ–º üí™",
    ],
    "—Å–ø–∞—Å–∏–±–æ|thanks|thx": [
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üòä",
        "–ù–µ –∑–∞ —á—Ç–æ!",
        "–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å",
        "–û–±—Ä–∞—â–∞–π—Å—è! üëç",
    ],
    "–ø–æ–º–æ—â—å|help": [
        "–ß–µ–º –ø–æ–º–æ—á—å?",
        "–ß—Ç–æ –Ω—É–∂–Ω–æ?",
        "–°–ª—É—à–∞—é —Ç–µ–±—è",
        "–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å, –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–º–æ—á—å",
    ],
}

class ChatActivityBot:
    """–ë–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —á–∞—Ç–µ"""
    
    def __init__(self):
        self.last_bot_message_time = 0
        self.last_checked_message_id = 0
        self.active_personas = []
        
    async def get_world_chat_messages(self, limit=50):
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –º–∏—Ä-—á–∞—Ç–∞"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{API_BASE_URL}/api/world-chat?limit={limit}"
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('messages', [])
                    return []
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
            return []
    
    async def send_message(self, persona_id, message_text):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            persona = next((p for p in VIRTUAL_PERSONAS if p["id"] == persona_id), None)
            nickname = persona["name"] if persona else "–ê–Ω–æ–Ω–∏–º"
            
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{API_BASE_URL}/api/world-chat",
                    json={
                        "user_token": persona_id,
                        "nickname": nickname,
                        "message": message_text[:50],  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 50 —Å–∏–º–≤–æ–ª–æ–≤
                        "type": "world",  # –¢–∏–ø: –º–∏—Ä-—á–∞—Ç
                        "is_bot": True  # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞
                    }
                ) as response:
                    if response.status == 200:
                        logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: [{persona_id}] {message_text}")
                        return True
                    else:
                        logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False
    
    def should_respond(self, message_text, user_id):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)"""
        return response_generator.should_respond(message_text, user_id)
    
    def generate_response(self, message_text, persona_style):
        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        return response_generator.generate_contextual_response(
            message_text, 
            persona_style
        )
    
    async def check_and_respond_to_new_messages(self):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"""
        messages = await self.get_world_chat_messages(limit=20)
        
        if not messages:
            return
        
        # –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Å–ª–µ last_checked_message_id)
        new_messages = [
            msg for msg in messages 
            if msg.get('id', 0) > self.last_checked_message_id
            and not msg.get('isBot', False)  # –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        ]
        
        if not new_messages:
            return
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π ID
        self.last_checked_message_id = max(msg.get('id', 0) for msg in messages)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        for message in new_messages:
            message_text = message.get('message', '')
            user_token = message.get('userToken', 'unknown')
            
            logger.info(f"üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_token}: {message_text}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å (—É–º–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º)
            if response_generator.should_respond(message_text, user_token):
                # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ (–∏–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞)
                typing_delay = random.uniform(2, 5)
                await asyncio.sleep(typing_delay)
                
                # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
                persona = random.choice(VIRTUAL_PERSONAS)
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç
                response = response_generator.generate_contextual_response(
                    message_text,
                    persona['style']
                )
                
                if response and len(response) <= 50:  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–∞—à–µ–π –ë–î
                    await self.send_message(persona['id'], response)
                    response_generator.update_conversation_history(user_token)
                    # –î–µ–ª–∞–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
                    await asyncio.sleep(random.uniform(3, 8))
                else:
                    logger.warning(f"‚ö†Ô∏è –û—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
    
    async def send_random_bot_message(self):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ (—É–º–Ω–æ–µ!)"""
        current_time = asyncio.get_event_loop().time()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if current_time - self.last_bot_message_time < MESSAGE_INTERVAL_MIN:
            return
        
        # –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –Ω–µ—Ç
        if random.random() < 0.3:  # 30% —à–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            persona = random.choice(VIRTUAL_PERSONAS)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            message = response_generator.get_random_starter(persona['style'])
            
            # –û–±—Ä–µ–∑–∞–µ–º –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if len(message) > 50:
                message = message[:47] + "..."
            
            if await self.send_message(persona['id'], message):
                self.last_bot_message_time = current_time
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        logger.info("ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {len(VIRTUAL_PERSONAS)}")
        logger.info(f"‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: {CHAT_CHECK_INTERVAL}—Å")
        logger.info(f"üí¨ –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π: {MESSAGE_INTERVAL_MIN}-{MESSAGE_INTERVAL_MAX}—Å")
        logger.info("‚îÄ" * 50)
        
        while True:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—á–∞–µ–º
                await self.check_and_respond_to_new_messages()
                
                # –ò–Ω–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                await self.send_random_bot_message()
                
                # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                await asyncio.sleep(CHAT_CHECK_INTERVAL)
                
            except KeyboardInterrupt:
                logger.info("‚èπÔ∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
                break
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(10)  # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º

async def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"""
    bot = ChatActivityBot()
    await bot.run()

if __name__ == '__main__':
    asyncio.run(main())
