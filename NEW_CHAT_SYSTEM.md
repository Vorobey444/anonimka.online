# 💬 Новая система анонимных чатов с приглашениями

## 🎯 Концепция

### Ключевые принципы:
1. **User A** может отправить **только ОДНО сообщение** на каждое объявление
2. **User B** (автор объявления) получает приглашение и может **принять** или **отклонить**
3. После принятия создается **приватный анонимный чат**
4. Любая сторона может **заблокировать** собеседника в любой момент

---

## 📊 Блок-схема работы

```
┌─────────────────────────────────────────────────────────────────┐
│                ОТПРАВКА ПЕРВОГО СООБЩЕНИЯ                       │
└─────────────────────────────────────────────────────────────────┘

👤 User A                    🤖 BOT                  👤 User B
(ID: 123)                                            (ID: 456)
   │                                                      │
   │  1. Открывает WebApp                                │
   │  ────────────────────>                              │
   │                                                      │
   │  2. Находит объявление User B (#789)                │
   │                                                      │
   │  3. Отправляет сообщение:                           │
   │     "Привет! Интересует ваше предложение"           │
   │  ────────────────────>                              │
   │                         │                            │
   │                         │  4. Проверяет:            │
   │                         │     - Не отправлял ли     │
   │                         │       сообщение ранее?    │
   │                         │     - Не пишет ли себе?   │
   │                         │                            │
   │                         │  5. Сохраняет:            │
   │                         │     sent_messages[123]    │
   │                         │       [789] = True        │
   │                         │                            │
   │                         │  6. Создает invite_id     │
   │                         │                            │
   │  7. "✅ Сообщение        │                            │
   │      отправлено!        │                            │
   │      Ожидайте ответа."  │                            │
   │  <──────────────────── │                            │
   │                         │                            │
   │                         │  8. Отправляет приглашение│
   │                         │     с кнопками:           │
   │                         │     [✅ Принять] [❌ Отклонить]│
   │                         │  ──────────────────────>  │
   │                         │                            │
   │                         │  📩 "Новое сообщение:     │
   │                         │      Привет! Интересует   │
   │                         │      ваше предложение"    │
   │                                                      │


┌─────────────────────────────────────────────────────────────────┐
│                   ПРИНЯТИЕ ПРИГЛАШЕНИЯ                          │
└─────────────────────────────────────────────────────────────────┘

   │                         │                            │
   │                         │  User B нажимает ✅ Принять│
   │                         │  <─────────────────────── │
   │                         │                            │
   │                         │  9. Создает чат:          │
   │                         │     chat_id =             │
   │                         │     "123_456_789"         │
   │                         │                            │
   │                         │  10. Удаляет приглашение  │
   │                         │                            │
   │  11. "✅ Запрос         │                            │
   │       на чат принят!"   │                            │
   │  <──────────────────── │                            │
   │                         │                            │
   │                         │  12. "✅ Чат создан!      │
   │                         │       Можете общаться"    │
   │                         │  ──────────────────────>  │
   │                                                      │


┌─────────────────────────────────────────────────────────────────┐
│                   ОТКЛОНЕНИЕ ПРИГЛАШЕНИЯ                        │
└─────────────────────────────────────────────────────────────────┘

   │                         │  User B нажимает ❌ Отклонить│
   │                         │  <─────────────────────── │
   │                         │                            │
   │                         │  9. Удаляет приглашение   │
   │                         │  10. Удаляет флаг:        │
   │                         │      sent_messages[123]   │
   │                         │        [789] = False      │
   │                         │                            │
   │                         │  11. "❌ Отклонено"       │
   │                         │  ──────────────────────>  │
   │                         │                            │
   │  ⚠️ User A НЕ получает уведомления об отклонении    │
   │     (для анонимности)                                │
   │                                                      │


┌─────────────────────────────────────────────────────────────────┐
│                    ОБМЕН СООБЩЕНИЯМИ                            │
└─────────────────────────────────────────────────────────────────┘

   │                                                      │
   │  "Когда можем встретиться?"                         │
   │  ────────────────────>                              │
   │                         │                            │
   │                         │  Пересылает анонимно:     │
   │                         │  "💬 Анонимное сообщение  │
   │                         │   (объявление #789):      │
   │                         │   Когда можем встретиться?"│
   │                         │  ──────────────────────>  │
   │                         │                            │
   │                         │  "Завтра в 15:00?"        │
   │                         │  <─────────────────────── │
   │                         │                            │
   │  "💬 Анонимное          │                            │
   │   сообщение:            │                            │
   │   Завтра в 15:00?"      │                            │
   │  <──────────────────── │                            │
   │                                                      │


┌─────────────────────────────────────────────────────────────────┐
│                    БЛОКИРОВКА СОБЕСЕДНИКА                       │
└─────────────────────────────────────────────────────────────────┘

   │                                                      │
   │  /block                                              │
   │  ────────────────────>                              │
   │                         │                            │
   │                         │  Помечает чат:            │
   │                         │  blocked_by = 123         │
   │                         │                            │
   │  "🚫 Вы заблокировали  │                            │
   │   чат по объявлению    │                            │
   │   #789"                 │                            │
   │  <──────────────────── │                            │
   │                         │                            │
   │                         │  "🚫 Чат завершен         │
   │                         │   собеседником"           │
   │                         │  ──────────────────────>  │
   │                         │                            │
```

---

## 🗄️ Структура данных

### 1. `sent_messages` - Отслеживание отправленных первых сообщений
```python
sent_messages = {
    123: {              # User A ID
        '789': True,    # ad_id: может отправить только 1 сообщение
        '101': True
    },
    456: {
        '999': True
    }
}
```

### 2. `chat_invites` - Приглашения в чат
```python
chat_invites = {
    'invite_123_456_789_1730462400.123': {
        'sender': 123,                    # User A
        'recipient': 456,                 # User B
        'ad_id': '789',
        'message': 'Привет! Интересует ваше предложение',
        'timestamp': '2025-11-01T10:00:00'
    }
}
```

### 3. `active_chats` - Активные чаты
```python
active_chats = {
    '123_456_789': {
        'user1': 123,
        'user2': 456,
        'ad_id': '789',
        'created_at': '2025-11-01T10:05:00',
        'blocked_by': None              # None или ID пользователя, который заблокировал
    }
}
```

### 4. `user_chats` - Список чатов пользователей
```python
user_chats = {
    123: ['123_456_789', '123_789_101'],  # Чаты User A
    456: ['123_456_789'],                 # Чаты User B
    789: ['123_789_101']                  # Чаты User C
}
```

---

## 🔧 Интеграция с WebApp

### Отправка первого сообщения из WebApp:

```javascript
// В WebApp при нажатии "Написать"
const tgWebApp = window.Telegram.WebApp;

// Пользователь вводит сообщение
const messageText = document.getElementById('messageInput').value;

// Формируем данные
const data = {
    ad_id: '789',                // ID объявления
    author_tg_id: 456,           // Telegram ID автора
    message: messageText         // Текст сообщения
};

// Отправляем данные боту
tgWebApp.sendData(JSON.stringify(data));

// Закрываем WebApp
tgWebApp.close();
```

### Бот получит данные через:
```python
async def send_first_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = json.loads(update.message.web_app_data.data)
    ad_id = data.get('ad_id')
    author_tg_id = int(data.get('author_tg_id'))
    message_text = data.get('message')
    # ...
```

---

## 📝 Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Главное меню с кнопкой открытия WebApp |
| `/mychats` | Список активных чатов |
| `/block` | Заблокировать собеседника (с выбором, если несколько чатов) |

---

## 🎮 Callback данные

| Callback | Описание |
|----------|----------|
| `accept_{invite_id}` | Принять приглашение в чат |
| `decline_{invite_id}` | Отклонить приглашение |
| `block_{chat_id}` | Заблокировать конкретный чат |
| `sendto_{chat_id}` | Отправить сообщение в выбранный чат (при нескольких) |

---

## ✅ Преимущества новой системы

### 1. **Защита от спама**
- ✅ Пользователь может отправить только ОДНО первое сообщение
- ✅ Автор объявления контролирует, с кем общаться

### 2. **Уважение к приватности**
- ✅ User A не узнает, если его приглашение отклонено
- ✅ Полная анонимность в чатах

### 3. **Контроль**
- ✅ Любая сторона может заблокировать собеседника
- ✅ После блокировки чат прекращается

### 4. **Простота**
- ✅ Интуитивный интерфейс с кнопками
- ✅ Не нужно вводить коды или ID

---

## 🔮 Возможные улучшения

### 📊 Статистика
- Количество отправленных/принятых приглашений
- Процент принятых чатов
- Средняя длительность чатов

### 🔔 Уведомления
- "У вас новое приглашение в чат!"
- "Пользователь прочитал ваше сообщение" (если добавить подтверждения)

### 💾 Персистентность
- Сохранение в БД (сейчас в памяти)
- История сообщений
- Архив завершенных чатов

### 🛡️ Безопасность
- Лимит приглашений в день (anti-spam)
- Автоматическая блокировка за нарушения
- Система репортов

---

## 🚨 Важные ограничения

### ⚠️ Одно сообщение на объявление
- User A может отправить только 1 сообщение на объявление
- Если User B отклонит, флаг сбрасывается и можно отправить снова
- Если User B примет, чат создается

### ⚠️ Хранение в памяти
- Данные теряются при перезапуске бота
- **Рекомендация:** Использовать БД для продакшена

### ⚠️ Блокировка = конец чата
- После блокировки чат нельзя восстановить
- Обоим пользователям придется создавать новый чат

---

## 📈 Пример использования

```
1. User A видит объявление User B в WebApp
2. User A отправляет: "Привет! Меня интересует ваше предложение"
3. User B получает приглашение с кнопками [✅ Принять] [❌ Отклонить]
4. User B нажимает ✅ Принять
5. Чат создан! Оба могут общаться анонимно
6. User A: "Какая цена?"
7. User B: "5000 рублей"
8. User A: "Договорились!"
9. User A: /block (завершает чат)
10. User B получает: "🚫 Чат завершен собеседником"
```

---

## 🎯 Результат

✨ **Пользователи получают:**
- Контроль над входящими запросами
- Защиту от спама
- Возможность заблокировать нежелательное общение
- Полную анонимность

🔒 **Платформа обеспечивает:**
- Безопасное общение
- Соблюдение приватности
- Удобный UX с минимальными действиями
