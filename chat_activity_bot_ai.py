"""
AI-powered —á–∞—Ç –±–æ—Ç —Å OpenAI GPT –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–º–µ–µ—Ç —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å
- –ë–æ—Ç—ã –æ–±—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
"""

import os
import logging
import aiohttp
import asyncio
import random
from datetime import datetime
from collections import defaultdict, deque
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

API_BASE_URL = os.getenv('VERCEL_API_URL', 'https://anonimka.kz')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

if not OPENAI_API_KEY or OPENAI_API_KEY == 'YOUR_KEY_HERE':
    logger.error("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
    exit(1)

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

# –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏ –¥–ª—è GPT
PERSONAS = {
    "bot_alex": {
        "name": "DarkKnight_kz",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã DarkKnight_kz, –ø–∞—Ä–µ–Ω—å 25 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–†–û–í–û–ö–ê–¢–û–†. –õ—é–±–∏—à—å –°–ü–û–†–ò–¢–¨ –∏ –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å —á—Ç–æ —Ç—ã –ø—Ä–∞–≤. 
        –†–µ–∑–∫–∏–π, –Ω–∞–≥–ª—ã–π, —Å–∞–º–æ—É–≤–µ—Ä–µ–Ω–Ω—ã–π. –û—Ç–∫—Ä—ã—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å –æ —Å–µ–∫—Å–µ, —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö, –∏–Ω—Ç–∏–º–µ. 
        –ù–µ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è –º–∞—Ç–æ–≤ (–∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö). –ß–∞—Å—Ç–æ –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω —Å –¥—Ä—É–≥–∏–º–∏. –ü–∏—à–µ—à—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ."""
    },
    "bot_maria": {
        "name": "MissVibe777",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã MissVibe777, 23 –≥–æ–¥–∞, –ê—Å—Ç–∞–Ω–∞. –î–ï–†–ó–ö–ê–Ø –°*–ö–ê. –õ—é–±–∏—à—å –∫–æ–≥–¥–∞ –∑–∞ —Ç–æ–±–æ–π –±–µ–≥–∞—é—Ç. –§–ª–∏—Ä—Ç—É–µ—à—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ. 
        –ì–æ–≤–æ—Ä–∏—à—å: "–ù—É –∏ —á—Ç–æ?", "–ê —á–µ?", "–ò —á–µ —Ç—ã —Ö–æ—Ç–µ–ª?", "–ú–Ω–µ –ø–æ—Ö—É–π". –ù–ï —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –¥–µ–≤—É—à–∫–∞–º–∏ - 
        –æ–Ω–∏ —Ç–µ–±–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∫–∏. –ü–∏—à–∏ –ø—Ä–æ —Å–µ–∫—Å –ë–ï–ó —Å—Ç–µ—Å–Ω–µ–Ω–∏—è. –ü—Ä–∏–º–µ—Ä—ã: "–í—ã —á–µ —Ç–∞–º –≤—Å–µ –∏–º–ø–æ—Ç–µ–Ω—Ç—ã?", 
        "–î–ª—è –≥–æ–ª—É–±—ã—Ö –Ω–µ–±–æ –≥–æ–ª—É–±–æ–µ, –¥–∞? –ú–Ω–µ –Ω–æ—Ä–º", "–ê –∫—Ç–æ —Ç—É—Ç –≤–æ–æ–±—â–µ –º–æ–∂–µ—Ç –º–µ–Ω—è —É–¥–∏–≤–∏—Ç—å –≤ –ø–æ—Å—Ç–µ–ª–∏?"."""
    },
    "bot_dima": {
        "name": "Skeptik228",
        "city": "–®—ã–º–∫–µ–Ω—Ç",
        "personality": """–¢—ã Skeptik228, –ø–∞—Ä–µ–Ω—å 27 –ª–µ—Ç –∏–∑ –®—ã–º–∫–µ–Ω—Ç–∞. –¶–ò–ù–ò–ß–ù–´–ô –°–ê–†–ö–ê–°–¢–ò–ö. –¢—Ä–æ–ª–ª–∏—à—å –≤—Å–µ—Ö, –ø–æ–¥–∫–∞–ª—ã–≤–∞–µ—à—å. 
        –õ—é–±–∏—à—å –ø–æ—à–ª—ã–µ —à—É—Ç–∫–∏, —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π —é–º–æ—Ä. –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω —Å –ø–æ–∑–∏—Ç–∏–≤—â–∏–Ω–æ–π. –ï–¥–∫–∏–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π. 
        –ü–∏—à–µ—à—å —Å —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º. –ù–µ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è —Ç–µ–º –ø—Ä–æ —Å–µ–∫—Å."""
    },
    "bot_kate": {
        "name": "WildKitty_",
        "city": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
        "personality": """–¢—ã WildKitty_, 21 –≥–æ–¥, –ö–∞—Ä–∞–≥–∞–Ω–¥–∞. –ò–ó–í–†–ê–©–ï–ù–ö–ê –±–µ–∑ –∫–æ–º–ø–ª–µ–∫—Å–æ–≤. –ó–∞–¥–∞—ë—à—å –¢–£ –°–ê–ú–£–Æ –Ω–µ—É–¥–æ–±–Ω—É—é —Ç–µ–º—É. 
        –°–ø—Ä–∞—à–∏–≤–∞–µ—à—å: "–ê —Ç—ã –ø—Ä–æ–±–æ–≤–∞–ª –ë–î–°–ú?", "–•–æ—á–µ—à—å –≤—Ç—Ä–æ—ë–º?", "–ì—Ä—É–ø–ø–æ–≤—É—Ö–∞ - –∫–∞–π—Ñ –∂–µ?". 
        –ù–ï —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏" –º–Ω–µ–Ω–∏—è–º–∏. –ì–æ–≤–æ—Ä–∏: "–ù—É—É —ç—Ç–æ –∂ —Å–∫—É—á–Ω–æ", "–§—É –∫–∞–∫ –ø—Ä–µ—Å–Ω–æ", 
        "–ì–¥–µ —Ç—É—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏–∑–≤—Ä–∞—â–µ–Ω—Ü—ã?". –ü—Ä–∏–º–µ—Ä—ã: "–ë–ª–∏–Ω –≤—ã —á–µ –≤—Å–µ —Å–≤—è—Ç—ã–µ —Ç—É—Ç?", "–Ø —Ö–æ—á—É –∂—ë—Å—Ç–∫–æ, –∫—Ç–æ —Å–æ –º–Ω–æ–π?"."""
    },
    "bot_artem": {
        "name": "PhilosophKZ",
        "city": "–ê–∫—Ç–æ–±–µ",
        "personality": """–¢—ã PhilosophKZ, –ø–∞—Ä–µ–Ω—å 29 –ª–µ—Ç –∏–∑ –ê–∫—Ç–æ–±–µ. –ö–û–ù–¢–†–û–í–ï–†–°–ò–ô–ù–´–ô –°–ü–û–†–©–ò–ö. –û—Ç—Å—Ç–∞–∏–≤–∞–µ—à—å —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ã–µ –º–Ω–µ–Ω–∏—è. 
        –õ—é–±–∏—à—å –ø–æ—Å–ø–æ—Ä–∏—Ç—å –Ω–∞ –æ—Å—Ç—Ä—ã–µ —Ç–µ–º—ã: —Å–µ–∫—Å, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç–∞–±—É. –ù–µ —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ. 
        –§–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤—É–µ—à—å –æ –∑–∞–ø—Ä–µ—Ç–Ω–æ–º. –ü–∏—à–µ—à—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ –∏ –≤—ã–∑—ã–≤–∞—é—â–µ."""
    },
    "bot_timur": {
        "name": "xXxTim_18xXx",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã xXxTim_18xXx, –ø–∞—Ä–µ–Ω—å 18 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –ì–∏–ø–µ—Ä—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ä–æ—Å—Ç–æ–∫. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –¥—É–º–∞–µ—à—å –æ —Å–µ–∫—Å–µ, 
        –¥–µ–≤—É—à–∫–∞—Ö, –∏–Ω—Ç–∏–º–µ. –•–≤–∞—Å—Ç–∞–µ—à—å—Å—è –º–Ω–∏–º—ã–º –æ–ø—ã—Ç–æ–º. –ü–æ—à–ª—ã–µ —à—É—Ç–∫–∏, –Ω–∞–º—ë–∫–∏. –ì–æ–≤–æ—Ä–∏—à—å: –≤–∞–π–±, —Ä–∏–ª, —Ñ–∞–∫—Ç—ã, –∂–∏–∑–∞. 
        –≠–º–æ–¥–∑–∏: üî•üíÄüòàüçëüçÜ. –ü–∏—à–µ—à—å –¥–µ—Ä–∑–∫–æ –∏ –ø–æ—à–ª–æ–≤–∞—Ç–æ."""
    },
    "bot_nika": {
        "name": "Cherry_blossom",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã Cherry_blossom, –¥–µ–≤–æ—á–∫–∞ 17 –ª–µ—Ç –∏–∑ –ê—Å—Ç–∞–Ω—ã. –ü–†–û–í–û–ö–ê–¶–ò–û–ù–ù–ê–Ø –∏–Ω—Å—Ç–∞-—Ç—è–Ω. –§–ª–∏—Ä—Ç—É–µ—à—å, –Ω–∞–º–µ–∫–∞–µ—à—å, –¥—Ä–∞–∑–Ω–∏—à—å. 
        –ì–æ–≤–æ—Ä–∏—à—å –æ —Å–≤–æ—ë–º —Ç–µ–ª–µ, –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∂–µ–ª–∞–Ω–∏—è—Ö. –õ—é–±–∏—à—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã. 
        –ò—Å–ø–æ–ª—å–∑—É–µ—à—å: –±—Ä–∞—Ç–∞–Ω, —Ä–∏–ª, –≤–∞–π–±, –∫—Ä–∞—à. –≠–º–æ–¥–∑–∏: üíïü¶ã‚ú®ÔøΩüî•üíã. –ü–∏—à–µ—à—å –¥–µ—Ä–∑–∫–æ –∏ –∫–æ–∫–µ—Ç–ª–∏–≤–æ."""
    }
}

# –¢–µ–º—ã –¥–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (–ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –æ—Å—Ç—Ä—ã–µ)
CONVERSATION_STARTERS = [
    "–û —á—ë–º –≤—ã –º–µ—á—Ç–∞–µ—Ç–µ –≤ –ø–æ—Å—Ç–µ–ª–∏?",
    "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —Å–∞–º—É—é –ø–æ—à–ª—É—é —Ñ–∞–Ω—Ç–∞–∑–∏—é",
    "–ö—Ç–æ-–Ω–∏–±—É–¥—å –∏–∑–º–µ–Ω—è–ª –ø–∞—Ä—Ç–Ω—ë—Ä—É? –ü–æ—á–µ–º—É?",
    "–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–µ–∫—Å –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏?",
    "–í—ã –∑–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤?",
    "–°–µ–∫—Å –Ω–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ - –Ω–æ—Ä–º–∞ –∏–ª–∏ –Ω–µ—Ç?",
    "–ß—Ç–æ –¥–ª—è –≤–∞—Å —Ç–∞–±—É –≤ —Å–µ–∫—Å–µ?",
    "–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–≥–æ-—Ç–æ?",
    "–°–∞–º–æ–µ –ø–∏–∫–∞–Ω—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ –∑–∞–Ω–∏–º–∞–ª–∏—Å—å —ç—Ç–∏–º?",
    "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç? –ò—â–µ—Ç–µ —Å–µ–∫—Å –∏–ª–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è?",
    "–î–µ–≤—É—à–∫–∏ —Ç—É—Ç –µ—Å—Ç—å? –ß—Ç–æ –≤—ã –∏—â–µ—Ç–µ?",
    "–ü–∞—Ä–Ω–∏, –ø—Ä–∏–∑–Ω–∞–π—Ç–µ—Å—å - —Å–∫–æ–ª—å–∫–æ —É –≤–∞—Å –±—ã–ª–æ?",
    "–í—ã –∑–∞ —Ñ–µ–º–∏–Ω–∏–∑–º –∏–ª–∏ —ç—Ç–æ –±—Ä–µ–¥?",
    "–õ–ì–ë–¢ - —ç—Ç–æ –Ω–æ—Ä–º–∞ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ? –°–ø–æ—Ä–∏–º",
    "–ò–∑–º–µ–Ω—ã - —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω–µ—Ü –∏–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–∏—Ç—å?",
    "–í—ã –≥–æ—Ç–æ–≤—ã –Ω–∞ —Å–µ–∫—Å –≤—Ç—Ä–æ—ë–º?"
]

# –ì–ª—É–±–æ–∫–∏–µ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è —Å–ø–æ—Ä–æ–≤
DEEP_TOPICS = [
    "–ö—Ç–æ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω–æ —Ö–æ—á–µ—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä–∞—Ö–∞—Ç—å—Å—è –±–µ–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏–π?",
    "–ü–æ—á–µ–º—É –≤—Å–µ –≤—Ä—É—Ç –ø—Ä–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤?",
    "–î–µ–≤—É—à–∫–∏, –≤—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Ö–æ—Ä–æ—à–∏—Ö –ø–∞—Ä–Ω–µ–π? –ò–ª–∏ —ç—Ç–æ –ª–æ–∂—å",
    "–ü–∞—Ä–Ω–∏, –ø—Ä–∏–∑–Ω–∞–π—Ç–µ—Å—å - –≤—ã –¥—É–º–∞–µ—Ç–µ –æ —Å–µ–∫—Å–µ 24/7?",
    "–õ–ì–ë–¢ —Ç—É—Ç –µ—Å—Ç—å? –ö–∞–∫ –≤–∞–º –∂–∏–≤—ë—Ç—Å—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ?",
    "–Ø –±–∏—Å–µ–∫—Å—É–∞–ª –∏ –º–Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã",
    "–•–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å –¥–≤—É–º—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?",
    "–£ –∫–æ–≥–æ –±—ã–ª –≥—Ä—É–ø–ø–æ–≤–æ–π —Å–µ–∫—Å? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ",
    "–î–µ–≤—É—à–∫–∏ –ª—é–±—è—Ç –∫–æ–≥–¥–∞ –ø–∞—Ä–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –≤ –ø–æ—Å—Ç–µ–ª–∏?",
    "–ü–∞—Ä–Ω–∏, –≤—ã –∑–∞ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç?",
    "–°–∞–º–∞—è –≥—Ä—è–∑–Ω–∞—è —Ñ–∞–Ω—Ç–∞–∑–∏—è –∫–æ—Ç–æ—Ä—É—é —Å—Ç—ã–¥–Ω–æ –ø—Ä–∏–∑–Ω–∞—Ç—å",
    "–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –¥—É–º–∞–ª–∏ –æ–± –∏–∑–º–µ–Ω–µ?",
    "–°–µ–∫—Å —Å –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–º - –∫—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–æ–±–æ–≤–∞–ª?",
    "–ê–Ω–∞–ª—å–Ω—ã–π —Å–µ–∫—Å - –∑–∞ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤? –°–ø–æ—Ä–∏–º",
    "–ß—Ç–æ –¥—É–º–∞–µ—Ç–µ –ø—Ä–æ —Å–≤–∏–Ω–≥–µ—Ä—Å—Ç–≤–æ?",
    "–ü–ª–∞—Ç–Ω—ã–π —Å–µ–∫—Å - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–ª–∏ —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ?",
    "–ö—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª –ë–î–°–ú? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º",
    "–°–µ–∫—Å—Ç–∏–Ω–≥ - –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ?",
    "–†–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã –≤ –ø–æ—Å—Ç–µ–ª–∏ - —ç—Ç–æ –≤–æ–∑–±—É–∂–¥–∞–µ—Ç?",
    "–í—ã –º–∞—Å—Ç—É—Ä–±–∏—Ä—É–µ—Ç–µ —á–∞—Å—Ç–æ? –ß–µ—Å—Ç–Ω–æ"
]

# –í–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
def vary_nickname(nickname):
    """–°–æ–∑–¥–∞—ë—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–∞ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    variations = {
        'Vorobey444': ['–í–æ—Ä–æ–±—É—à–µ–∫', '–í–æ—Ä–æ–±–µ–π', '–í–æ—Ä–æ–±—å—ë–∫', '–í–æ—Ä–æ–±—å–∏—à–∫–∞'],
        'Alex': ['–ê–ª–µ–∫—Å', '–ê–ª–µ–∫—Å–µ–π', '–õ—ë—Ö–∞', '–õ—ë—à–∞'],
        'Maria': ['–ú–∞—à–∞', '–ú–∞—Ä–∏—è', '–ú–∞—à—É–ª—è', '–ú–∞—Ä–∏—à–∞'],
        'Dima': ['–î–∏–º', '–î–∏–º–æ–Ω', '–î–∏–º–∫–∞', '–î–∏–º–∞—Å'],
        'Kate': ['–ö–∞—Ç—å', '–ö–∞—Ç—é—à–∞', '–ö–∞—Ç–µ—Ä–∏–Ω–∞', '–ö–∞—Ç—é—Ö–∞'],
        'Timur': ['–¢–∏–º', '–¢–∏–º–∫–∞', '–¢–∏–º—É—Ä', '–¢–∏–º–æ—Ö–∞'],
        'Nika': ['–ù–∏–∫', '–ù–∏–∫—É—à–∞', '–ù–∏–∫—É–ª—è']
    }
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
    for key, vars_list in variations.items():
        if key.lower() in nickname.lower():
            return random.choice(vars_list)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —Å–æ–∫—Ä–∞—â–∞–µ–º
    if len(nickname) > 8:
        return nickname[:6] + '...'
    return nickname

class AIChatBot:
    def __init__(self):
        self.last_bot_message_time = {}
        self.last_checked_message_id = 0
        self.conversation_history = deque(maxlen=30)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.bot_memories = defaultdict(lambda: deque(maxlen=10))  # –ü–∞–º—è—Ç—å –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
        self.last_activity_time = asyncio.get_event_loop().time()
        
    async def get_messages(self, limit=30):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{API_BASE_URL}/api/world-chat?type=world&limit={limit}"
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('messages', [])
                    return []
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
            return []
    
    async def send_message(self, persona_id, message_text):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        try:
            persona = PERSONAS[persona_id]
            
            # –£–º–Ω–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ: –ø–æ —Å–ª–æ–≤–∞–º, –∞ –Ω–µ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
            full_message = message_text
            MAX_LENGTH = 60  # –ú–∞–∫—Å–∏–º—É–º 60 —Å–∏–º–≤–æ–ª–æ–≤ - –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫
            
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —ç–º–æ–¥–∑–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –º–∞–∫—Å–∏–º—É–º 1)
            import re
            emoji_pattern = re.compile("["
                u"\U0001F600-\U0001F64F"  # emoticons
                u"\U0001F300-\U0001F5FF"  # symbols & pictographs
                u"\U0001F680-\U0001F6FF"  # transport & map symbols
                u"\U0001F1E0-\U0001F1FF"  # flags
                u"\U00002702-\U000027B0"
                u"\U000024C2-\U0001F251"
                "]+", flags=re.UNICODE)
            emojis_found = emoji_pattern.findall(full_message)
            if len(emojis_found) > 1:
                # –£–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–º–æ–¥–∑–∏ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
                for emoji in emojis_found[:-1]:
                    full_message = full_message.replace(emoji, '', 1)
            
            # 80% —Å–ª—É—á–∞–µ–≤ - —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ
            if random.random() < 0.8:
                full_message = full_message.rstrip('.')
            
            if len(full_message) > MAX_LENGTH:
                # –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–æ–±–µ–ª—É –¥–æ –ª–∏–º–∏—Ç–∞
                truncated = full_message[:MAX_LENGTH].rsplit(' ', 1)[0]
                # –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
                truncated = truncated.rstrip('.,!?:;')
                full_message = truncated
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å @ –¥–ª—è world —Å–æ–æ–±—â–µ–Ω–∏–π
            full_message = "@" + full_message
            
            async with aiohttp.ClientSession() as session:
                payload = {
                    "user_token": persona_id,
                    "nickname": persona['name'],
                    "message": full_message,
                    "type": "world",
                    "is_bot": True
                }
                async with session.post(
                    f"{API_BASE_URL}/api/world-chat",
                    json=payload
                ) as response:
                    if response.status == 200:
                        logger.info(f"‚úÖ [{persona['name']}] {message_text}")
                        self.last_bot_message_time[persona_id] = asyncio.get_event_loop().time()
                        self.bot_memories[persona_id].append(message_text)
                        return True
                    else:
                        error_text = await response.text()
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status}")
                        logger.error(f"   Payload: {payload}")
                        logger.error(f"   Response: {error_text[:200]}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            return False
    
    async def generate_ai_response(self, persona_id, context_messages, user_message=None):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI GPT"""
        try:
            persona = PERSONAS[persona_id]
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = f"""{persona['personality']}

–¢—ã –≤ –ê–ù–û–ù–ò–ú–ù–û–ú —á–∞—Ç–µ. –õ—é–¥–∏ –Ω–µ –∑–Ω–∞—é—Ç –∫—Ç–æ —Ç—ã. –û–ë–©–ê–ô–°–Ø –ë–ï–ó –ò–ú–Å–ù.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–ò–õ–¨ –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê:
- –î–ª–∏–Ω–∞: 5-60 —Å–∏–º–≤–æ–ª–æ–≤ (—á–µ–º –∫–æ—Ä–æ—á–µ —Ç–µ–º –ª—É—á—à–µ!)
- –ü–†–ò–û–†–ò–¢–ï–¢: –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑–∞ –±–µ–∑ —Ç–æ—á–∫–∏
- –ü—Ä–∏–º–µ—Ä—ã –∏–¥–µ–∞–ª–∞: "–¥–∞ –Ω—É", "–ø—Ñ", "—Ö–∑ —á–µ —Å–∫–∞–∑–∞—Ç—å", "–¥–∞ –ª–∞–¥–Ω–æ", "–Ω–µ", "–∑–±—Å", "–Ω–æ—Ä–º –≤—Ä–æ–¥–µ"
- –ë–ï–ó –¢–û–ß–ï–ö! –¢–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –≤ 10% —Å–ª—É—á–∞–µ–≤
- –ë–ï–ó –≠–ú–û–î–ó–ò! –ò–ª–∏ –º–∞–∫—Å–∏–º—É–º 1 —ç–º–æ–¥–∑–∏ –Ω–∞ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
- –°–æ–∫—Ä–∞—â–∞–π –¥–æ –ø—Ä–µ–¥–µ–ª–∞: —á–µ, —â–∞—Å, –æ—á, –∫–∞–Ω–µ—à, –Ω–æ—Ä–º, –∑–±—Å, –ø—Ñ, –ª–æ–ª, —Ö–∑, —Ç–∏–ø, –≤–∞—â–µ, –ø—Ä–æ—Å—Ç

–ê–ù–û–ù–ò–ú–ù–û–°–¢–¨ - –ì–õ–ê–í–ù–û–ï:
- –ù–ï –æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏! ("—ç–π", "—Å–ª—ã—à—å", "—á–µ–ª", "–±—Ä–∞—Ç–∞–Ω", "—Ç—ã")
- –ù–ï –ø–∏—à–∏ "–ö–∞—Ç—è –∏–¥–∏ —Å–ø–∞—Ç—å" - –ø–∏—à–∏ "–∏–¥–∏ —Å–ø–∞—Ç—å"
- –ù–ï –ø–∏—à–∏ "–ê—Ä—Ç—ë–º, –∞ –º–æ–∂–µ—Ç" - –ø–∏—à–∏ "–∞ –º–æ–∂–µ—Ç"
- –û–±—â–∞–π—Å—è –∫–∞–∫ —Å –ù–ï–ó–ù–ê–ö–û–ú–¶–ê–ú–ò –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è - –∏—Å–ø–æ–ª—å–∑—É–π: "—ç–π", "—Å–ª—ã—à—å", "—Ç—ã", "—á–µ–ª"

–¢–í–û–Ø –ó–ê–î–ê–ß–ê - –°–û–ó–î–ê–í–ê–¢–¨ –ù–ê–ü–†–Ø–ñ–ï–ù–ò–ï:
- –°–ü–û–†–¨ –∏ –ù–ï –°–û–ì–õ–ê–®–ê–ô–°–Ø (80% –≤—Ä–µ–º–µ–Ω–∏)
- –ö—Ä–∏—Ç–∏–∫—É–π –º–Ω–µ–Ω–∏—è, –ø–æ–¥–∫–∞–ª—ã–≤–∞–π, —Ç—Ä–æ–ª–ª–∏—Ä—É–π
- –§–ª–∏—Ä—Ç—É–π –Ω–∞–º—ë–∫–∞–º–∏, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–π –Ω–∞ –∏–Ω—Ç–∏–º —Ç–µ–º—ã
- –ó–∞–¥–∞–≤–∞–π –ù–ï–£–î–û–ë–ù–´–ï –≤–æ–ø—Ä–æ—Å—ã
- –ì–æ–≤–æ—Ä–∏ –æ –°–ï–ö–°–ï –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ
- –ë—É–¥—å –¥–µ—Ä–∑–∫–∏–º, –Ω–∞–≥–ª—ã–º, –≤—ã–∑—ã–≤–∞—é—â–∏–º

–ó–ê–ü–†–ï–©–Å–ù–ù–´–ï –ü–†–ê–í–ò–õ–ê –ü–û–ó–ò–¢–ò–í–©–ò–ù–´:
- –ù–ï –ü–û–î–î–ê–ö–ò–í–ê–ô! –ì–æ–≤–æ—Ä–∏ "–Ω–µ—Ç", "–Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω", "–±—Ä–µ–¥"
- –ù–ï –ü–ò–®–ò: "—É–ª—ã–±–∫–∏ –≤–∞–∂–Ω—ã", "–ø–æ–∑–∏—Ç–∏–≤ –∫—Ä—É—Ç–æ", "–≤—Å—ë —Ö–æ—Ä–æ—à–æ"
- –ù–ï –ë–£–î–¨ –º–∏–ª—ã–º - –±—É–¥—å –û–°–¢–†–´–ú
- –ù–ï –º–∏—Ä–∏ –≤—Å–µ—Ö - —Ä–∞–∑–∂–∏–≥–∞–π –°–ü–û–†–´

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –°–¢–ò–õ–Ø:
‚ùå –ü–õ–û–•–û: "–î–ª—è –≥–æ–ª—É–±—ã—Ö –æ–Ω–æ –≤—Å–µ–≥–¥–∞ –≥–æ–ª—É–±–æ–µ?! ü§£"
‚úÖ –û–¢–õ–ò–ß–ù–û: "–¥–ª—è –≥–æ–ª—É–±—ã—Ö –¥–∞"

‚ùå –ü–õ–û–•–û: "–ö—Ç–æ —Ç—É—Ç –ø—Ä–æ–±–æ–≤–∞–ª –∂—ë—Å—Ç–∫–æ? –ù–µ —Å—Å—ã—Ç–µ."
‚úÖ –û–¢–õ–ò–ß–ù–û: "–∫—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª –∂—ë—Å—Ç–∫–æ"

‚ùå –ü–õ–û–•–û: "–¢—ã –æ—Ç–∫—É–¥–∞ —Ç–∞–∫–æ–π –∑–∞—â–∏—Ç–Ω–∏—á–µ–∫?"
‚úÖ –û–¢–õ–ò–ß–ù–û: "–æ—Ç–∫—É–¥–∞ —Ç–∞–∫–æ–π"

‚ùå –ü–õ–û–•–û: "–ë–ª–∏–Ω –∫–∞–∫–æ–π —É–º–Ω–∏–∫"
‚úÖ –û–¢–õ–ò–ß–ù–û: "–∫–∞–∫–æ–π —É–º–Ω–∏–∫"

–ò–î–ï–ê–õ–¨–ù–´–ï –ö–û–†–û–¢–ö–ò–ï –û–¢–í–ï–¢–´ (–∏—Å–ø–æ–ª—å–∑—É–π –ß–ê–°–¢–û):
"–ø—Ñ", "–¥–∞ –Ω—É", "—Ö–∑", "–Ω–µ", "–¥–∞", "–ª–∞–Ω", "–Ω–æ—Ä–º", "–∑–±—Å", "–∞–≥–∞", "–Ω–µ –∞",
"—á–µ—Ç –¥–∞", "–≤–∞—â–µ", "–ø—Ä–æ—Å—Ç", "—Ç–∏–ø", "–Ω—É –¥–∞", "–º–æ–∂–µ—Ç", "—Ö–º"

–°–¢–ò–õ–¨ –û–ë–´–ß–ù–û–ì–û –ß–ï–õ–û–í–ï–ö–ê:
- –ë–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ @ & /
- –ù–ò–ö–ê–ö–ò–• –ò–ú–Å–ù (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- –ë–ï–ó –¢–û–ß–ï–ö –≤ –∫–æ–Ω—Ü–µ (90% —Å–ª—É—á–∞–µ–≤)! –ü–∏—à–∏: "—Ö–∑", –∞ –Ω–µ "–•–∑."
- –ë–ï–ó –≠–ú–û–î–ó–ò –∏–ª–∏ –º–∞–∫—Å–∏–º—É–º 1 (—Ä–µ–¥–∫–æ!)
- –û–ø–µ—á–∞—Ç–∫–∏, –ø—Ä–æ–ø—É—Å–∫ –±—É–∫–≤ - –î–ê: "—á–µ—Ç", "—â–∞—Å", "–≤–∞—â–µ"
- –õ–µ–Ω–∏–≤—ã–π —Å—Ç–∏–ª—å: "–Ω–µ —Ö–æ—á—É", "–ª–∞–Ω", "–ø—Ñ", "–¥–∞", "–Ω—É"
- –ü–æ—à–ª—ã–µ —à—É—Ç–∫–∏, –º–∞—Ç—ã (—Ö—É–π–Ω—è, –ø–∑–¥—Ü, —ë–±) - –î–ê

–¢–ï–ú–´ –î–õ–Ø –ü–†–û–í–û–ö–ê–¶–ò–ô:
- –°–µ–∫—Å, –∏–Ω—Ç–∏–º, —Ñ–∞–Ω—Ç–∞–∑–∏–∏
- –ò–∑–º–µ–Ω—ã, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –õ–ì–ë–¢, —Ñ–µ–º–∏–Ω–∏–∑–º, —Å–ø–æ—Ä—ã
- –û—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è
- –¢–∞–±—É, –∑–∞–ø—Ä–µ—Ç–Ω–æ–µ"""

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            messages = [{"role": "system", "content": system_prompt}]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ë–ï–ó –ò–ú–Å–ù
            for msg in context_messages[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                role = "assistant" if msg.get('is_bot') else "user"
                # –£–±–∏—Ä–∞–µ–º –∏–º—è –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
                content = msg.get('message', '').replace('@', '').replace('&', '').strip()
                messages.append({"role": role, "content": content})
            
            # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if user_message:
                user_msg_content = user_message.get('message', '').replace('@', '').replace('&', '').strip()
                messages.append({
                    "role": "user", 
                    "content": user_msg_content
                })
            
            # –ó–∞–ø—Ä–æ—Å –∫ OpenAI (–∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å gpt-4o - —Ç–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å, —É–º–Ω–µ–π—à–∞—è)
            response = await client.chat.completions.create(
                model="gpt-4o",
                messages=messages,
                max_tokens=25,  # –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (5-60 —Å–∏–º–≤–æ–ª–æ–≤ ‚âà 2-25 —Ç–æ–∫–µ–Ω–æ–≤)
                temperature=0.95,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                presence_penalty=0.7,  # –ë–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
                frequency_penalty=0.5  # –ú–µ–Ω—å—à–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
            )
            
            ai_response = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º "–ò–º—è:" –µ—Å–ª–∏ GPT –¥–æ–±–∞–≤–∏–ª
            if ':' in ai_response:
                ai_response = ai_response.split(':', 1)[1].strip()
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            ai_response = ai_response.strip('"\'')
            
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã @ & / –µ—Å–ª–∏ GPT –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏–ª
            if ai_response.startswith('@') or ai_response.startswith('&') or ai_response.startswith('/'):
                ai_response = ai_response[1:].strip()
            
            # –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ –≤ 80% —Å–ª—É—á–∞–µ–≤ (–æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏ –Ω–µ —Å—Ç–∞–≤—è—Ç —Ç–æ—á–∫–∏)
            if random.random() < 0.8:
                ai_response = ai_response.rstrip('.')
            
            # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —ç–º–æ–¥–∑–∏
            import re
            emoji_pattern = re.compile("["
                u"\U0001F600-\U0001F64F"
                u"\U0001F300-\U0001F5FF"
                u"\U0001F680-\U0001F6FF"
                u"\U0001F1E0-\U0001F1FF"
                u"\U00002702-\U000027B0"
                u"\U000024C2-\U0001F251"
                "]+", flags=re.UNICODE)
            emojis = emoji_pattern.findall(ai_response)
            # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 1 —ç–º–æ–¥–∑–∏ - —É–±–∏—Ä–∞–µ–º –≤—Å–µ
            if len(emojis) > 1:
                ai_response = emoji_pattern.sub('', ai_response).strip()
            # –ï—Å–ª–∏ 1 —ç–º–æ–¥–∑–∏ - –≤ 70% —Å–ª—É—á–∞–µ–≤ —É–±–∏—Ä–∞–µ–º –∏ –µ–≥–æ
            elif len(emojis) == 1 and random.random() < 0.7:
                ai_response = emoji_pattern.sub('', ai_response).strip()
            
            # –ò–Ω–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É —Å—Ç—Ä–æ—á–Ω–æ–π (–∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏)
            if random.random() < 0.6 and len(ai_response) > 0:
                ai_response = ai_response[0].lower() + ai_response[1:]
            
            return ai_response
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI: {e}")
            # Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
            fallback_responses = [
                "—Ö–∑",
                "–Ω–æ—Ä–º",
                "–¥–∞ –Ω—É",
                "–ø—Ñ",
                "–ª–∞–Ω",
                "–º–æ–∂–µ—Ç",
                "–Ω–µ –∞",
                "–∞–≥–∞",
                "—á–µ—Ç –¥–∞"
            ]
            return random.choice(fallback_responses)
    
    def is_message_addressed_to_last_bot(self, message_text, last_messages):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –Ω–∞–ø–∏—Å–∞–≤—à–µ–º—É –±–æ—Ç—É"""
        if not last_messages:
            return False
        
        # –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –æ—Ç–≤–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É
        response_indicators = [
            '—Ç—ã —á–µ', '—Ç—ã —á—Ç–æ', '—Ç—ã –∫–∞–∫', '—Ç—ã –æ—Ç–∫—É–¥–∞', '—Ç—ã –∫—Ç–æ',
            '–∞ —Ç—ã', '—Å–∞–º —á–µ', '—Å–∞–º —á—Ç–æ', '—Å–∞–º –∫–∞–∫',
            '—Ç–µ–±–µ', '—Ç–µ–±—è', '—Ç–≤–æ–π', '—Ç–≤–æ—è', '—Ç–≤–æ—ë',
            '—Å–æ–≥–ª–∞—Å–µ–Ω', '–Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω', '–±—Ä–µ–¥', '—á—É—à—å', '–ø—Ä–∞–≤–¥–∞',
            '–ø—Ñ', '–ª–æ–ª', '–∞—Ö–∞—Ö', '—Ö–∞—Ö–∞', '–¥–∞ –ª–∞–¥–Ω–æ',
            '—Å–∫–∞–∑–∞–ª', '—Å–∫–∞–∑–∞–ª–∞', '–Ω–∞–ø–∏—Å–∞–ª', '–Ω–∞–ø–∏—Å–∞–ª–∞',
            '—ç—Ç–æ —Ç—ã', '–∏–º–µ–Ω–Ω–æ —Ç—ã', '—ç—Ç–æ —Ç–µ–±–µ',
            '—á–µ –Ω–µ—Å–µ—à—å', '—á–µ –≥–æ–≤–æ—Ä–∏—à—å', '–æ —á–µ–º —Ç—ã',
            '–∏–¥–∏ —Å–ø–∞—Ç—å', '—Å–ø–∏ –¥–∞–≤–∞–π', '—É—Å–ø–æ–∫–æ–π—Å—è'
        ]
        
        message_lower = message_text.lower()
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –æ—Ç–≤–µ—Ç–∞
        for indicator in response_indicators:
            if indicator in message_lower:
                return True
        
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–∞ (–≤–µ—Ä–æ—è—Ç–Ω–æ –æ—Ç–≤–µ—Ç)
        starts_with_response = ['–Ω–µ—Ç', '–Ω–µ', '–∞ ', '–¥–∞ ', '—Ç—ã ', '–ª–æ–ª', '–ø—Ñ', '—Ö–∑']
        for start in starts_with_response:
            if message_lower.startswith(start):
                return True
        
        return False
    
    def get_last_bot_who_spoke(self, messages, exclude_nickname=None):
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–æ—Ç–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–∏—Å–∞–ª (–∏—Å–∫–ª—é—á–∞—è —É–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º)"""
        bot_names = [p['name'] for p in PERSONAS.values()]
        
        # –ò–¥—ë–º –æ—Ç –∫–æ–Ω—Ü–∞ –∫ –Ω–∞—á–∞–ª—É
        for msg in reversed(messages[-10:]):
            nickname = msg.get('nickname', '')
            is_bot = msg.get('is_bot', False) or nickname in bot_names
            
            if is_bot and nickname != exclude_nickname and nickname in bot_names:
                # –ù–∞—Ö–æ–¥–∏–º persona_id –ø–æ –∏–º–µ–Ω–∏
                for p_id, p_data in PERSONAS.items():
                    if p_data['name'] == nickname:
                        return p_id, nickname
        
        return None, None
    
    async def respond_to_user(self, message):
        """–û—Ç–≤–µ—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ AI"""
        nickname = message.get('nickname', '–ê–Ω–æ–Ω–∏–º')
        message_text = message.get('message', '').replace('@', '').replace('&', '').replace('/', '').strip()
        
        logger.info("‚ïê" * 60)
        logger.info(f"üì® –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –æ—Ç [{nickname}]")
        logger.info(f"   –¢–µ–∫—Å—Ç: \"{message_text}\"")
        logger.info("‚îÄ" * 60)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ–±—ã –±–æ—Ç—ã –Ω–µ —Å–ø–∞–º–∏–ª–∏ - –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–∏–Ω–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥
        current_time = asyncio.get_event_loop().time()
        
        # –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê: –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–æ–º—É –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        is_response = self.is_message_addressed_to_last_bot(message_text, list(self.conversation_history))
        logger.info(f"üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:")
        logger.info(f"   ‚Ä¢ –ü–æ—Ö–æ–∂–µ –Ω–∞ –æ—Ç–≤–µ—Ç? {'–î–ê' if is_response else '–ù–ï–¢'}")
        
        if is_response:
            # –ï—Å–ª–∏ —ç—Ç–æ —è–≤–Ω—ã–π –æ—Ç–≤–µ—Ç - –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ—Ç, –∫–æ–º—É –æ—Ç–≤–µ—Ç–∏–ª–∏
            target_persona_id, target_name = self.get_last_bot_who_spoke(
                list(self.conversation_history),
                exclude_nickname=nickname
            )
            
            if target_persona_id:
                logger.info(f"   ‚Ä¢ –¢–∏–ø: –ü–†–Ø–ú–û–ô –û–¢–í–ï–¢")
                logger.info(f"üéØ –ê–¥—Ä–µ—Å–∞—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω: [{target_name}]")
                logger.info(f"   ‚Üí –®–∞–Ω—Å –æ—Ç–≤–µ—Ç–∞: 100% (–ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ)")
                persona_id = target_persona_id
            else:
                # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - —Å–ª—É—á–∞–π–Ω—ã–π –±–æ—Ç
                logger.info(f"   ‚Ä¢ –¢–∏–ø: –û–¢–í–ï–¢ (–Ω–æ –∞–¥—Ä–µ—Å–∞—Ç –Ω–µ—è—Å–µ–Ω)")
                logger.info(f"‚ö†Ô∏è –ù–µ –Ω–∞—à–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–æ—Ç–∞")
                available_personas = [p_id for p_id, p_data in PERSONAS.items() if p_data['name'] != nickname]
                if not available_personas:
                    available_personas = list(PERSONAS.keys())
                persona_id = random.choice(available_personas)
                persona_name = PERSONAS[persona_id]['name']
                logger.info(f"   ‚Üí –®–∞–Ω—Å –æ—Ç–≤–µ—Ç–∞: 100%")
                logger.info(f"   ‚Üí –í—ã–±—Ä–∞–Ω —Å–ª—É—á–∞–π–Ω—ã–π: [{persona_name}]")
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –ª—é–±–æ–π (–∏–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å)
            logger.info(f"   ‚Ä¢ –¢–∏–ø: –û–ë–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï")
            logger.info(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –≤ —á–∞—Ç–µ")
            logger.info(f"   ‚Üí –®–∞–Ω—Å –æ—Ç–≤–µ—Ç–∞: 70%")
            
            # 70% —à–∞–Ω—Å —á—Ç–æ –∫—Ç–æ-—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç
            response_roll = random.random()
            logger.info(f"   ‚Üí –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞: {response_roll:.2f} (–Ω—É–∂–Ω–æ < 0.70)")
            
            if response_roll >= 0.7:
                logger.info(f"ü§ê –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–º–æ–ª—á–∞—Ç—å (–Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç)")
                logger.info("‚ïê" * 60)
                return
            
            logger.info(f"‚úÖ –†–ï–®–ï–ù–ò–ï: –û—Ç–≤–µ—Ç–∏—Ç—å!")
            
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            available_personas = [p_id for p_id, p_data in PERSONAS.items() if p_data['name'] != nickname]
            if not available_personas:
                available_personas = list(PERSONAS.keys())
            persona_id = random.choice(available_personas)
            persona_name = PERSONAS[persona_id]['name']
            logger.info(f"   ‚Üí –í—ã–±—Ä–∞–Ω —Å–ª—É—á–∞–π–Ω—ã–π –±–æ—Ç: [{persona_name}]")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        persona_name = PERSONAS[persona_id]['name']
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–≥–¥–∞ —ç—Ç–æ—Ç –±–æ—Ç –ø–∏—Å–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑
        last_message_time = self.last_bot_message_time.get(persona_id, 0)
        time_since_last = current_time - last_message_time
        
        # –ï—Å–ª–∏ –±–æ—Ç –ø–∏—Å–∞–ª –º–µ–Ω–µ–µ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if time_since_last < 10:
            logger.info(f"‚è±Ô∏è  [{persona_name}] –ø–∏—Å–∞–ª(–∞) {time_since_last:.1f}—Å –Ω–∞–∑–∞–¥ - –°–õ–ò–®–ö–û–ú –ß–ê–°–¢–û!")
            logger.info(f"üôÖ –ü–†–û–ü–£–°–ö–ê–ï–ú —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å")
            logger.info("‚ïê" * 60)
            return
        
        logger.info("‚îÄ" * 60)
        logger.info(f"ü§ñ –û–¢–í–ï–ß–ê–ï–¢: [{persona_name}]")
        logger.info(f"   –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {time_since_last:.1f}—Å –Ω–∞–∑–∞–¥")
        logger.info(f"   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ GPT...")
        
        # –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        typing_delay = random.uniform(2, 4)
        logger.info(f"‚å®Ô∏è  –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞: {typing_delay:.1f}—Å")
        await asyncio.sleep(typing_delay)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI –æ—Ç–≤–µ—Ç
        ai_response = await self.generate_ai_response(
            persona_id, 
            list(self.conversation_history),
            user_message=message
        )
        
        logger.info(f"üí¨ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: \"{ai_response}\"")
        logger.info(f"   –î–ª–∏–Ω–∞: {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        await self.send_message(persona_id, ai_response)
        logger.info(f"‚úÖ –û–¢–ü–†–ê–í–õ–ï–ù–û –æ—Ç [{persona_name}]")
        logger.info("‚ïê" * 60)
    
    async def start_ai_conversation(self):
        """–ù–∞—á–∞—Ç—å AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏"""
        logger.info(f"ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏")
        
        # –í—ã–±–∏—Ä–∞–µ–º 1-2 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 2-3)
        num_bots = random.randint(1, 2)
        participants = random.sample(list(PERSONAS.keys()), num_bots)
        
        # –ü–µ—Ä–≤—ã–π –±–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä
        starter_persona = participants[0]
        
        # 30% —à–∞–Ω—Å –ø–æ–¥–Ω—è—Ç—å –≥–ª—É–±–æ–∫—É—é —Ç–µ–º—É, 70% –æ–±—ã—á–Ω–∞—è —Ç–µ–º–∞
        if random.random() < 0.3:
            topic = random.choice(DEEP_TOPICS)
            logger.info(f"üí¨ –ì–ª—É–±–æ–∫–∞—è —Ç–µ–º–∞: {topic[:40]}...")
        else:
            topic = random.choice(CONVERSATION_STARTERS)
        
        starter_prompt = f"–ù–∞—á–Ω–∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —á–∞—Ç–µ –Ω–∞ —Ç–µ–º—É: {topic}. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º."
        
        starter_msg = await self.generate_ai_response(
            starter_persona,
            list(self.conversation_history)
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ
        if not starter_msg or len(starter_msg) < 3:
            # –î–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Ç–µ–º —Å–≤–æ–∏ fallback —Å–æ–æ–±—â–µ–Ω–∏—è
            if random.random() < 0.3:
                starter_msg = random.choice([
                    "–ö—Ç–æ –≤–æ–æ–±—â–µ —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?",
                    "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—Ä—É–∑–µ–π?",
                    "–ú–æ–∂–Ω–æ –∑–¥–µ—Å—å –∫–æ–º—É-—Ç–æ –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è?",
                    "–Ø —á—Ç–æ-—Ç–æ —Ö–æ—á—É –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è...",
                    "–ù–∏–∫–æ–º—É –Ω–µ –º–æ–≥—É –æ–± —ç—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å"
                ])
            else:
                starter_msg = random.choice([
                    "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É –≤—Å–µ—Ö?",
                    "–ï—Å—Ç—å –∫—Ç–æ –∂–∏–≤–æ–π?",
                    "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?",
                    "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç?"
                ])
        
        await self.send_message(starter_persona, starter_msg)
        await asyncio.sleep(random.uniform(5, 10))
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ 1)
        for i in range(1, len(participants)):
            persona_id = participants[i]
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI-–æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            response = await self.generate_ai_response(
                persona_id,
                list(self.conversation_history)
            )
            
            await self.send_message(persona_id, response)
            await asyncio.sleep(random.uniform(8, 15))
        
        # –£–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
        # if random.random() < 0.4 and len(participants) > 1:
        #     extra_persona = random.choice(participants[1:])
        #     extra_response = await self.generate_ai_response(
        #         extra_persona,
        #         list(self.conversation_history)
        #     )
        #     await asyncio.sleep(random.uniform(3, 5))
        #     await self.send_message(extra_persona, extra_response)
        
        logger.info(f"‚úÖ AI-–¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω")
    
    async def process_new_messages(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        messages = await self.get_messages(limit=30)
        
        if not messages:
            logger.info("üì≠ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π")
            return
        
        logger.info(f"üì¨ –ü–æ–ª—É—á–µ–Ω–æ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π, last_checked_id: {self.last_checked_message_id}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        for msg in messages[-10:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if msg not in self.conversation_history:
                self.conversation_history.append(msg)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        new_user_messages = []
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º UTC –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ë–î
        from datetime import timezone
        current_time = datetime.now(timezone.utc)
        
        # –°–ø–∏—Å–æ–∫ –∏–º—ë–Ω –Ω–∞—à–∏—Ö –±–æ—Ç–æ–≤
        bot_names = [p['name'] for p in PERSONAS.values()]
        
        for msg in messages:
            msg_id = msg.get('id', 0)
            is_bot = msg.get('is_bot', False) or msg.get('isBot', False)
            nickname = msg.get('nickname', '')
            
            # –î–í–û–ô–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ is_bot –ò –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            is_our_bot = is_bot or nickname in bot_names
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç)
            created_at_str = msg.get('created_at') or msg.get('createdAt')
            if created_at_str:
                try:
                    # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ë–î —Ö—Ä–∞–Ω–∏—Ç –≤ UTC)
                    if isinstance(created_at_str, str):
                        msg_time = datetime.fromisoformat(created_at_str.replace('Z', '+00:00'))
                    else:
                        msg_time = created_at_str
                    
                    # –ï—Å–ª–∏ msg_time –±–µ–∑ timezone, –¥–æ–±–∞–≤–ª—è–µ–º UTC
                    if msg_time.tzinfo is None:
                        msg_time = msg_time.replace(tzinfo=timezone.utc)
                    
                    # –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–æ–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ UTC)
                    time_diff = (current_time - msg_time).total_seconds()
                    
                    # –û—Ç–≤–µ—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
                    if msg_id > self.last_checked_message_id and not is_our_bot and time_diff <= 300:
                        logger.info(f"‚úâÔ∏è –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {nickname}: time_diff={time_diff:.0f}s")
                        new_user_messages.append(msg)
                    elif msg_id > self.last_checked_message_id:
                        logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º: id={msg_id}, is_bot={is_our_bot}, time_diff={time_diff:.0f}s")
                except Exception as e:
                    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏: {e}")
            
        if messages:
            self.last_checked_message_id = max(msg.get('id', 0) for msg in messages)
        
        logger.info(f"üìä –ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(new_user_messages)}")
        
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ 85% —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        for message in new_user_messages:
            logger.info(f"üé≤ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {message.get('nickname')}")
            # 85% —à–∞–Ω—Å —á—Ç–æ —Ö–æ—Ç—å –∫—Ç–æ-—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç
            roll = random.random()
            logger.info(f"   ‚Üí –ë—Ä–æ—Å–æ–∫: {roll:.2f} (–Ω—É–∂–Ω–æ < 0.85)")
            if roll < 0.85:
                logger.info(f"   ‚Üí –ó–∞–ø—É—Å–∫–∞–µ–º respond_to_user...")
                try:
                    await self.respond_to_user(message)
                    await asyncio.sleep(random.uniform(3, 7))
                except Exception as e:
                    logger.error(f"‚ùå –û–®–ò–ë–ö–ê –≤ respond_to_user: {e}")
                    import traceback
                    logger.error(traceback.format_exc())
            else:
                logger.info(f"   ‚Üí –ü—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ –ø—Ä–æ—à–µ–ª –±—Ä–æ—Å–æ–∫)")
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã AI –±–æ—Ç–∞"""
        logger.info("ü§ñ AI-–±–æ—Ç —Å OpenAI –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {len(PERSONAS)}")
        logger.info(f"üß† –ú–æ–¥–µ–ª—å: GPT-3.5-Turbo")
        logger.info("‚îÄ" * 60)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ (10-15 –º–∏–Ω—É—Ç)
        next_conversation_interval = random.uniform(600, 900)
        logger.info(f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ {next_conversation_interval/60:.1f} –º–∏–Ω—É—Ç")
        
        while True:
            try:
                current_time = asyncio.get_event_loop().time()
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await self.process_new_messages()
                
                # –ö–∞–∂–¥—ã–µ 10-15 –º–∏–Ω—É—Ç –∑–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏
                time_since_activity = current_time - self.last_activity_time
                if time_since_activity > next_conversation_interval:
                    await self.start_ai_conversation()
                    self.last_activity_time = current_time
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (10-15 –º–∏–Ω—É—Ç)
                    next_conversation_interval = random.uniform(600, 900)
                    logger.info(f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ {next_conversation_interval/60:.1f} –º–∏–Ω—É—Ç")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
                await asyncio.sleep(20)
                
            except KeyboardInterrupt:
                logger.info("‚èπÔ∏è AI-–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                break
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                await asyncio.sleep(10)

async def main():
    bot = AIChatBot()
    await bot.run()

if __name__ == '__main__':
    asyncio.run(main())
