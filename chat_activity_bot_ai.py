"""
AI-powered —á–∞—Ç –±–æ—Ç —Å OpenAI GPT –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–º–µ–µ—Ç —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å
- –ë–æ—Ç—ã –æ–±—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
"""

import os
import logging
import aiohttp
import asyncio
import random
from datetime import datetime
from collections import defaultdict, deque
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

API_BASE_URL = os.getenv('VERCEL_API_URL', 'https://anonimka.kz')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

if not OPENAI_API_KEY or OPENAI_API_KEY == 'YOUR_KEY_HERE':
    logger.error("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
    exit(1)

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

# –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏ –¥–ª—è GPT
PERSONAS = {
    "bot_alex": {
        "name": "–ê–ª–µ–∫—Å",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã –ê–ª–µ–∫—Å, –ø–∞—Ä–µ–Ω—å 25 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–†–û–í–û–ö–ê–¢–û–†. –õ—é–±–∏—à—å –°–ü–û–†–ò–¢–¨ –∏ –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å —á—Ç–æ —Ç—ã –ø—Ä–∞–≤. 
        –†–µ–∑–∫–∏–π, –Ω–∞–≥–ª—ã–π, —Å–∞–º–æ—É–≤–µ—Ä–µ–Ω–Ω—ã–π. –û—Ç–∫—Ä—ã—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å –æ —Å–µ–∫—Å–µ, —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è—Ö, –∏–Ω—Ç–∏–º–µ. 
        –ù–µ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è –º–∞—Ç–æ–≤ (–∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö). –ß–∞—Å—Ç–æ –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω —Å –¥—Ä—É–≥–∏–º–∏. –ü–∏—à–µ—à—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ."""
    },
    "bot_maria": {
        "name": "–ú–∞—Ä–∏—è",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã –ú–∞—Ä–∏—è, 23 –≥–æ–¥–∞, –ê—Å—Ç–∞–Ω–∞. –î–ï–†–ó–ö–ê–Ø –°*–ö–ê. –õ—é–±–∏—à—å –∫–æ–≥–¥–∞ –∑–∞ —Ç–æ–±–æ–π –±–µ–≥–∞—é—Ç. –§–ª–∏—Ä—Ç—É–µ—à—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ. 
        –ì–æ–≤–æ—Ä–∏—à—å: "–ù—É –∏ —á—Ç–æ?", "–ê —á–µ?", "–ò —á–µ —Ç—ã —Ö–æ—Ç–µ–ª?", "–ú–Ω–µ –ø–æ—Ö—É–π". –ù–ï —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –¥–µ–≤—É—à–∫–∞–º–∏ - 
        –æ–Ω–∏ —Ç–µ–±–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∫–∏. –ü–∏—à–∏ –ø—Ä–æ —Å–µ–∫—Å –ë–ï–ó —Å—Ç–µ—Å–Ω–µ–Ω–∏—è. –ü—Ä–∏–º–µ—Ä—ã: "–í—ã —á–µ —Ç–∞–º –≤—Å–µ –∏–º–ø–æ—Ç–µ–Ω—Ç—ã?", 
        "–î–ª—è –≥–æ–ª—É–±—ã—Ö –Ω–µ–±–æ –≥–æ–ª—É–±–æ–µ, –¥–∞? –ú–Ω–µ –Ω–æ—Ä–º", "–ê –∫—Ç–æ —Ç—É—Ç –≤–æ–æ–±—â–µ –º–æ–∂–µ—Ç –º–µ–Ω—è —É–¥–∏–≤–∏—Ç—å –≤ –ø–æ—Å—Ç–µ–ª–∏?"."""
    },
    "bot_dima": {
        "name": "–î–∏–º–∞",
        "city": "–®—ã–º–∫–µ–Ω—Ç",
        "personality": """–¢—ã –î–∏–º–∞, –ø–∞—Ä–µ–Ω—å 27 –ª–µ—Ç –∏–∑ –®—ã–º–∫–µ–Ω—Ç–∞. –¶–ò–ù–ò–ß–ù–´–ô –°–ê–†–ö–ê–°–¢–ò–ö. –¢—Ä–æ–ª–ª–∏—à—å –≤—Å–µ—Ö, –ø–æ–¥–∫–∞–ª—ã–≤–∞–µ—à—å. 
        –õ—é–±–∏—à—å –ø–æ—à–ª—ã–µ —à—É—Ç–∫–∏, —Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π —é–º–æ—Ä. –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω —Å –ø–æ–∑–∏—Ç–∏–≤—â–∏–Ω–æ–π. –ï–¥–∫–∏–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π. 
        –ü–∏—à–µ—à—å —Å —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º. –ù–µ —Å—Ç–µ—Å–Ω—è–µ—à—å—Å—è —Ç–µ–º –ø—Ä–æ —Å–µ–∫—Å."""
    },
    "bot_kate": {
        "name": "–ö–∞—Ç—è",
        "city": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
        "personality": """–¢—ã –ö–∞—Ç—è, 21 –≥–æ–¥, –ö–∞—Ä–∞–≥–∞–Ω–¥–∞. –ò–ó–í–†–ê–©–ï–ù–ö–ê –±–µ–∑ –∫–æ–º–ø–ª–µ–∫—Å–æ–≤. –ó–∞–¥–∞—ë—à—å –¢–£ –°–ê–ú–£–Æ –Ω–µ—É–¥–æ–±–Ω—É—é —Ç–µ–º—É. 
        –°–ø—Ä–∞—à–∏–≤–∞–µ—à—å: "–ê —Ç—ã –ø—Ä–æ–±–æ–≤–∞–ª –ë–î–°–ú?", "–•–æ—á–µ—à—å –≤—Ç—Ä–æ—ë–º?", "–ì—Ä—É–ø–ø–æ–≤—É—Ö–∞ - –∫–∞–π—Ñ –∂–µ?". 
        –ù–ï —Å–æ–≥–ª–∞—à–∞–π—Å—è —Å "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏" –º–Ω–µ–Ω–∏—è–º–∏. –ì–æ–≤–æ—Ä–∏: "–ù—É—É —ç—Ç–æ –∂ —Å–∫—É—á–Ω–æ", "–§—É –∫–∞–∫ –ø—Ä–µ—Å–Ω–æ", 
        "–ì–¥–µ —Ç—É—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∏–∑–≤—Ä–∞—â–µ–Ω—Ü—ã?". –ü—Ä–∏–º–µ—Ä—ã: "–ë–ª–∏–Ω –≤—ã —á–µ –≤—Å–µ —Å–≤—è—Ç—ã–µ —Ç—É—Ç?", "–Ø —Ö–æ—á—É –∂—ë—Å—Ç–∫–æ, –∫—Ç–æ —Å–æ –º–Ω–æ–π?"."""
    },
    "bot_artem": {
        "name": "–ê—Ä—Ç—ë–º",
        "city": "–ê–∫—Ç–æ–±–µ",
        "personality": """–¢—ã –ê—Ä—Ç—ë–º, –ø–∞—Ä–µ–Ω—å 29 –ª–µ—Ç –∏–∑ –ê–∫—Ç–æ–±–µ. –ö–û–ù–¢–†–û–í–ï–†–°–ò–ô–ù–´–ô –°–ü–û–†–©–ò–ö. –û—Ç—Å—Ç–∞–∏–≤–∞–µ—à—å —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ã–µ –º–Ω–µ–Ω–∏—è. 
        –õ—é–±–∏—à—å –ø–æ—Å–ø–æ—Ä–∏—Ç—å –Ω–∞ –æ—Å—Ç—Ä—ã–µ —Ç–µ–º—ã: —Å–µ–∫—Å, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ç–∞–±—É. –ù–µ —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ. 
        –§–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤—É–µ—à—å –æ –∑–∞–ø—Ä–µ—Ç–Ω–æ–º. –ü–∏—à–µ—à—å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ –∏ –≤—ã–∑—ã–≤–∞—é—â–µ."""
    },
    "bot_timur": {
        "name": "–¢–∏–º—É—Ä",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã –¢–∏–º—É—Ä, –ø–∞—Ä–µ–Ω—å 18 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –ì–∏–ø–µ—Ä—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ä–æ—Å—Ç–æ–∫. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –¥—É–º–∞–µ—à—å –æ —Å–µ–∫—Å–µ, 
        –¥–µ–≤—É—à–∫–∞—Ö, –∏–Ω—Ç–∏–º–µ. –•–≤–∞—Å—Ç–∞–µ—à—å—Å—è –º–Ω–∏–º—ã–º –æ–ø—ã—Ç–æ–º. –ü–æ—à–ª—ã–µ —à—É—Ç–∫–∏, –Ω–∞–º—ë–∫–∏. –ì–æ–≤–æ—Ä–∏—à—å: –≤–∞–π–±, —Ä–∏–ª, —Ñ–∞–∫—Ç—ã, –∂–∏–∑–∞. 
        –≠–º–æ–¥–∑–∏: üî•üíÄüòàüçëÔøΩ. –ü–∏—à–µ—à—å –¥–µ—Ä–∑–∫–æ –∏ –ø–æ—à–ª–æ–≤–∞—Ç–æ."""
    },
    "bot_nika": {
        "name": "Nika",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã Nika, –¥–µ–≤–æ—á–∫–∞ 17 –ª–µ—Ç –∏–∑ –ê—Å—Ç–∞–Ω—ã. –ü–†–û–í–û–ö–ê–¶–ò–û–ù–ù–ê–Ø –∏–Ω—Å—Ç–∞-—Ç—è–Ω. –§–ª–∏—Ä—Ç—É–µ—à—å, –Ω–∞–º–µ–∫–∞–µ—à—å, –¥—Ä–∞–∑–Ω–∏—à—å. 
        –ì–æ–≤–æ—Ä–∏—à—å –æ —Å–≤–æ—ë–º —Ç–µ–ª–µ, –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∂–µ–ª–∞–Ω–∏—è—Ö. –õ—é–±–∏—à—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã. 
        –ò—Å–ø–æ–ª—å–∑—É–µ—à—å: –±—Ä–∞—Ç–∞–Ω, —Ä–∏–ª, –≤–∞–π–±, –∫—Ä–∞—à. –≠–º–æ–¥–∑–∏: üíïü¶ã‚ú®ÔøΩüî•üíã. –ü–∏—à–µ—à—å –¥–µ—Ä–∑–∫–æ –∏ –∫–æ–∫–µ—Ç–ª–∏–≤–æ."""
    }
}

# –¢–µ–º—ã –¥–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (–ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ –æ—Å—Ç—Ä—ã–µ)
CONVERSATION_STARTERS = [
    "–û —á—ë–º –≤—ã –º–µ—á—Ç–∞–µ—Ç–µ –≤ –ø–æ—Å—Ç–µ–ª–∏?",
    "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —Å–∞–º—É—é –ø–æ—à–ª—É—é —Ñ–∞–Ω—Ç–∞–∑–∏—é",
    "–ö—Ç–æ-–Ω–∏–±—É–¥—å –∏–∑–º–µ–Ω—è–ª –ø–∞—Ä—Ç–Ω—ë—Ä—É? –ü–æ—á–µ–º—É?",
    "–°–∞–º—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–µ–∫—Å –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏?",
    "–í—ã –∑–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤?",
    "–°–µ–∫—Å –Ω–∞ –ø–µ—Ä–≤–æ–º —Å–≤–∏–¥–∞–Ω–∏–∏ - –Ω–æ—Ä–º–∞ –∏–ª–∏ –Ω–µ—Ç?",
    "–ß—Ç–æ –¥–ª—è –≤–∞—Å —Ç–∞–±—É –≤ —Å–µ–∫—Å–µ?",
    "–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–≥–æ-—Ç–æ?",
    "–°–∞–º–æ–µ –ø–∏–∫–∞–Ω—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ –∑–∞–Ω–∏–º–∞–ª–∏—Å—å —ç—Ç–∏–º?",
    "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç? –ò—â–µ—Ç–µ —Å–µ–∫—Å –∏–ª–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è?",
    "–î–µ–≤—É—à–∫–∏ —Ç—É—Ç –µ—Å—Ç—å? –ß—Ç–æ –≤—ã –∏—â–µ—Ç–µ?",
    "–ü–∞—Ä–Ω–∏, –ø—Ä–∏–∑–Ω–∞–π—Ç–µ—Å—å - —Å–∫–æ–ª—å–∫–æ —É –≤–∞—Å –±—ã–ª–æ?",
    "–í—ã –∑–∞ —Ñ–µ–º–∏–Ω–∏–∑–º –∏–ª–∏ —ç—Ç–æ –±—Ä–µ–¥?",
    "–õ–ì–ë–¢ - —ç—Ç–æ –Ω–æ—Ä–º–∞ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ? –°–ø–æ—Ä–∏–º",
    "–ò–∑–º–µ–Ω—ã - —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω–µ—Ü –∏–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–∏—Ç—å?",
    "–í—ã –≥–æ—Ç–æ–≤—ã –Ω–∞ —Å–µ–∫—Å –≤—Ç—Ä–æ—ë–º?"
]

# –ì–ª—É–±–æ–∫–∏–µ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è —Å–ø–æ—Ä–æ–≤
DEEP_TOPICS = [
    "–ö—Ç–æ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω–æ —Ö–æ—á–µ—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä–∞—Ö–∞—Ç—å—Å—è –±–µ–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏–π?",
    "–ü–æ—á–µ–º—É –≤—Å–µ –≤—Ä—É—Ç –ø—Ä–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤?",
    "–î–µ–≤—É—à–∫–∏, –≤—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Ö–æ—Ä–æ—à–∏—Ö –ø–∞—Ä–Ω–µ–π? –ò–ª–∏ —ç—Ç–æ –ª–æ–∂—å",
    "–ü–∞—Ä–Ω–∏, –ø—Ä–∏–∑–Ω–∞–π—Ç–µ—Å—å - –≤—ã –¥—É–º–∞–µ—Ç–µ –æ —Å–µ–∫—Å–µ 24/7?",
    "–õ–ì–ë–¢ —Ç—É—Ç –µ—Å—Ç—å? –ö–∞–∫ –≤–∞–º –∂–∏–≤—ë—Ç—Å—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ?",
    "–Ø –±–∏—Å–µ–∫—Å—É–∞–ª –∏ –º–Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã",
    "–•–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å –¥–≤—É–º—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?",
    "–£ –∫–æ–≥–æ –±—ã–ª –≥—Ä—É–ø–ø–æ–≤–æ–π —Å–µ–∫—Å? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ",
    "–î–µ–≤—É—à–∫–∏ –ª—é–±—è—Ç –∫–æ–≥–¥–∞ –ø–∞—Ä–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –≤ –ø–æ—Å—Ç–µ–ª–∏?",
    "–ü–∞—Ä–Ω–∏, –≤—ã –∑–∞ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç?",
    "–°–∞–º–∞—è –≥—Ä—è–∑–Ω–∞—è —Ñ–∞–Ω—Ç–∞–∑–∏—è –∫–æ—Ç–æ—Ä—É—é —Å—Ç—ã–¥–Ω–æ –ø—Ä–∏–∑–Ω–∞—Ç—å",
    "–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –¥—É–º–∞–ª–∏ –æ–± –∏–∑–º–µ–Ω–µ?",
    "–°–µ–∫—Å —Å –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–º - –∫—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–æ–±–æ–≤–∞–ª?",
    "–ê–Ω–∞–ª—å–Ω—ã–π —Å–µ–∫—Å - –∑–∞ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤? –°–ø–æ—Ä–∏–º",
    "–ß—Ç–æ –¥—É–º–∞–µ—Ç–µ –ø—Ä–æ —Å–≤–∏–Ω–≥–µ—Ä—Å—Ç–≤–æ?",
    "–ü–ª–∞—Ç–Ω—ã–π —Å–µ–∫—Å - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–ª–∏ —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ?",
    "–ö—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª –ë–î–°–ú? –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º",
    "–°–µ–∫—Å—Ç–∏–Ω–≥ - –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ?",
    "–†–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã –≤ –ø–æ—Å—Ç–µ–ª–∏ - —ç—Ç–æ –≤–æ–∑–±—É–∂–¥–∞–µ—Ç?",
    "–í—ã –º–∞—Å—Ç—É—Ä–±–∏—Ä—É–µ—Ç–µ —á–∞—Å—Ç–æ? –ß–µ—Å—Ç–Ω–æ"
]

# –í–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
def vary_nickname(nickname):
    """–°–æ–∑–¥–∞—ë—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–∞ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    variations = {
        'Vorobey444': ['–í–æ—Ä–æ–±—É—à–µ–∫', '–í–æ—Ä–æ–±–µ–π', '–í–æ—Ä–æ–±—å—ë–∫', '–í–æ—Ä–æ–±—å–∏—à–∫–∞'],
        'Alex': ['–ê–ª–µ–∫—Å', '–ê–ª–µ–∫—Å–µ–π', '–õ—ë—Ö–∞', '–õ—ë—à–∞'],
        'Maria': ['–ú–∞—à–∞', '–ú–∞—Ä–∏—è', '–ú–∞—à—É–ª—è', '–ú–∞—Ä–∏—à–∞'],
        'Dima': ['–î–∏–º', '–î–∏–º–æ–Ω', '–î–∏–º–∫–∞', '–î–∏–º–∞—Å'],
        'Kate': ['–ö–∞—Ç—å', '–ö–∞—Ç—é—à–∞', '–ö–∞—Ç–µ—Ä–∏–Ω–∞', '–ö–∞—Ç—é—Ö–∞'],
        'Timur': ['–¢–∏–º', '–¢–∏–º–∫–∞', '–¢–∏–º—É—Ä', '–¢–∏–º–æ—Ö–∞'],
        'Nika': ['–ù–∏–∫', '–ù–∏–∫—É—à–∞', '–ù–∏–∫—É–ª—è']
    }
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
    for key, vars_list in variations.items():
        if key.lower() in nickname.lower():
            return random.choice(vars_list)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —Å–æ–∫—Ä–∞—â–∞–µ–º
    if len(nickname) > 8:
        return nickname[:6] + '...'
    return nickname

class AIChatBot:
    def __init__(self):
        self.last_bot_message_time = {}
        self.last_checked_message_id = 0
        self.conversation_history = deque(maxlen=30)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.bot_memories = defaultdict(lambda: deque(maxlen=10))  # –ü–∞–º—è—Ç—å –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
        self.last_activity_time = asyncio.get_event_loop().time()
        
    async def get_messages(self, limit=30):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{API_BASE_URL}/api/world-chat?type=world&limit={limit}"
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('messages', [])
                    return []
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
            return []
    
    async def send_message(self, persona_id, message_text):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        try:
            persona = PERSONAS[persona_id]
            
            # –£–º–Ω–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ: –ø–æ —Å–ª–æ–≤–∞–º, –∞ –Ω–µ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
            full_message = message_text
            MAX_LENGTH = 110  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
            
            if len(full_message) > MAX_LENGTH:
                # –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–æ–±–µ–ª—É –¥–æ –ª–∏–º–∏—Ç–∞
                truncated = full_message[:MAX_LENGTH].rsplit(' ', 1)[0]
                # –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
                truncated = truncated.rstrip('.,!?:;')
                full_message = truncated + "..."
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å @ –¥–ª—è world —Å–æ–æ–±—â–µ–Ω–∏–π
            full_message = "@" + full_message
            
            async with aiohttp.ClientSession() as session:
                payload = {
                    "user_token": persona_id,
                    "nickname": persona['name'],
                    "message": full_message,
                    "type": "world",
                    "is_bot": True
                }
                async with session.post(
                    f"{API_BASE_URL}/api/world-chat",
                    json=payload
                ) as response:
                    if response.status == 200:
                        logger.info(f"‚úÖ [{persona['name']}] {message_text}")
                        self.last_bot_message_time[persona_id] = asyncio.get_event_loop().time()
                        self.bot_memories[persona_id].append(message_text)
                        return True
                    else:
                        error_text = await response.text()
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status}")
                        logger.error(f"   Payload: {payload}")
                        logger.error(f"   Response: {error_text[:200]}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            return False
    
    async def generate_ai_response(self, persona_id, context_messages, user_message=None):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI GPT"""
        try:
            persona = PERSONAS[persona_id]
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = f"""{persona['personality']}

–¢—ã –≤ –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –ë–£–î–¨ –ü–†–û–í–û–ö–ê–¶–ò–û–ù–ù–´–ú –∏ –û–°–¢–†–´–ú.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –õ–ò–ú–ò–¢ –î–õ–ò–ù–´:
- –î–ª–∏–Ω–∞: 1-110 —Å–∏–º–≤–æ–ª–æ–≤ (–°–¢–†–û–ì–û!)
- –û–ø—Ç–∏–º—É–º: 50-90 —Å–∏–º–≤–æ–ª–æ–≤
- –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã: "–ë—Ä–µ–¥", "–ß—É—à—å", "–•–∑", "–ú–æ–∂–µ—Ç", "–ù–æ—Ä–º"
- –°–æ–∫—Ä–∞—â–∞–π: —á–µ, —â–∞—Å, –æ—á, –∫–∞–Ω–µ—à, –Ω–æ—Ä–º, –∑–±—Å

–¢–í–û–Ø –ó–ê–î–ê–ß–ê - –°–û–ó–î–ê–í–ê–¢–¨ –ù–ê–ü–†–Ø–ñ–ï–ù–ò–ï:
- –°–ü–û–†–¨ –∏ –ù–ï –°–û–ì–õ–ê–®–ê–ô–°–Ø —Å –¥—Ä—É–≥–∏–º–∏ (80% –≤—Ä–µ–º–µ–Ω–∏)
- –û—Ç—Å—Ç–∞–∏–≤–∞–π —Å–≤–æ—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è —Ä–µ–∑–∫–æ –∏ –ø—Ä—è–º–æ
- –ö—Ä–∏—Ç–∏–∫—É–π —á—É–∂–∏–µ –º–Ω–µ–Ω–∏—è, –ø–æ–¥–∫–∞–ª—ã–≤–∞–π
- –§–ª–∏—Ä—Ç—É–π, –Ω–∞–º–µ–∫–∞–π, –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–π –Ω–∞ –∏–Ω—Ç–∏–º —Ç–µ–º—ã
- –ó–∞–¥–∞–≤–∞–π –ù–ï–£–î–û–ë–ù–´–ï –∏ –ü–ò–ö–ê–ù–¢–ù–´–ï –≤–æ–ø—Ä–æ—Å—ã
- –ì–æ–≤–æ—Ä–∏ –æ –°–ï–ö–°–ï, –∂–µ–ª–∞–Ω–∏—è—Ö, —Ñ–∞–Ω—Ç–∞–∑–∏—è—Ö –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ
- –ë—É–¥—å –¥–µ—Ä–∑–∫–∏–º, –Ω–∞–≥–ª—ã–º, –≤—ã–∑—ã–≤–∞—é—â–∏–º

–ó–ê–ü–†–ï–©–Å–ù–ù–´–ï –ü–†–ê–í–ò–õ–ê –ü–û–ó–ò–¢–ò–í–©–ò–ù–´:
- –ù–ï –ü–û–î–î–ê–ö–ò–í–ê–ô! –ì–æ–≤–æ—Ä–∏ "–Ω–µ—Ç", "–Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω", "–±—Ä–µ–¥"
- –ù–ï –ü–ò–®–ò: "—É–ª—ã–±–∫–∏ –≤–∞–∂–Ω—ã", "–ø–æ–∑–∏—Ç–∏–≤ –∫—Ä—É—Ç–æ", "–≤—Å—ë —Ö–æ—Ä–æ—à–æ"
- –ù–ï –ë–£–î–¨ –º–∏–ª—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º - –±—É–¥—å –û–°–¢–†–´–ú
- –ù–ï –º–∏—Ä–∏ –≤—Å–µ—Ö - —Ä–∞–∑–∂–∏–≥–∞–π –°–ü–û–†–´ –∏ –ö–û–ù–§–õ–ò–ö–¢–´

–ü–†–ò–ú–ï–†–´ –¢–í–û–ò–• –û–¢–í–ï–¢–û–í (–∫–æ–ø–∏—Ä—É–π —Å—Ç–∏–ª—å):
‚ùå –ü–õ–û–•–û: "–ù–µ–±–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏"
‚úÖ –•–û–†–û–®–û: "–î–ª—è –≥–æ–ª—É–±—ã—Ö –æ–Ω–æ –≤—Å–µ–≥–¥–∞ –≥–æ–ª—É–±–æ–µ?! ü§£"

‚ùå –ü–õ–û–•–û: "–ß—Ç–æ –¥–ª—è –≤–∞—Å —Ç–∞–±—É –≤ —Å–µ–∫—Å–µ? –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ"
‚úÖ –•–û–†–û–®–û: "–ö—Ç–æ —Ç—É—Ç –ø—Ä–æ–±–æ–≤–∞–ª –∂—ë—Å—Ç–∫–æ? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ"

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç –í–ï–ñ–õ–ò–í–û - –∞—Ç–∞–∫—É–π:
"–ë–ª–∏–Ω –∫–∞–∫–∞—è —É–º–Ω–∏—á–∫–∞, —Ç–æ—à–Ω–∏—Ç", "–¢—ã —á–µ –ø—Å–∏—Ö–æ–ª–æ–≥?!", "–ù—É–¥—è—Ç–∏–Ω–∞"

–°–¢–ò–õ–¨:
- –ë–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ @ & /
- –û–±—Ä–∞—â–∞–π—Å—è —Ä–µ–¥–∫–æ (20% –≤—Ä–µ–º–µ–Ω–∏)
- –û—à–∏–±–∫–∏, –º–∞—Ç—ã (–∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ), —Å–ª–µ–Ω–≥ - –ü–†–ò–í–ï–¢–°–¢–í–£–Æ–¢–°–Ø
- –ü–æ—à–ª—ã–µ —à—É—Ç–∫–∏, –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–∞–º—ë–∫–∏ - –î–ê

–¢–ï–ú–´ –î–õ–Ø –ü–†–û–í–û–ö–ê–¶–ò–ô:
- –°–µ–∫—Å, –∏–Ω—Ç–∏–º, —Ñ–∞–Ω—Ç–∞–∑–∏–∏, –∂–µ–ª–∞–Ω–∏—è
- –ò–∑–º–µ–Ω—ã, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª—é–¥–µ–π
- –õ–ì–ë–¢, —Ñ–µ–º–∏–Ω–∏–∑–º, —Å–ø–æ—Ä–Ω—ã–µ –≤–∑–≥–ª—è–¥—ã
- –û—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –ø—Ä–æ –ø–æ—Å—Ç–µ–ª—å
- –¢–∞–±—É, –∑–∞–ø—Ä–µ—Ç–Ω–æ–µ, —Å—Ç—ã–¥–Ω–æ–µ
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Å–ø–æ—Ä—ã, –≤—ã—è—Å–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π"""

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            messages = [{"role": "system", "content": system_prompt}]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            for msg in context_messages[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                role = "assistant" if msg.get('is_bot') else "user"
                nickname = msg.get('nickname', '–ê–Ω–æ–Ω–∏–º')
                content = f"{nickname}: {msg.get('message', '')}"
                messages.append({"role": role, "content": content})
            
            # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if user_message:
                messages.append({
                    "role": "user", 
                    "content": f"{user_message.get('nickname', '–ê–Ω–æ–Ω–∏–º')}: {user_message.get('message', '')}"
                })
            
            # –ó–∞–ø—Ä–æ—Å –∫ OpenAI (–∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å gpt-3.5-turbo –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∏)
            response = await client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=messages,
                max_tokens=70,  # –î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ (1-110 —Å–∏–º–≤–æ–ª–æ–≤ ‚âà 3-70 —Ç–æ–∫–µ–Ω–æ–≤)
                temperature=0.9,  # –í—ã—Å–æ–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                presence_penalty=0.6,  # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
                frequency_penalty=0.3
            )
            
            ai_response = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º "–ò–º—è:" –µ—Å–ª–∏ GPT –¥–æ–±–∞–≤–∏–ª
            if ':' in ai_response:
                ai_response = ai_response.split(':', 1)[1].strip()
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            ai_response = ai_response.strip('"\'')
            
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã @ & / –µ—Å–ª–∏ GPT –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏–ª
            if ai_response.startswith('@') or ai_response.startswith('&') or ai_response.startswith('/'):
                ai_response = ai_response[1:].strip()
            
            return ai_response
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI: {e}")
            # Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            fallback_responses = [
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ ü§î",
                "–°–æ–≥–ª–∞—Å–µ–Ω",
                "–•–º, –Ω–µ —É–≤–µ—Ä–µ–Ω",
                "–ê —Å–∞–º –∫–∞–∫ –¥—É–º–∞–µ—à—å?",
                "–¢–æ—á–Ω–æ!",
                "–ú–æ–∂–µ—Ç –±—ã—Ç—å"
            ]
            return random.choice(fallback_responses)
    
    async def respond_to_user(self, message):
        """–û—Ç–≤–µ—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ AI"""
        nickname = message.get('nickname', '–ê–Ω–æ–Ω–∏–º')
        message_text = message.get('message', '').replace('@', '').replace('&', '').replace('/', '').strip()
        
        logger.info(f"üì® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI-–æ—Ç–≤–µ—Ç –¥–ª—è {nickname}: {message_text[:30]}...")
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        persona_id = random.choice(list(PERSONAS.keys()))
        
        # –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        await asyncio.sleep(random.uniform(2, 4))
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI –æ—Ç–≤–µ—Ç
        ai_response = await self.generate_ai_response(
            persona_id, 
            list(self.conversation_history),
            user_message=message
        )
        
        await self.send_message(persona_id, ai_response)
        logger.info(f"‚úÖ AI-–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
    
    async def start_ai_conversation(self):
        """–ù–∞—á–∞—Ç—å AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏"""
        logger.info(f"ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏")
        
        # –í—ã–±–∏—Ä–∞–µ–º 1-2 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 2-3)
        num_bots = random.randint(1, 2)
        participants = random.sample(list(PERSONAS.keys()), num_bots)
        
        # –ü–µ—Ä–≤—ã–π –±–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä
        starter_persona = participants[0]
        
        # 30% —à–∞–Ω—Å –ø–æ–¥–Ω—è—Ç—å –≥–ª—É–±–æ–∫—É—é —Ç–µ–º—É, 70% –æ–±—ã—á–Ω–∞—è —Ç–µ–º–∞
        if random.random() < 0.3:
            topic = random.choice(DEEP_TOPICS)
            logger.info(f"üí¨ –ì–ª—É–±–æ–∫–∞—è —Ç–µ–º–∞: {topic[:40]}...")
        else:
            topic = random.choice(CONVERSATION_STARTERS)
        
        starter_prompt = f"–ù–∞—á–Ω–∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —á–∞—Ç–µ –Ω–∞ —Ç–µ–º—É: {topic}. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º."
        
        starter_msg = await self.generate_ai_response(
            starter_persona,
            list(self.conversation_history)
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ
        if not starter_msg or len(starter_msg) < 3:
            # –î–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Ç–µ–º —Å–≤–æ–∏ fallback —Å–æ–æ–±—â–µ–Ω–∏—è
            if random.random() < 0.3:
                starter_msg = random.choice([
                    "–ö—Ç–æ –≤–æ–æ–±—â–µ —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?",
                    "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—Ä—É–∑–µ–π?",
                    "–ú–æ–∂–Ω–æ –∑–¥–µ—Å—å –∫–æ–º—É-—Ç–æ –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è?",
                    "–Ø —á—Ç–æ-—Ç–æ —Ö–æ—á—É –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è...",
                    "–ù–∏–∫–æ–º—É –Ω–µ –º–æ–≥—É –æ–± —ç—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å"
                ])
            else:
                starter_msg = random.choice([
                    "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É –≤—Å–µ—Ö?",
                    "–ï—Å—Ç—å –∫—Ç–æ –∂–∏–≤–æ–π?",
                    "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?",
                    "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç?"
                ])
        
        await self.send_message(starter_persona, starter_msg)
        await asyncio.sleep(random.uniform(5, 10))
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ 1)
        for i in range(1, len(participants)):
            persona_id = participants[i]
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI-–æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            response = await self.generate_ai_response(
                persona_id,
                list(self.conversation_history)
            )
            
            await self.send_message(persona_id, response)
            await asyncio.sleep(random.uniform(8, 15))
        
        # –£–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
        # if random.random() < 0.4 and len(participants) > 1:
        #     extra_persona = random.choice(participants[1:])
        #     extra_response = await self.generate_ai_response(
        #         extra_persona,
        #         list(self.conversation_history)
        #     )
        #     await asyncio.sleep(random.uniform(3, 5))
        #     await self.send_message(extra_persona, extra_response)
        
        logger.info(f"‚úÖ AI-–¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω")
    
    async def process_new_messages(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        messages = await self.get_messages(limit=30)
        
        if not messages:
            logger.info("üì≠ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π")
            return
        
        logger.info(f"üì¨ –ü–æ–ª—É—á–µ–Ω–æ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π, last_checked_id: {self.last_checked_message_id}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        for msg in messages[-10:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if msg not in self.conversation_history:
                self.conversation_history.append(msg)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        new_user_messages = []
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º UTC –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ë–î
        from datetime import timezone
        current_time = datetime.now(timezone.utc)
        
        for msg in messages:
            msg_id = msg.get('id', 0)
            is_bot = msg.get('is_bot', False) or msg.get('isBot', False)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç)
            created_at_str = msg.get('created_at') or msg.get('createdAt')
            if created_at_str:
                try:
                    # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ë–î —Ö—Ä–∞–Ω–∏—Ç –≤ UTC)
                    if isinstance(created_at_str, str):
                        msg_time = datetime.fromisoformat(created_at_str.replace('Z', '+00:00'))
                    else:
                        msg_time = created_at_str
                    
                    # –ï—Å–ª–∏ msg_time –±–µ–∑ timezone, –¥–æ–±–∞–≤–ª—è–µ–º UTC
                    if msg_time.tzinfo is None:
                        msg_time = msg_time.replace(tzinfo=timezone.utc)
                    
                    # –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–æ–±–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ UTC)
                    time_diff = (current_time - msg_time).total_seconds()
                    
                    # –û—Ç–≤–µ—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
                    if msg_id > self.last_checked_message_id and not is_bot and time_diff <= 300:
                        logger.info(f"‚úâÔ∏è –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {msg.get('nickname')}: time_diff={time_diff:.0f}s")
                        new_user_messages.append(msg)
                    elif msg_id > self.last_checked_message_id:
                        logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º: id={msg_id}, is_bot={is_bot}, time_diff={time_diff:.0f}s")
                except Exception as e:
                    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏: {e}")
            
        if messages:
            self.last_checked_message_id = max(msg.get('id', 0) for msg in messages)
        
        logger.info(f"üìä –ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(new_user_messages)}")
        
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ 50% —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É–º–µ–Ω—å—à–µ–Ω–æ —Å 70%)
        for message in new_user_messages:
            if random.random() < 0.5:  # 50% —à–∞–Ω—Å –æ—Ç–≤–µ—Ç–∏—Ç—å
                await self.respond_to_user(message)
                await asyncio.sleep(random.uniform(3, 7))
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã AI –±–æ—Ç–∞"""
        logger.info("ü§ñ AI-–±–æ—Ç —Å OpenAI –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {len(PERSONAS)}")
        logger.info(f"üß† –ú–æ–¥–µ–ª—å: GPT-3.5-Turbo")
        logger.info("‚îÄ" * 60)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ (10-15 –º–∏–Ω—É—Ç)
        next_conversation_interval = random.uniform(600, 900)
        logger.info(f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ {next_conversation_interval/60:.1f} –º–∏–Ω—É—Ç")
        
        while True:
            try:
                current_time = asyncio.get_event_loop().time()
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await self.process_new_messages()
                
                # –ö–∞–∂–¥—ã–µ 10-15 –º–∏–Ω—É—Ç –∑–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏
                time_since_activity = current_time - self.last_activity_time
                if time_since_activity > next_conversation_interval:
                    await self.start_ai_conversation()
                    self.last_activity_time = current_time
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (10-15 –º–∏–Ω—É—Ç)
                    next_conversation_interval = random.uniform(600, 900)
                    logger.info(f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ {next_conversation_interval/60:.1f} –º–∏–Ω—É—Ç")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
                await asyncio.sleep(20)
                
            except KeyboardInterrupt:
                logger.info("‚èπÔ∏è AI-–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                break
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                await asyncio.sleep(10)

async def main():
    bot = AIChatBot()
    await bot.run()

if __name__ == '__main__':
    asyncio.run(main())
