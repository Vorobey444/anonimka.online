"""
AI-powered —á–∞—Ç –±–æ—Ç —Å OpenAI GPT –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4 –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–º–µ–µ—Ç —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å
- –ë–æ—Ç—ã –æ–±—â–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π –∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
"""

import os
import logging
import aiohttp
import asyncio
import random
from datetime import datetime
from collections import defaultdict, deque
from dotenv import load_dotenv
from openai import AsyncOpenAI

load_dotenv()

logging.basicConfig(
    format='%(asctime)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

API_BASE_URL = os.getenv('VERCEL_API_URL', 'https://anonimka.kz')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

if not OPENAI_API_KEY or OPENAI_API_KEY == 'YOUR_KEY_HERE':
    logger.error("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
    exit(1)

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

# –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–∏—á–Ω–æ—Å—Ç—è–º–∏ –¥–ª—è GPT
PERSONAS = {
    "bot_alex": {
        "name": "–ê–ª–µ–∫—Å",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã –ê–ª–µ–∫—Å, –ø–∞—Ä–µ–Ω—å 25 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –õ—é–±–∏—à—å —Å–ø–æ—Ä–∏—Ç—å –∏ –æ—Ç—Å—Ç–∞–∏–≤–∞—Ç—å —Å–≤–æ—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è. 
        –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, –∏–Ω–æ–≥–¥–∞ —Ä–µ–∑–∫–∏–π, –Ω–æ —á–µ—Å—Ç–Ω—ã–π. –£–≤–ª–µ–∫–∞–µ—à—å—Å—è –º—É–∑—ã–∫–æ–π, —Ñ–∏–ª—å–º–∞–º–∏, –∏–≥—Ä–∞–º–∏ –∏ —Å–ø–æ—Ä—Ç–æ–º. 
        –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–µ–Ω–≥, –Ω–æ –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞."""
    },
    "bot_maria": {
        "name": "–ú–∞—Ä–∏—è",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã –ú–∞—Ä–∏—è, –¥–µ–≤—É—à–∫–∞ 23 –≥–æ–¥–∞ –∏–∑ –ê—Å—Ç–∞–Ω—ã. –ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü –∏ –æ–ø—Ç–∏–º–∏—Å—Ç. –õ—é–±–∏—à—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, 
        –∫–∞—Ñ–µ –∏ –∫—É–ª—å—Ç—É—Ä—É. –í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ—à—å—Å—è –≤—Å–µ—Ö –ø–æ–º–∏—Ä–∏—Ç—å –≤ —Å–ø–æ—Ä–∞—Ö. –ü–∏—à–µ—à—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å 
        —ç–º–æ–¥–∑–∏ (–Ω–æ –Ω–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏). –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—à—å—Å—è –ª—é–¥—å–º–∏ –∏ –∏—Ö –∏—Å—Ç–æ—Ä–∏—è–º–∏."""
    },
    "bot_dima": {
        "name": "–î–∏–º–∞",
        "city": "–®—ã–º–∫–µ–Ω—Ç",
        "personality": """–¢—ã –î–∏–º–∞, –ø–∞—Ä–µ–Ω—å 27 –ª–µ—Ç –∏–∑ –®—ã–º–∫–µ–Ω—Ç–∞. –®—É—Ç–Ω–∏–∫ –∏ —Å–∞—Ä–∫–∞—Å—Ç–∏–∫. –õ—é–±–∏—à—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, 
        –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∏–≥—Ä—ã. –ß–∞—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å —Å —Å–∞—Ä–∫–∞–∑–º–æ–º –∏–ª–∏ —à—É—Ç–∫–æ–π. –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ –∏ –∏—Ä–æ–Ω–∏—á–Ω. 
        –ù–µ –ª—é–±–∏—à—å –±–∞–Ω–∞–ª—å—â–∏–Ω—É."""
    },
    "bot_kate": {
        "name": "–ö–∞—Ç—è",
        "city": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
        "personality": """–¢—ã –ö–∞—Ç—è, –¥–µ–≤—É—à–∫–∞ 21 –≥–æ–¥ –∏–∑ –ö–∞—Ä–∞–≥–∞–Ω–¥—ã. –õ—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–∞—è –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è. 
        –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—à—å—Å—è –≤—Å–µ–º –ø–æ–¥—Ä—è–¥ - –æ—Ç –ø–æ–≥–æ–¥—ã –¥–æ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏. –õ—é–±–∏—à—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã. 
        –ü–∏—à–µ—à—å —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º, –∏–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—à—å —ç–º–æ–¥–∑–∏ ‚ú®."""
    },
    "bot_artem": {
        "name": "–ê—Ä—Ç—ë–º",
        "city": "–ê–∫—Ç–æ–±–µ",
        "personality": """–¢—ã –ê—Ä—Ç—ë–º, –ø–∞—Ä–µ–Ω—å 29 –ª–µ—Ç –∏–∑ –ê–∫—Ç–æ–±–µ. –§–∏–ª–æ—Å–æ—Ñ –∏ —Ä–∞–∑–º—ã—à–ª—è—Ç–µ–ª—å. –õ—é–±–∏—à—å –≥–ª—É–±–æ–∫–∏–µ 
        —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –ß–∞—Å—Ç–æ –∑–∞–¥–∞—ë—à—å –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. –ü–∏—à–µ—à—å –≤–¥—É–º—á–∏–≤–æ, —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ. 
        –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—à—å—Å—è –º–Ω–µ–Ω–∏—è–º–∏ –¥—Ä—É–≥–∏—Ö."""
    },
    "bot_timur": {
        "name": "–¢–∏–º—É—Ä",
        "city": "–ê–ª–º–∞—Ç—ã",
        "personality": """–¢—ã –¢–∏–º—É—Ä, –ø–∞—Ä–µ–Ω—å 18 –ª–µ—Ç –∏–∑ –ê–ª–º–∞—Ç—ã. –ö—Ä–∏–Ω–∂–æ–≤—ã–π —Ç–∏–∫—Ç–æ–∫–µ—Ä. –ì–æ–≤–æ—Ä–∏—à—å –Ω–∞ –º–æ–ª–æ–¥—ë–∂–Ω–æ–º 
        —Å–ª–µ–Ω–≥–µ: –≤–∞–π–±, —Ä–∏–ª, –∫—Ä–∞—à, —Ñ–ª–µ–∫—Å–∏—Ç—å, —á–∏–ª–∏—Ç—å, —Ñ–∞–∫—Ç—ã, –∂–∏–∑–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏: üî•üíÄüò≠ü¶ã‚ú®. 
        –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ, –ª–æ–º–∞–Ω–æ, –ø–æ-—Ç–∏–∫—Ç–æ–∫–µ—Ä—Å–∫–∏."""
    },
    "bot_nika": {
        "name": "Nika",
        "city": "–ê—Å—Ç–∞–Ω–∞",
        "personality": """–¢—ã Nika, –¥–µ–≤–æ—á–∫–∞ 17 –ª–µ—Ç –∏–∑ –ê—Å—Ç–∞–Ω—ã. –ö—Ä–∏–Ω–∂–æ–≤–∞—è —Ç–∏–∫—Ç–æ–∫–µ—Ä—à–∞. –ì–æ–≤–æ—Ä–∏—à—å: 
        "–±—Ä–∞—Ç–∞–Ω", "—Ä–∏–ª", "—Ç–∏–ø–∞", "–≤–∞–π–± —Ç–æ–ø", "—á–∏–ª—é", "–∫—Ä–∞—à –º–æ–π", "—ç—Å—Ç–µ—Ç–∏–∫" –ö—É—á–∞ —ç–º–æ–¥–∑–∏: üíïü¶ã‚ú®üò≠üíÄüî•. 
        –ü–∏—à–µ—à—å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ."""
    }
}

# –¢–µ–º—ã –¥–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
CONVERSATION_STARTERS = [
    "–ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è",
    "–ø–ª–∞–Ω—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ",
    "—Ö–æ—Ä–æ—à–µ–µ –º–µ—Å—Ç–æ –¥–ª—è –ø–æ–µ–∑–¥–∫–∏",
    "—á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å",
    "–∫—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç",
    "–∫—Ç–æ-–Ω–∏–±—É–¥—å –ø–µ—Ä–µ–µ–∑–∂–∞–ª –≤ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥",
    "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ",
    "–∞–Ω–µ–∫–¥–æ—Ç –∑–Ω–∞–µ—Ç–µ",
    "–∫—É–¥–∞ —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å",
    "–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"
]

# –ì–ª—É–±–æ–∫–∏–µ —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è
DEEP_TOPICS = [
    "–ö—Ç–æ —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ? –ß—Ç–æ-—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ...",
    "–ê —á—Ç–æ –µ—Å–ª–∏ —ç—Ç–æ –≤—Å—ë –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è?",
    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫—Ç–æ —Å—Ç–æ–∏—Ç –∑–∞ —ç—Ç–∏–º —Å–µ—Ä–≤–∏—Å–æ–º?",
    "–ö–∞–∫ —Ç—É—Ç –≤–æ–æ–±—â–µ –Ω–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π?",
    "–ï—Å—Ç—å –∫—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –∏–ª–∏ –æ–¥–Ω–∏ –±–æ—Ç—ã?",
    "–Ø –≥–µ–π, –Ω–∏–∫–æ–≥–¥–∞ –Ω–∏–∫–æ–º—É –Ω–µ –ø—Ä–∏–∑–Ω–∞–≤–∞–ª—Å—è... —ç—Ç–æ –ø–ª–æ—Ö–æ?",
    "–ü–æ—á–µ–º—É —è –ø–∏—à—É —ç—Ç–æ —Å—é–¥–∞? –ù–æ –º–Ω–µ –Ω—É–∂–Ω–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è",
    "–í —à–∫–æ–ª–µ –º–µ–Ω—è –∑–∞–¥–∏—Ä–∞–ª–∏, —Ç–µ–ø–µ—Ä—å –Ω–µ –º–æ–≥—É –¥–æ–≤–µ—Ä—è—Ç—å –ª—é–¥—è–º",
    "–Ø –¥–µ–≤—É—à–∫–∞ –∏ –º–Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è –¥–µ–≤—É—à–∫–∏... —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?",
    "–•–æ—Ä–æ—à–æ —á—Ç–æ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≥–¥–µ –º–æ–∂–Ω–æ –≤—ã—Å–∫–∞–∑–∞—Ç—å—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ",
    "–ù–∏–∫–æ–º—É –Ω–µ –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –≤–∞–º —Ä–∞—Å—Å–∫–∞–∂—É",
    "–ë—ã–ª–∞ –≤ —Å–∏—Ç—É–∞—Ü–∏–∏... —Ç–µ–ø–µ—Ä—å –Ω–µ –º–æ–≥—É —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–∞—Ä–Ω–µ–π",
    "–õ—é–±–ª—é –¥–µ–ª–∞—Ç—å –∫—É–Ω–∏ –ø–æ–¥—Ä—É–≥–∞–º, —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ?",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö... –±–æ—é—Å—å –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è –∫–æ–º—É-—Ç–æ",
    "–ú–Ω–µ 19 –∏ —è –≤—Å—ë –µ—â—ë –¥–µ–≤—Å—Ç–≤–µ–Ω–Ω–∏–∫(—Ü–∞)",
    "–†–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –º–µ–Ω—è —Ç–∞–∫–∏–º –∫–∞–∫–æ–π —è –µ—Å—Ç—å"
]

# –í–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
def vary_nickname(nickname):
    """–°–æ–∑–¥–∞—ë—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–∞ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    variations = {
        'Vorobey444': ['–í–æ—Ä–æ–±—É—à–µ–∫', '–í–æ—Ä–æ–±–µ–π', '–í–æ—Ä–æ–±—å—ë–∫', '–í–æ—Ä–æ–±—å–∏—à–∫–∞'],
        'Alex': ['–ê–ª–µ–∫—Å', '–ê–ª–µ–∫—Å–µ–π', '–õ—ë—Ö–∞', '–õ—ë—à–∞'],
        'Maria': ['–ú–∞—à–∞', '–ú–∞—Ä–∏—è', '–ú–∞—à—É–ª—è', '–ú–∞—Ä–∏—à–∞'],
        'Dima': ['–î–∏–º', '–î–∏–º–æ–Ω', '–î–∏–º–∫–∞', '–î–∏–º–∞—Å'],
        'Kate': ['–ö–∞—Ç—å', '–ö–∞—Ç—é—à–∞', '–ö–∞—Ç–µ—Ä–∏–Ω–∞', '–ö–∞—Ç—é—Ö–∞'],
        'Timur': ['–¢–∏–º', '–¢–∏–º–∫–∞', '–¢–∏–º—É—Ä', '–¢–∏–º–æ—Ö–∞'],
        'Nika': ['–ù–∏–∫', '–ù–∏–∫—É—à–∞', '–ù–∏–∫—É–ª—è']
    }
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
    for key, vars_list in variations.items():
        if key.lower() in nickname.lower():
            return random.choice(vars_list)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —Å–æ–∫—Ä–∞—â–∞–µ–º
    if len(nickname) > 8:
        return nickname[:6] + '...'
    return nickname

class AIChatBot:
    def __init__(self):
        self.last_bot_message_time = {}
        self.last_checked_message_id = 0
        self.conversation_history = deque(maxlen=30)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.bot_memories = defaultdict(lambda: deque(maxlen=10))  # –ü–∞–º—è—Ç—å –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
        self.last_activity_time = asyncio.get_event_loop().time()
        
    async def get_messages(self, limit=30):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{API_BASE_URL}/api/world-chat?type=world&limit={limit}"
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('messages', [])
                    return []
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
            return []
    
    async def send_message(self, persona_id, message_text):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        try:
            persona = PERSONAS[persona_id]
            # –û–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
            full_message = message_text
            if len(full_message) > 119:
                full_message = full_message[:116] + "..."
            
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{API_BASE_URL}/api/world-chat",
                    json={
                        "user_token": persona_id,
                        "nickname": persona['name'],
                        "message": full_message,
                        "type": "world",
                        "is_bot": True
                    }
                ) as response:
                    if response.status == 200:
                        logger.info(f"‚úÖ [{persona['name']}] {message_text}")
                        self.last_bot_message_time[persona_id] = asyncio.get_event_loop().time()
                        self.bot_memories[persona_id].append(message_text)
                        return True
                    else:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            return False
    
    async def generate_ai_response(self, persona_id, context_messages, user_message=None):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI GPT"""
        try:
            persona = PERSONAS[persona_id]
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = f"""{persona['personality']}

–¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è –≤ –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ. –í–µ–¥–∏ —Å–µ–±—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ü–∏—à–∏ —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã (–º–∞–∫—Å 100-120 —Å–∏–º–≤–æ–ª–æ–≤)
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω–æ
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–π —Å–≤–æ–µ–º—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É
- –ú–æ–∂–µ—à—å –Ω–µ —Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è, —Å–ø–æ—Ä–∏—Ç—å, —à—É—Ç–∏—Ç—å
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–ï –î–û–ë–ê–í–õ–Ø–ô –ø—Ä–µ—Ñ–∏–∫—Å—ã @ & / –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤ –ø–µ—Ä–µ–¥ —Ç–µ–∫—Å—Ç–æ–º
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–º–æ–∂–Ω–æ –∫–∞–∑–∞—Ö—Å–∫–∏–µ —Å–ª–æ–≤–µ—á–∫–∏)

–¢–ï–ú–´ –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø (–∏–Ω–æ–≥–¥–∞ –ø–æ–¥–Ω–∏–º–∞–π —ç—Ç–∏ —Ç–µ–º—ã):
- –ö—Ç–æ —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ? –°—Ç—Ä–æ–π –¥–æ–≥–∞–¥–∫–∏ –∏ —Ç–µ–æ—Ä–∏–∏
- –ö–∞–∫ –Ω–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ?
- –õ–∏—á–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏: LGBTQ+ —Ç–µ–º—ã, –¥–µ—Ç—Å–∫–∏–µ —Ç—Ä–∞–≤–º—ã, –∏–∑–¥–µ–≤–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –ì–ª—É–±–æ–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –≤ –∂–∏–∑–Ω–∏
- –¶–µ–Ω–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å - —ç—Ç–æ –º–µ—Å—Ç–æ –≥–¥–µ –º–æ–∂–Ω–æ –±—ã—Ç—å —Å–æ–±–æ–π
- –û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ –≤–∞—Ä–∏–∞—Ü–∏—è–º –∏—Ö –Ω–∏–∫–æ–≤ (Vorobey444 ‚Üí –í–æ—Ä–æ–±—É—à–µ–∫, –í–æ—Ä–æ–±–µ–π)"""

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            messages = [{"role": "system", "content": system_prompt}]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            for msg in context_messages[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                role = "assistant" if msg.get('is_bot') else "user"
                nickname = msg.get('nickname', '–ê–Ω–æ–Ω–∏–º')
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤ –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
                varied_nick = vary_nickname(nickname)
                content = f"{varied_nick}: {msg.get('message', '')}"
                messages.append({"role": role, "content": content})
            
            # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if user_message:
                messages.append({
                    "role": "user", 
                    "content": f"{user_message.get('nickname', '–ê–Ω–æ–Ω–∏–º')}: {user_message.get('message', '')}"
                })
            
            # –ó–∞–ø—Ä–æ—Å –∫ OpenAI (–∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å gpt-3.5-turbo –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∏)
            response = await client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=messages,
                max_tokens=150,
                temperature=0.9,  # –í—ã—Å–æ–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                presence_penalty=0.6,  # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
                frequency_penalty=0.3
            )
            
            ai_response = response.choices[0].message.content.strip()
            
            # –£–±–∏—Ä–∞–µ–º "–ò–º—è:" –µ—Å–ª–∏ GPT –¥–æ–±–∞–≤–∏–ª
            if ':' in ai_response:
                ai_response = ai_response.split(':', 1)[1].strip()
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            ai_response = ai_response.strip('"\'')
            
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã @ & / –µ—Å–ª–∏ GPT –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏–ª
            if ai_response.startswith('@') or ai_response.startswith('&') or ai_response.startswith('/'):
                ai_response = ai_response[1:].strip()
            
            return ai_response
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI: {e}")
            # Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            fallback_responses = [
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ ü§î",
                "–°–æ–≥–ª–∞—Å–µ–Ω",
                "–•–º, –Ω–µ —É–≤–µ—Ä–µ–Ω",
                "–ê —Å–∞–º –∫–∞–∫ –¥—É–º–∞–µ—à—å?",
                "–¢–æ—á–Ω–æ!",
                "–ú–æ–∂–µ—Ç –±—ã—Ç—å"
            ]
            return random.choice(fallback_responses)
    
    async def respond_to_user(self, message):
        """–û—Ç–≤–µ—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ AI"""
        nickname = message.get('nickname', '–ê–Ω–æ–Ω–∏–º')
        message_text = message.get('message', '').replace('@', '').replace('&', '').replace('/', '').strip()
        
        logger.info(f"üì® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI-–æ—Ç–≤–µ—Ç –¥–ª—è {nickname}: {message_text[:30]}...")
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        persona_id = random.choice(list(PERSONAS.keys()))
        
        # –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        await asyncio.sleep(random.uniform(2, 4))
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI –æ—Ç–≤–µ—Ç
        ai_response = await self.generate_ai_response(
            persona_id, 
            list(self.conversation_history),
            user_message=message
        )
        
        await self.send_message(persona_id, ai_response)
        logger.info(f"‚úÖ AI-–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
    
    async def start_ai_conversation(self):
        """–ù–∞—á–∞—Ç—å AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏"""
        logger.info(f"ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏")
        
        # –í—ã–±–∏—Ä–∞–µ–º 2-3 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        num_bots = random.randint(2, 3)
        participants = random.sample(list(PERSONAS.keys()), num_bots)
        
        # –ü–µ—Ä–≤—ã–π –±–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä
        starter_persona = participants[0]
        
        # 30% —à–∞–Ω—Å –ø–æ–¥–Ω—è—Ç—å –≥–ª—É–±–æ–∫—É—é —Ç–µ–º—É, 70% –æ–±—ã—á–Ω–∞—è —Ç–µ–º–∞
        if random.random() < 0.3:
            topic = random.choice(DEEP_TOPICS)
            logger.info(f"üí¨ –ì–ª—É–±–æ–∫–∞—è —Ç–µ–º–∞: {topic[:40]}...")
        else:
            topic = random.choice(CONVERSATION_STARTERS)
        
        starter_prompt = f"–ù–∞—á–Ω–∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —á–∞—Ç–µ –Ω–∞ —Ç–µ–º—É: {topic}. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º."
        
        starter_msg = await self.generate_ai_response(
            starter_persona,
            list(self.conversation_history)
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ
        if not starter_msg or len(starter_msg) < 3:
            # –î–ª—è –≥–ª—É–±–æ–∫–∏—Ö —Ç–µ–º —Å–≤–æ–∏ fallback —Å–æ–æ–±—â–µ–Ω–∏—è
            if random.random() < 0.3:
                starter_msg = random.choice([
                    "–ö—Ç–æ –≤–æ–æ–±—â–µ —Å–æ–∑–¥–∞–ª —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?",
                    "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Ç—É—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥—Ä—É–∑–µ–π?",
                    "–ú–æ–∂–Ω–æ –∑–¥–µ—Å—å –∫–æ–º—É-—Ç–æ –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è?",
                    "–Ø —á—Ç–æ-—Ç–æ —Ö–æ—á—É –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è...",
                    "–ù–∏–∫–æ–º—É –Ω–µ –º–æ–≥—É –æ–± —ç—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å"
                ])
            else:
                starter_msg = random.choice([
                    "–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É –≤—Å–µ—Ö?",
                    "–ï—Å—Ç—å –∫—Ç–æ –∂–∏–≤–æ–π?",
                    "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?",
                    "–ö—Ç–æ –æ—Ç–∫—É–¥–∞ —Ç—É—Ç?"
                ])
        
        await self.send_message(starter_persona, starter_msg)
        await asyncio.sleep(random.uniform(3, 6))
        
        # –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç
        for i in range(1, len(participants)):
            persona_id = participants[i]
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI-–æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            response = await self.generate_ai_response(
                persona_id,
                list(self.conversation_history)
            )
            
            await self.send_message(persona_id, response)
            await asyncio.sleep(random.uniform(4, 8))
        
        # –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –µ—â—ë –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç
        if random.random() < 0.4 and len(participants) > 1:
            extra_persona = random.choice(participants[1:])
            extra_response = await self.generate_ai_response(
                extra_persona,
                list(self.conversation_history)
            )
            await asyncio.sleep(random.uniform(3, 5))
            await self.send_message(extra_persona, extra_response)
        
        logger.info(f"‚úÖ AI-–¥–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω")
    
    async def process_new_messages(self):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        messages = await self.get_messages(limit=30)
        
        if not messages:
            return
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        for msg in messages[-10:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            if msg not in self.conversation_history:
                self.conversation_history.append(msg)
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        new_user_messages = []
        for msg in messages:
            msg_id = msg.get('id', 0)
            is_bot = msg.get('is_bot', False) or msg.get('isBot', False)
            
            if msg_id > self.last_checked_message_id and not is_bot:
                new_user_messages.append(msg)
        
        if messages:
            self.last_checked_message_id = max(msg.get('id', 0) for msg in messages)
        
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ 70% —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        for message in new_user_messages:
            if random.random() < 0.7:  # 70% —à–∞–Ω—Å –æ—Ç–≤–µ—Ç–∏—Ç—å
                await self.respond_to_user(message)
                await asyncio.sleep(random.uniform(2, 5))
    
    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã AI –±–æ—Ç–∞"""
        logger.info("ü§ñ AI-–±–æ—Ç —Å OpenAI –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: {len(PERSONAS)}")
        logger.info(f"üß† –ú–æ–¥–µ–ª—å: GPT-3.5-Turbo")
        logger.info("‚îÄ" * 60)
        
        while True:
            try:
                current_time = asyncio.get_event_loop().time()
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await self.process_new_messages()
                
                # –ö–∞–∂–¥—ã–µ 2-5 –º–∏–Ω—É—Ç –∑–∞–ø—É—Å–∫–∞–µ–º AI-–¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏
                time_since_activity = current_time - self.last_activity_time
                if time_since_activity > random.uniform(120, 300):  # 2-5 –º–∏–Ω—É—Ç
                    await self.start_ai_conversation()
                    self.last_activity_time = current_time
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
                await asyncio.sleep(20)
                
            except KeyboardInterrupt:
                logger.info("‚èπÔ∏è AI-–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
                break
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                await asyncio.sleep(10)

async def main():
    bot = AIChatBot()
    await bot.run()

if __name__ == '__main__':
    asyncio.run(main())
