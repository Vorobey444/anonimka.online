# 🎨 Визуальная схема работы анонимных чатов

## 📊 Диаграмма потока

```
┌─────────────────────────────────────────────────────────────────┐
│                    СОЗДАНИЕ АНОНИМНОГО ЧАТА                     │
└─────────────────────────────────────────────────────────────────┘

   👤 User A                  🤖 BOT                  👤 User B
   (ID: 123)                                          (ID: 456)
      │                                                    │
      │  1. Открывает WebApp                              │
      │  ────────────────────>                            │
      │                                                    │
      │  2. Видит объявление User B                       │
      │     (Объявление #789)                             │
      │                                                    │
      │  3. Нажимает "Написать"                           │
      │  ────────────────────>                            │
      │                         │                          │
      │  4. Callback:           │                          │
      │     start_chat_789_456  │                          │
      │  ────────────────────> │                          │
      │                         │                          │
      │                         │  5. Создает chat_id     │
      │                         │     "123_456_789"       │
      │                         │                          │
      │                         │  6. Сохраняет связь:    │
      │                         │     User A <-> User B   │
      │                         │                          │
      │  7. "✅ Чат создан!"    │                          │
      │  <──────────────────── │                          │
      │                         │                          │
      │                         │  8. "💬 Новое сообщение"│
      │                         │  ───────────────────────>│
      │                                                    │


┌─────────────────────────────────────────────────────────────────┐
│                   ОБМЕН СООБЩЕНИЯМИ (1 ЧАТ)                     │
└─────────────────────────────────────────────────────────────────┘

   👤 User A                  🤖 BOT                  👤 User B
      │                                                    │
      │  "Привет!"                                         │
      │  ────────────────────>                            │
      │                         │                          │
      │                         │  Проверяет:             │
      │                         │  - User A имеет 1 чат   │
      │                         │  - Получатель: User B   │
      │                         │                          │
      │                         │  "💬 Анонимное сообщение"│
      │                         │  "Привет!"              │
      │                         │  ───────────────────────>│
      │                         │                          │
      │  "✅ Сообщение          │                          │
      │     отправлено!"        │                          │
      │  <──────────────────── │                          │
      │                                                    │


┌─────────────────────────────────────────────────────────────────┐
│                ОБМЕН СООБЩЕНИЯМИ (НЕСКОЛЬКО ЧАТОВ)              │
└─────────────────────────────────────────────────────────────────┘

   👤 User A                  🤖 BOT                👤 User B + C
      │                                              (456 + 789)
      │  "Доброе утро!"                                   │
      │  ────────────────────>                            │
      │                         │                          │
      │                         │  Проверяет:             │
      │                         │  - User A имеет 2 чата  │
      │                         │                          │
      │  Кнопки выбора:         │                          │
      │  [Чат с объявл. #1]     │                          │
      │  [Чат с объявл. #2]     │                          │
      │  <──────────────────── │                          │
      │                         │                          │
      │  Нажимает кнопку 1      │                          │
      │  (sendto_chat_id_1)     │                          │
      │  ────────────────────> │                          │
      │                         │                          │
      │                         │  "💬 Анонимное сообщение"│
      │                         │  "Доброе утро!"         │
      │                         │  ───────────────────────>│
      │                         │                   👤 User B
      │  "✅ Отправлено!"        │                          │
      │  <──────────────────── │                          │
      │                                                    │


┌─────────────────────────────────────────────────────────────────┐
│                      ЗАВЕРШЕНИЕ ЧАТА                            │
└─────────────────────────────────────────────────────────────────┘

   👤 User A                  🤖 BOT                  👤 User B
      │                                                    │
      │  /endchat                                          │
      │  ────────────────────>                            │
      │                         │                          │
      │                         │  Если несколько:        │
      │  Кнопки выбора:         │  Показывает список      │
      │  [Завершить чат #1]     │                          │
      │  [Завершить чат #2]     │                          │
      │  <──────────────────── │                          │
      │                         │                          │
      │  Нажимает кнопку 1      │                          │
      │  (endchat_chat_id_1)    │                          │
      │  ────────────────────> │                          │
      │                         │                          │
      │                         │  Помечает неактивным:   │
      │                         │  active = False         │
      │                         │                          │
      │  "💔 Чат завершен"      │                          │
      │  <──────────────────── │                          │
      │                         │                          │
      │                         │  "💔 Чат завершен       │
      │                         │      собеседником"      │
      │                         │  ───────────────────────>│
      │                                                    │
```

## 🗄️ Структура хранения

```
context.bot_data = {
    'user_chats': {
        123: {                           # User A
            '123_456_789': {
                'other_user': 456,       # User B
                'ad_id': '789',
                'active': True,
                'created_at': '2025-11-01T10:00:00'
            },
            '123_789_101': {
                'other_user': 789,       # User C
                'ad_id': '101',
                'active': True,
                'created_at': '2025-11-01T11:00:00'
            }
        },
        456: {                           # User B
            '123_456_789': {
                'other_user': 123,       # User A
                'ad_id': '789',
                'active': True,
                'created_at': '2025-11-01T10:00:00'
            }
        }
    },
    'pending_messages': {                # Временное хранилище
        123: "Доброе утро!"              # Ожидает выбора чата
    }
}
```

## 🎯 Callback команды

```
┌──────────────────────────────────────────────────────────┐
│  start_chat_{ad_id}_{author_tg_id}                      │
│  Пример: start_chat_789_456                              │
│  Создает чат между текущим пользователем и автором      │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  sendto_{chat_id}                                        │
│  Пример: sendto_123_456_789                              │
│  Отправляет pending сообщение в выбранный чат           │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  endchat_{chat_id}                                       │
│  Пример: endchat_123_456_789                             │
│  Завершает указанный чат                                 │
└──────────────────────────────────────────────────────────┘
```

## 📱 Пользовательский опыт

### Сценарий 1: Первый чат
```
1. User A: /start
   Bot: "🌟 Добро пожаловать! [🚀 Открыть приложение]"

2. User A открывает WebApp, видит объявление, нажимает "Написать"

3. Bot → User A: "✅ Чат создан! Отправьте сообщение."
   Bot → User B: "💬 Новое сообщение по объявлению #789!"

4. User A: "Привет!"
   Bot → User B: "💬 Анонимное сообщение: Привет!"

5. User B: "Здравствуйте!"
   Bot → User A: "💬 Анонимное сообщение: Здравствуйте!"
```

### Сценарий 2: Множественные чаты
```
1. User A уже имеет 2 активных чата

2. User A: "Доброе утро!"
   Bot: "💬 Кому отправить сообщение?
         [Отправить в чат по объявлению #789]
         [Отправить в чат по объявлению #101]"

3. User A нажимает первую кнопку

4. Bot → User B: "💬 Анонимное сообщение (объявление #789): Доброе утро!"
   Bot → User A: "✅ Сообщение отправлено!"
```

### Сценарий 3: Завершение чата
```
1. User A: /endchat
   Bot: "Какой чат завершить?
         [Завершить чат по объявлению #789]
         [Завершить чат по объявлению #101]"

2. User A выбирает первый

3. Bot → User A: "💔 Чат по объявлению #789 завершен"
   Bot → User B: "💔 Чат по объявлению #789 завершен собеседником"
```

## 🔐 Анонимность

```
┌───────────────────────────────────────────────────┐
│  User A видит:                                     │
│  - "💬 Анонимное сообщение (объявление #789)"      │
│  - Содержимое сообщения                            │
│  - НЕ ВИДИТ: Telegram ID, имя, username User B    │
└───────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────┐
│  User B видит:                                     │
│  - "💬 Анонимное сообщение (объявление #789)"      │
│  - Содержимое сообщения                            │
│  - НЕ ВИДИТ: Telegram ID, имя, username User A    │
└───────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────┐
│  Бот знает:                                        │
│  - ID обоих пользователей                          │
│  - Связь между ними через chat_id                  │
│  - НО: Никогда не раскрывает эту информацию!       │
└───────────────────────────────────────────────────┘
```
