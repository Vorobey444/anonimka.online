"""
–£–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –±–æ—Ç–æ–≤
–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å - —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–ª–∏—Ç—å—Å—è!
"""

import random
from datetime import datetime

class SmartResponseGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
    
    def __init__(self):
        self.conversation_history = {}
        self.last_topics = []
        
    # ============ –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø ============
    
    GREETINGS = {
        "casual": [
            "–ô–æ—É! –ö–∞–∫ –¥–µ–ª–∞?",
            "–ó–¥–∞—Ä–æ–≤–∞!",
            "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç!",
            "–•—ç–π! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            "–°–∞–ª—é—Ç!",
            "–ö—É!",
            "–î–∞—Ä–æ–≤–∞!",
        ],
        "friendly": [
            "–ü—Ä–∏–≤–µ—Ç! üëã –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?",
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –†–∞–¥–∞ –≤–∏–¥–µ—Ç—å!",
            "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! ü§ó",
            "–•–∞–π! –ö–∞–∫ –¥–µ–ª–∞?",
            "–ü—Ä–∏–≤–µ—Ç–∏–∫!",
            "–ó–¥–∞—Ä–æ–≤–∞! –î–∞–≤–Ω–æ –Ω–µ –≤–∏–¥–µ–ª–∏—Å—å)",
        ],
        "emoji": [
            "–ü—Ä–∏–≤–µ—Ç! üëãüòä",
            "–•–∞–π! ‚ú®",
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! üå∏",
            "–ô–æ—É! üî•",
            "–°–∞–ª—é—Ç! üòé",
            "–ü—Ä–∏–≤–µ—Ç–∏–∫! üí´",
        ],
        "brief": [
            "–ü—Ä–∏–≤–µ—Ç",
            "–ó–¥–∞—Ä–æ–≤–∞",
            "–•–∞–π",
            "–ô–æ—É",
            "–ö—É",
        ],
        "questions": [
            "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
            "–ó–¥–∞—Ä–æ–≤–∞! –ß—Ç–æ –¥–µ–ª–∞–µ—à—å?",
            "–•–∞–π! –î–∞–≤–Ω–æ —Ç—É—Ç?",
            "–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
        ],
        "cringe": [  # üî• –ö–†–ò–ù–ñ –ú–ê–õ–û–õ–ï–¢–ö–ò üî•
            "–π–æ—É –±—Ä–∞—Ç–∞–Ω",
            "–¥–∞—Ä–æ–≤–∞ —á–µ–ª",
            "—Ö–∞–π –≤—Å–µ–º",
            "–≥–æ –æ–±—â–∞—Ç—å—Å—è",
            "–ø—Ä–∏–≤ —á–∞—Ç",
            "–∑–¥–∞—Ä–æ–≤–∞ –Ω–∞—Ä–æ–¥",
        ]
    }
    
    # ============ –í–û–ü–†–û–°–´ "–ö–ê–ö –î–ï–õ–ê?" ============
    
    HOW_ARE_YOU = {
        "positive": [
            "–û—Ç–ª–∏—á–Ω–æ! –ê —É —Ç–µ–±—è?",
            "–í—Å—ë —Å—É–ø–µ—Ä! –¢—ã –∫–∞–∫?",
            "–ù–æ—Ä–º, –æ–±—â–∞—é—Å—å —Ç—É—Ç üòä",
            "–•–æ—Ä–æ—à–æ! –ê —á—Ç–æ —É —Ç–µ–±—è?",
            "–ü–æ–π–¥—ë—Ç! –¢—ã –∫–∞–∫?",
            "–î–∞ –Ω–∏—á–µ–≥–æ, –∂–∏–≤—ë–º)",
            "–ù–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–µ –∂–∞–ª—É—é—Å—å",
        ],
        "neutral": [
            "–û–±—ã—á–Ω–æ. –¢—ã –∫–∞–∫?",
            "–¢–∞–∫ —Å–µ–±–µ, –Ω–æ –Ω–æ—Ä–º",
            "–ü–æ–π–¥—ë—Ç, –∞ —Ç—ã?",
            "–†–∞–±–æ—Ç–∞—é, —É—á—É—Å—å... –¢—ã –∫–∞–∫?",
            "–î–∞ –∫–∞–∫ –æ–±—ã—á–Ω–æ)",
        ],
        "with_question": [
            "–•–æ—Ä–æ—à–æ! –ê —Ç—ã —á–µ–º –∑–∞–Ω—è—Ç?",
            "–ù–æ—Ä–º! –ß—Ç–æ –¥–µ–ª–∞–µ—à—å?",
            "–û—Ç–ª–∏—á–Ω–æ! –û—Ç–∫—É–¥–∞ —Ç—ã?",
            "–ü–æ–π–¥—ë—Ç! –î–∞–≤–Ω–æ –≤ —á–∞—Ç–µ?",
        ],
        "cringe": [  # üî• –ö–†–ò–ù–ñ
            "–≤–∞–π–± —Ç–æ–ø –±—Ä–∞—Ç–∞–Ω",
            "—á–∏–ª—é, —Ç—ã –∫–∞–∫",
            "—Ä–∏–ª —Ö–æ—Ä–æ—à–æ",
            "–∂–∏–∑–∞ –Ω–æ—Ä–º",
            "–∫–∞–ø–µ—Ü –≤–∞—â–µ –∫–∞–π—Ñ",
        ]
    }
    
    # ============ –ü–û–î–î–ï–†–ñ–ö–ê ============
    
    SUPPORT = {
        "empathy": [
            "–ü–æ–Ω–∏–º–∞—é —Ç–µ–±—è...",
            "–î–µ—Ä–∂–∏—Å—å! üí™",
            "–í—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ!",
            "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –≤—Å—ë –Ω–∞–ª–∞–¥–∏—Ç—Å—è",
            "–ú—ã —Ä—è–¥–æ–º, –Ω–µ –≥—Ä—É—Å—Ç–∏",
            "–ë—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–µ —É –≤—Å–µ—Ö",
        ],
        "encourage": [
            "–ù–µ —Å–¥–∞–≤–∞–π—Å—è!",
            "–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!",
            "–í–µ—Ä—é –≤ —Ç–µ–±—è!",
            "–í—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è!",
            "–î–∞–≤–∞–π, –Ω–µ –æ–ø—É—Å–∫–∞–π —Ä—É–∫–∏!",
        ],
        "cringe": [  # üî• –ö–†–ò–ù–ñ
            "–∂–∏–∑–∞ –±—Ä–æ",
            "–ø–æ–Ω–∏–º–∞—é —Ä–∏–ª",
            "–¥–µ—Ä–∂–∏—Å—å —Ç–∞–ºü¶ã",
            "—Ñ–ª–µ–∫—Å –Ω–∞–¥–æ",
            "—Ö–∞–π–ø –±—É–¥–µ—Ç –Ω–æ—Ä–º",
        ],
        "offer_help": [
            "–ß–µ–º –ø–æ–º–æ—á—å?",
            "–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ",
            "–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?",
            "–•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?",
            "–°–ª—É—à–∞—é —Ç–µ–±—è",
        ]
    }
    
    # ============ –°–û–ì–õ–ê–°–ò–ï ============
    
    AGREEMENT = {
        "strong": [
            "–¢–æ—á–Ω–æ!",
            "–ê–±—Å–æ–ª—é—Ç–Ω–æ —Å–æ–≥–ª–∞—Å–µ–Ω!",
            "–î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫!",
            "100%!",
            "–ü—Ä–∞–≤–∏–ª—å–Ω–æ –≥–æ–≤–æ—Ä–∏—à—å!",
            "–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é!",
        ],
        "casual": [
            "–ê–≥–∞",
            "–î–∞",
            "–£–≥—É",
            "–¢–æ—á–Ω—è–∫",
            "+1",
            "üëç",
        ],
        "emoji": [
            "–î–∞! üíØ",
            "–¢–æ—á–Ω–æ! ‚ú®",
            "–°–æ–≥–ª–∞—Å–Ω–∞! üòä",
            "–ê–≥–∞! üëç",
            "+100! üî•",
        ],
        "cringe": [  # üî• –ö–†–ò–ù–ñ
            "—Ñ–∞–∫—Ç—ã –±—Ä–∞—Ç–∞–Ω",
            "—Ä–∏–ª —Ç–∞–∫",
            "–∂–∏–∑–∞üî•",
            "—Ç–æ–ø –º—ã—Å–ª—å",
            "–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ",
        ]
    }
    
    # ============ –ù–ï–°–û–ì–õ–ê–°–ò–ï ============
    
    DISAGREEMENT = {
        "soft": [
            "–•–º, –Ω–µ —É–≤–µ—Ä–µ–Ω...",
            "–ú–æ–∂–µ—Ç –±—ã—Ç—å...",
            "–ù–µ —Ñ–∞–∫—Ç",
            "–°–æ–º–Ω–µ–≤–∞—é—Å—å",
            "–ù–µ –∑–Ω–∞—é, —á–µ—Å—Ç–Ω–æ",
        ],
        "polite": [
            "–£ –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ—ë –º–Ω–µ–Ω–∏–µ)",
            "–ü–æ–Ω–∏–º–∞—é, –Ω–æ —è –¥—É–º–∞—é –∏–Ω–∞—á–µ",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è",
            "–ú–æ–∂–µ—Ç –∏ —Ç–∞–∫",
        ],
        "direct": [
            "–ù–µ—Ç",
            "–ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω",
            "–°–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ",
            "–í—Ä—è–¥ –ª–∏",
        ],
        "cringe": [  # üî• –ö–†–ò–ù–ñ
            "–∫—Ä–∏–Ω–∂ –±—Ä–æ",
            "–Ω–µ –∑–∞—à–ª–æ",
            "–Ω–µ –∫–∞–Ω–∞–µ—Ç",
            "–Ω–∏–∑–∫–æ–≤–∞–π–±–æ–≤–æ",
            "–∫–∞–ø –±—Ä–∞—Ç–∞–Ω",
        ]
    }
    
    # ============ –í–û–ü–†–û–°–´ ============
    
    QUESTIONS = {
        "about_person": [
            "–û—Ç–∫—É–¥–∞ —Ç—ã?",
            "–î–∞–≤–Ω–æ —Ç—É—Ç?",
            "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?",
            "–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è?",
            "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?",
        ],
        "about_topic": [
            "–ê —Ç—ã —á—Ç–æ –¥—É–º–∞–µ—à—å?",
            "–ö–∞–∫–æ–µ —Ç–≤–æ—ë –º–Ω–µ–Ω–∏–µ?",
            "–¢—ã –∫–∞–∫ –∫ —ç—Ç–æ–º—É –æ—Ç–Ω–æ—Å–∏—à—å—Å—è?",
            "–ß—Ç–æ —Å–∫–∞–∂–µ—à—å?",
        ],
        "general": [
            "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            "–ß—Ç–æ –¥–µ–ª–∞–µ—à—å?",
            "–ü–ª–∞–Ω—ã –∫–∞–∫–∏–µ?",
            "–ß–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—à—å—Å—è?",
        ]
    }
    
    # ============ –§–†–ê–ó–´-–ó–ê–ü–û–õ–ù–ò–¢–ï–õ–ò ============
    
    FILLERS = {
        "thinking": ["–•–º...", "–≠–º...", "–ù—É...", "–¢–∏–ø–∞..."],
        "agreement": ["–ê–≥–∞", "–î–∞-–¥–∞", "–£–≥—É", "–¢–æ—á–Ω–æ"],
        "surprise": ["–í–∞—É", "–û–≥–æ", "–°–µ—Ä—å—ë–∑–Ω–æ?", "–ü—Ä–∞–≤–¥–∞?", "–ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å"],
        "laugh": ["–ê—Ö–∞—Ö", "–•–∞—Ö–∞", "–•–∞", "–õ–æ–ª", "üòÇ"],
        "cringe": ["–∞–∞–∞", "–æ–æ–æ–æ", "–±—Ä–æ", "—Ç–∏–ø–∞ —Ä–∏–ª", "–∫–∞–ø–µ—Ü"],  # üî• –ö–†–ò–ù–ñ
    }
    
    # ============ –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –°–í–Ø–ó–ö–ò ============
    
    CONNECTORS = {
        "continuation": ["–ö—Å—Ç–∞—Ç–∏,", "–ê –µ—â—ë,", "–ö —Å–ª–æ–≤—É,", "–í–æ–æ–±—â–µ,"],
        "change_topic": ["–ö—Å—Ç–∞—Ç–∏, –¥—Ä—É–≥–∞—è —Ç–µ–º–∞:", "–ê –∑–Ω–∞–µ—à—å —á—Ç–æ?", "–°–ª—É—à–∞–π,"],
        "return": ["–í–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ —Ç–µ–º–µ:", "–ö—Å—Ç–∞—Ç–∏ –¥–∞,"],
    }
    
    # ============ –≠–ú–û–î–ó–ò –ü–û –ö–û–ù–¢–ï–ö–°–¢–£ ============
    
    EMOJI_BY_MOOD = {
        "happy": ["üòä", "üòÑ", "üôÇ", "üòÅ", "ü§ó"],
        "excited": ["üî•", "‚ú®", "üí´", "üéâ", "‚ö°"],
        "thinking": ["ü§î", "üßê", "üí≠", "ü§®"],
        "support": ["üí™", "üëç", "üôå", "‚ù§Ô∏è"],
        "casual": [")", ")", ")", "üòé"],
        "cringe": ["ü¶ã", "‚ú®", "üíÄ", "ü•∫", "üò≠"],  # üî• –ö–†–ò–ù–ñ
    }
    
    # ============ –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–û–í ============
    
    def generate_greeting(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Å—Ç–∏–ª–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        greetings = self.GREETINGS.get(persona_style, self.GREETINGS["casual"])
        greeting = random.choice(greetings)
        
        # 30% —à–∞–Ω—Å –¥–æ–±–∞–≤–∏—Ç—å follow-up –≤–æ–ø—Ä–æ—Å
        if random.random() < 0.3:
            question = random.choice([
                "–ö–∞–∫ –¥–µ–ª–∞?",
                "–ß—Ç–æ –¥–µ–ª–∞–µ—à—å?",
                "–î–∞–≤–Ω–æ —Ç—É—Ç?",
                "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            ])
            greeting = f"{greeting} {question}"
        
        return greeting
    
    def generate_how_are_you(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ '–∫–∞–∫ –¥–µ–ª–∞?'"""
        category = random.choice(["positive", "neutral", "with_question"])
        responses = self.HOW_ARE_YOU[category]
        return random.choice(responses)
    
    def generate_support(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç"""
        category = random.choice(["empathy", "encourage", "offer_help"])
        responses = self.SUPPORT[category]
        response = random.choice(responses)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
        if persona_style in ["friendly", "emoji"]:
            emoji = random.choice(self.EMOJI_BY_MOOD["support"])
            response = f"{response} {emoji}"
        
        return response
    
    def generate_agreement(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ"""
        if persona_style == "brief":
            category = "casual"
        elif persona_style == "emoji":
            category = "emoji"
        else:
            category = random.choice(["strong", "casual"])
        
        return random.choice(self.AGREEMENT[category])
    
    def generate_question(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å"""
        category = random.choice(["about_person", "about_topic", "general"])
        return random.choice(self.QUESTIONS[category])
    
    def add_natural_elements(self, response, persona_style):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫ –æ—Ç–≤–µ—Ç—É"""
        # 20% —à–∞–Ω—Å –¥–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É-–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª–æ
        if random.random() < 0.2:
            filler_type = random.choice(["thinking", "agreement"])
            filler = random.choice(self.FILLERS[filler_type])
            response = f"{filler} {response.lower()}"
        
        # 15% —à–∞–Ω—Å –¥–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω–µ—Ü
        if persona_style == "emoji" and random.random() < 0.5:
            mood = random.choice(["happy", "excited", "casual"])
            emoji = random.choice(self.EMOJI_BY_MOOD[mood])
            response = f"{response} {emoji}"
        elif persona_style in ["friendly", "casual"] and random.random() < 0.15:
            mood = random.choice(["happy", "casual"])
            emoji = random.choice(self.EMOJI_BY_MOOD[mood])
            response = f"{response} {emoji}"
        
        return response
    
    def generate_contextual_response(self, message_text, persona_style, context=None):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        message_lower = message_text.lower()
        
        # –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        positive_words = ["—Å—É–ø–µ—Ä", "–æ—Ç–ª–∏—á–Ω–æ", "–∫—Ä—É—Ç–æ", "–∫–ª–∞—Å—Å", "–∫–∞–π—Ñ", "—Ç–æ–ø"]
        negative_words = ["–ø–ª–æ—Ö–æ", "–≥—Ä—É—Å—Ç–Ω–æ", "—Å–∫—É—á–Ω–æ", "—Ñ–∏–≥–Ω—è", "—Ö—É—ë–≤–æ"]
        question_words = ["–∫–∞–∫", "—á—Ç–æ", "–≥–¥–µ", "–∫–æ–≥–¥–∞", "–ø–æ—á–µ–º—É", "–∫—Ç–æ"]
        
        is_positive = any(word in message_lower for word in positive_words)
        is_negative = any(word in message_lower for word in negative_words)
        is_question = any(word in message_lower for word in question_words) or "?" in message_text
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        if is_negative:
            response = self.generate_support(persona_style)
        elif is_positive:
            response = self.generate_agreement(persona_style)
        elif is_question:
            # –ù–∞ –≤–æ–ø—Ä–æ—Å –æ—Ç–≤–µ—á–∞–µ–º –∏–ª–∏ –∑–∞–¥–∞—ë–º –≤—Å—Ç—Ä–µ—á–Ω—ã–π
            if random.random() < 0.6:
                response = self.generate_how_are_you(persona_style)
            else:
                response = self.generate_question(persona_style)
        else:
            # –û–±—â–∏–π –æ—Ç–≤–µ—Ç
            responses = [
                self.generate_greeting(persona_style),
                self.generate_agreement(persona_style),
                self.generate_question(persona_style),
            ]
            response = random.choice(responses)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        response = self.add_natural_elements(response, persona_style)
        
        return response
    
    def should_respond(self, message_text, user_id):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        message_lower = message_text.lower()
        
        # –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
        keywords = [
            "–ø—Ä–∏–≤–µ—Ç", "hello", "hi", "—Ö–∞–π", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "—Å–∞–ª—é—Ç",
            "–∫–∞–∫ –¥–µ–ª–∞", "—á—Ç–æ –¥–µ–ª–∞–µ—à—å", "–∫—Ç–æ —Ç—É—Ç", "–µ—Å—Ç—å –∫—Ç–æ",
            "–ø–æ–º–æ–≥–∏—Ç–µ", "help", "—Å–∫—É—á–Ω–æ"
        ]
        
        if any(keyword in message_lower for keyword in keywords):
            return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        history_count = self.conversation_history.get(user_id, 0)
        
        # –ï—Å–ª–∏ —É–∂–µ –æ–±—â–∞–ª–∏—Å—å, –±–æ–ª—å—à–µ —à–∞–Ω—Å –æ—Ç–≤–µ—Ç–∏—Ç—å
        if history_count > 0:
            return random.random() < 0.7  # 70% —à–∞–Ω—Å
        
        # –ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –º–µ–Ω—å—à–µ —à–∞–Ω—Å (–≤–æ–∑–º–æ–∂–Ω–æ —Å–ø–∞–º)
        if len(message_text) < 5:
            return random.random() < 0.2  # 20% —à–∞–Ω—Å
        
        # –ò–Ω–∞—á–µ —Å—Ä–µ–¥–Ω–∏–π —à–∞–Ω—Å
        return random.random() < 0.4  # 40% —à–∞–Ω—Å
    
    def update_conversation_history(self, user_id):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
        self.conversation_history[user_id] = self.conversation_history.get(user_id, 0) + 1
    
    def get_random_starter(self, persona_style):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        starters = [
            "–ö—Ç–æ-–Ω–∏–±—É–¥—å —Ç—É—Ç?",
            "–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!",
            "–ö–∞–∫ –¥–µ–ª–∞ —É –≤—Å–µ—Ö?",
            "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
            "–ù–∞—Ä–æ–¥ –µ—Å—Ç—å?",
            "–ö—Ç–æ –æ–Ω–ª–∞–π–Ω?",
            "–≠–π!",
            "–°–∫—É—á–Ω–æ...",
            "–ß–µ –¥–µ–ª–∞–µ—Ç–µ?",
            "–ü–æ–±–æ–ª—Ç–∞–µ–º?",
        ]
        
        starter = random.choice(starters)
        return self.add_natural_elements(starter, persona_style)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
response_generator = SmartResponseGenerator()
